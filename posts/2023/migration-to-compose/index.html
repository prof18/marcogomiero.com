<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Migrating to Jetpack Compose: a step by step journey - Marco Gomiero</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Some time ago, I decided to migrate Secure QR Reader to Jetpack Compose (in the rest of the article, I will call it Compose, for brevity). QR Reader Secure is a simple QR Reader that I developed some years ago after a failed search for a simple and secure reader for my parents that doesn&rsquo;t require sneaky, strange, and useless permissions.
The app was basic and fully working with the old View system, but I wanted to move to Compose to experience the entire migration process."><meta property="og:image" content><meta property="og:title" content="Migrating to Jetpack Compose: a step by step journey"><meta property="og:description" content="Some time ago, I decided to migrate Secure QR Reader to Jetpack Compose (in the rest of the article, I will call it Compose, for brevity). QR Reader Secure is a simple QR Reader that I developed some years ago after a failed search for a simple and secure reader for my parents that doesn&rsquo;t require sneaky, strange, and useless permissions.
The app was basic and fully working with the old View system, but I wanted to move to Compose to experience the entire migration process."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2023/migration-to-compose/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-12T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="Migrating to Jetpack Compose: a step by step journey"><meta name=twitter:description content="Some time ago, I decided to migrate Secure QR Reader to Jetpack Compose (in the rest of the article, I will call it Compose, for brevity). QR Reader Secure is a simple QR Reader that I developed some years ago after a failed search for a simple and secure reader for my parents that doesn&rsquo;t require sneaky, strange, and useless permissions.
The app was basic and fully working with the old View system, but I wanted to move to Compose to experience the entire migration process."><script src=https://www.marcogomiero.com/js/feather.min.js></script>
<link href="https://fonts.googleapis.com/css?family=JetBrains+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.marcogomiero.com/css/main.8fe5ace0a232e45b783ae12e0eef4deff9d16c430f2dddaa7c5e21f36da4cbba.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://www.marcogomiero.com/css/dark.2d1f13dc82ea2d94683809543a326af8a9a1f3a6c000f7b7af5d8f02a2e6ec25.css disabled></head><body><div class=content><header><div class=main><a href=https://www.marcogomiero.com><h2>Marco Gomiero</h2></a></div><nav class=navbar><a href=/posts/><span>Write</span></a>
<a href=/talks/><span>Speak</span></a>
<a href=/projects/><span>Build</span></a>
<a href=/about-me/><span>About</span></a>
| <span class=dark-mode-toggle id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://www.marcogomiero.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Migrating to Jetpack Compose: a step by step journey</h1><div class=post-meta><span title='2023-05-12 00:00:00 +0000 UTC'>12 May 2023</span></div></div><section class=body><span class=raw-html><div class=post-award-container><a href=https://androidweekly.net/issues/issue-569><img src=https://androidweekly.net/issues/issue-569/badge></a>
<a href=https://jetc.dev/issues/165.html><img src="https://img.shields.io/badge/As_Seen_In-jetc.dev_Newsletter_Issue_%23165-blue?logo=Jetpack+Compose&logoColor=white"></a></div></span><p>Some time ago, I decided to migrate <a href=https://github.com/prof18/Secure-QR-Reader>Secure QR Reader</a> to Jetpack Compose (in the rest of the article, I will call it Compose, for brevity). QR Reader Secure is a simple QR Reader that I developed some years ago after a failed search for a simple and secure reader for my parents that doesn&rsquo;t require sneaky, strange, and useless permissions.</p><p>The app was basic and fully working with the old View system, but I wanted to move to Compose to experience the entire migration process.</p><p>This article will be a journal that describes the journey to Compose step by step. There will be a correspondent commit for each step, so keeping track of the changes will be possible. This way, I want to be helpful to all the people that want to start the migration.</p><blockquote><p>Note: The migration happened about a year ago, so the dependencies are not entirely up to date, and some APIs could have changed in the meantime. The article&rsquo;s point is not to show how you can do things in detail but rather to give the idea of the approach that can be followed to migrate to Compose.</p></blockquote><h2 id=gradle-setup>Gradle Setup</h2><p>In every significant migration, there will always be some Gradle work involved. First, it is necessary to enable the Compose feature and set the Compose Compiler Kotlin version in the <code>build.gradle(.kts)</code> file.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>android {
</span></span><span style=display:flex><span>    buildFeatures {
</span></span><span style=display:flex><span>        compose = <span style=color:#ff6ac1>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    composeOptions {
</span></span><span style=display:flex><span>        kotlinCompilerExtensionVersion = <span style=color:#5af78e>&#34;&lt;compiler-version&gt;&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The Compose Compiler version is tied to the Kotlin version. A compatibility map to help with the choice can be found <a href=https://developer.android.com/jetpack/androidx/releases/compose-kotlin>in the documentation</a>.</p><p>The next step is adding some dependencies, depending on the application&rsquo;s needs. The Compose team recently introduced <a href=https://developer.android.com/jetpack/compose/setup#using-the-bom>the Compose BOM</a> (Bill of Materials) that links together the stable version of all the different Compose libraries. In this way, it&rsquo;s only necessary to specify the BOM version, and the correct library&rsquo;s version will be pulled.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> composeBom = platform(<span style=color:#5af78e>&#34;androidx.compose:compose-bom:</span><span style=color:#5af78e>$bom</span><span style=color:#5af78e>_version&#34;</span>)
</span></span><span style=display:flex><span>    implementation composeBom
</span></span><span style=display:flex><span>    androidTestImplementation composeBom
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Choose one of the following:
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>// Material Design 3
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.material3:material3&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// or Material Design 2
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.material:material&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// or skip Material Design and build directly on top of foundational components
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.foundation:foundation&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// or only import the main APIs for the underlying toolkit systems,
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>// such as input and measurement/layout
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.ui:ui&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Android Studio Preview support
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.ui:ui-tooling-preview&#34;</span>)
</span></span><span style=display:flex><span>    debugImplementation(<span style=color:#5af78e>&#34;androidx.compose.ui:ui-tooling&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// UI Tests
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    androidTestImplementation(<span style=color:#5af78e>&#34;androidx.compose.ui:ui-test-junit4&#34;</span>)
</span></span><span style=display:flex><span>    debugImplementation(<span style=color:#5af78e>&#34;androidx.compose.ui:ui-test-manifest&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Included automatically by material, only add when you need
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>// the icons but not the material library (e.g. when using Material3 or a
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>// custom design system based on Foundation)
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.material:material-icons-core&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Add full set of material icons
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.material:material-icons-extended&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Add window size utils
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.material3:material3-window-size-class&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Integration with activities
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.activity:activity-compose:1.5.1&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Integration with ViewModels
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.lifecycle:lifecycle-viewmodel-compose:2.5.1&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Integration with LiveData
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.runtime:runtime-livedata&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Optional - Integration with RxJava
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    implementation(<span style=color:#5af78e>&#34;androidx.compose.runtime:runtime-rxjava2&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>From <a href=https://developer.android.com/jetpack/compose/setup#kotlin_1>https://developer.android.com/jetpack/compose/setup#kotlin_1</a></p></blockquote><p>After this setup, Jetpack Compose is ready to be used.</p><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/078e22a6bbfbb2546f24fbea700213bf0d80decf>Commit: &ldquo;Move to gradle kts. Start integrating Gradle Version Catalog&rdquo;</a></p></blockquote><p><em>N.B. The above commit was done before the introduction of the BOM.</em></p><h2 id=reuse-existing-theme-with-material-theme-adapter>Reuse existing Theme with Material Theme Adapter</h2><p>An existing application already has one or more themes defined in XML. With Compose instead, the theme definition is done with Kotlin code.</p><p>Rewriting the entire theming in Compose before moving on with the migration will be time-consuming and slow things down. Furthermore, since a theme is already defined, it would be amazing to have a bridge between the two worlds and postpone the theme migration.
And here comes the <a href=https://google.github.io/accompanist/themeadapter-material/>Material Theme Adapter</a>.</p><p>After importing the library into the project</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>    implementation <span style=color:#5af78e>&#34;com.google.accompanist:accompanist-themeadapter-material:&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>a new Material Theme called <code>MdcTheme</code> will be created.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>MdcTheme {
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span></code></pre></div><p>The theme adapter will only work if the Activity/Context theme extends a Theme.MaterialComponents theme, and it will automatically infer colors, typography, and shapes.</p><p>For example, all the items defined in the following theme</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff6ac1>&lt;resources&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>&lt;!-- Base application theme. --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>&lt;style</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;AppTheme&#34;</span> <span style=color:#57c7ff>parent=</span><span style=color:#5af78e>&#34;Theme.MaterialComponents.DayNight.NoActionBar&#34;</span><span style=color:#ff6ac1>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>&lt;!-- Customize your theme here. --&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;colorPrimary&#34;</span><span style=color:#ff6ac1>&gt;</span>@color/colorPrimary<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;colorPrimaryVariant&#34;</span><span style=color:#ff6ac1>&gt;</span>@color/colorPrimaryVariant<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;textAppearanceButton&#34;</span><span style=color:#ff6ac1>&gt;</span>@style/TextAppearance.SecureQRReader.Button<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;shapeAppearanceSmallComponent&#34;</span><span style=color:#ff6ac1>&gt;</span>@style/AppShapeAppearance.SmallComponent<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>&lt;/style&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>&lt;style</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;TextAppearance.SecureQRReader.Button&#34;</span> <span style=color:#57c7ff>parent=</span><span style=color:#5af78e>&#34;TextAppearance.MaterialComponents.Body1&#34;</span><span style=color:#ff6ac1>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;fontFamily&#34;</span><span style=color:#ff6ac1>&gt;</span>@font/poppins_regular<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;android:textSize&#34;</span><span style=color:#ff6ac1>&gt;</span>16sp<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>&lt;/style&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>&lt;style</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;AppShapeAppearance.SmallComponent&#34;</span> <span style=color:#57c7ff>parent=</span><span style=color:#5af78e>&#34;ShapeAppearance.MaterialComponents.SmallComponent&#34;</span><span style=color:#ff6ac1>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;cornerSize&#34;</span><span style=color:#ff6ac1>&gt;</span>@dimen/card_corner_radius<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>&lt;item</span> <span style=color:#57c7ff>name=</span><span style=color:#5af78e>&#34;cornerFamily&#34;</span><span style=color:#ff6ac1>&gt;</span>rounded<span style=color:#ff6ac1>&lt;/item&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>&lt;/style&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>&lt;/resources&gt;</span>
</span></span></code></pre></div><p>can be retrieved from <code>MaterialTheme.colors</code>, <code>MaterialTheme.typography</code>, and <code>MaterialTheme.shapes</code> after applying the <code>MdcTheme</code> theme.</p><p>This way, the migration to Compose can start without having to worry about the theme and without the need to duplicate theme definitions. Theming can be migrated in a later stage after all the other screens.</p><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/b9ce72efb497313215ab7e871e51b52d56ab940b>Commit: &ldquo;Migrate WelcomeActivity to compose&rdquo;</a></p></blockquote><p><em>N.B. The above commit uses an old version of the material theme adapter artifacts. Now these libraries are deprecated in favor of the new Accompanist Theme Adapter artifacts. More details are available in the <a href=https://github.com/material-components/material-components-android-compose-theme-adapter#migration>migration guide</a>.</em></p><h2 id=migrate-to-compose-while-keeping-activity-and-fragments>Migrate to Compose while keeping Activity and Fragments</h2><p>After some housekeeping work, it&rsquo;s finally time to write some Composables.</p><p>Jetpack Compose is fully interoperable with the View system, and the degree of migration can be decided depending on the project. Furthermore, it is possible to choose what to write with Compose: a full app, the content of one Fragment, or an UI element. That is made possible by the <a href=https://developer.android.com/jetpack/compose/interop/interop-apis>Interoperability APIs</a>.</p><p>This is quite handy, especially in large projects, because it enables the migration without touching the existing architecture and navigation system. With <code>ComposeView</code>, for example, it will be possible to keep a current Fragment and replace the UI definition from the XML with a composable function.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ResultFragment</span> : Fragment() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>override</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>onCreateView</span>(
</span></span><span style=display:flex><span>        inflater: LayoutInflater,
</span></span><span style=display:flex><span>        container: ViewGroup?,
</span></span><span style=display:flex><span>        savedInstanceState: Bundle?,
</span></span><span style=display:flex><span>    ): View {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> qrResult: String? = arguments<span style=color:#ff6ac1>?.</span>getString(QR_RESULT)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> ComposeView(requireContext()).apply {
</span></span><span style=display:flex><span>            setViewCompositionStrategy(ViewCompositionStrategy.DisposeOnViewTreeLifecycleDestroyed)
</span></span><span style=display:flex><span>            setContent {
</span></span><span style=display:flex><span>                MdcTheme {
</span></span><span style=display:flex><span>                    ResultScreen(
</span></span><span style=display:flex><span>                        scanResult = qrResult,
</span></span><span style=display:flex><span>                        isUrl = isUrl(qrResult),
</span></span><span style=display:flex><span>                        onOpenButtonClick = { openUrl(qrResult) },
</span></span><span style=display:flex><span>                        onCopyButtonClick = { copyToClipboard(qrResult) },
</span></span><span style=display:flex><span>                        onShareButtonClick = { shareResult(qrResult) },
</span></span><span style=display:flex><span>                        onScanAnotherButtonClick = { performAnotherScan() }
</span></span><span style=display:flex><span>                    )
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff9f43>@Composable</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>ResultScreen</span>(
</span></span><span style=display:flex><span>    scanResult: String? = <span style=color:#ff6ac1>null</span>,
</span></span><span style=display:flex><span>    isUrl: Boolean = <span style=color:#ff6ac1>false</span>,
</span></span><span style=display:flex><span>    onOpenButtonClick: () <span style=color:#ff6ac1>-&gt;</span> Unit = {},
</span></span><span style=display:flex><span>    onCopyButtonClick: () <span style=color:#ff6ac1>-&gt;</span> Unit = {},
</span></span><span style=display:flex><span>    onShareButtonClick: () <span style=color:#ff6ac1>-&gt;</span> Unit = {},
</span></span><span style=display:flex><span>    onScanAnotherButtonClick: () <span style=color:#ff6ac1>-&gt;</span> Unit = {},
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span></code></pre></div><p>This way, the migration will be gradual and faster, not with a big-bang approach.</p><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/bcfbc08478b390f55ac508106931eb0bc034a0b4>Commit: &ldquo;Migrate AboutActivity to compose&rdquo;</a></p></blockquote><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/ef7477e3faa3ef826ca055d9beea5bddea75c97e>Commit: &ldquo;Migrate ResultFragment to compose&rdquo;</a></p></blockquote><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/be12fd5d23610fea38be0d8ab0143c902afe297c>Commit: &ldquo;Migrate ScanFragment to compose&rdquo;</a></p></blockquote><h2 id=create-a-compose-theme>Create a Compose Theme</h2><p>After migrating every screen to Compose, the next steps are focused on making the app &ldquo;more Compose&rdquo;. The first thing that can be addressed is creating a Compose theme. This way, the XML themes definitions can be deleted.</p><p>Compose makes it easy to implement <a href=https://developer.android.com/jetpack/compose/designsystems/material3>Material 3</a> and <a href=https://developer.android.com/jetpack/compose/designsystems/material>Material 2</a> themes.</p><p>For this application, I&rsquo;m using Material 2. While defining a theme, it&rsquo;s possible to customize colors, shapes, and typography.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>internal</span> <span style=color:#ff6ac1>object</span> <span style=color:#f3f99d>LightAppColors</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> primary = Color(<span style=color:#ff9f43>0XFF1565c0</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> primaryVariant = Color(<span style=color:#ff9f43>0xFF3700B3</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>internal</span> <span style=color:#ff6ac1>object</span> <span style=color:#f3f99d>DarkAppColors</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> primary = Color(<span style=color:#ff9f43>0XFF102a43</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> primaryVariant = Color(<span style=color:#ff9f43>0xFF3700B3</span>)
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>internal</span> <span style=color:#ff6ac1>val</span> SecureQrReaderShapes = Shapes(
</span></span><span style=display:flex><span>    small = RoundedCornerShape(<span style=color:#ff9f43>16.</span>dp),
</span></span><span style=display:flex><span>    medium = RoundedCornerShape(<span style=color:#ff9f43>16.</span>dp),
</span></span><span style=display:flex><span>    large = RoundedCornerShape(<span style=color:#ff9f43>16.</span>dp)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>internal</span> <span style=color:#ff6ac1>val</span> LightThemeColors = lightColors(
</span></span><span style=display:flex><span>    primary = LightAppColors.primary,
</span></span><span style=display:flex><span>    primaryVariant = LightAppColors.primaryVariant,
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>internal</span> <span style=color:#ff6ac1>val</span> DarkThemeColors = darkColors(
</span></span><span style=display:flex><span>    primary = DarkAppColors.primary,
</span></span><span style=display:flex><span>    primaryVariant = DarkAppColors.primaryVariant,
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>)
</span></span></code></pre></div><p>Those customizations will be injected into the definition of the theme.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>Composable
</span></span><span style=display:flex><span><span style=color:#ff6ac1>internal</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>SecureQrReaderTheme</span>(
</span></span><span style=display:flex><span>    darkTheme: Boolean = isSystemInDarkTheme(),
</span></span><span style=display:flex><span>    content: <span style=color:#ff9f43>@Composable</span> () <span style=color:#ff6ac1>-&gt;</span> Unit,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>    MaterialTheme(
</span></span><span style=display:flex><span>        colors = <span style=color:#ff6ac1>if</span> (darkTheme) DarkThemeColors <span style=color:#ff6ac1>else</span> LightThemeColors,
</span></span><span style=display:flex><span>        typography = SecureQrReaderTypography,
</span></span><span style=display:flex><span>        shapes = SecureQrReaderShapes,
</span></span><span style=display:flex><span>        content = content
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At this point, the <code>Material Theme Adapter</code> can be removed</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>-    implementation <span style=color:#5af78e>&#34;com.google.accompanist:accompanist-themeadapter-material:&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and the <code>MdcTheme</code> can be replaced with <code>SecureQrReaderTheme</code></p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>AboutScreen</span>() {
</span></span><span style=display:flex><span>-   MdcTheme {
</span></span><span style=display:flex><span>+   SecureQrReaderTheme {
</span></span><span style=display:flex><span>        <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    }
</span></span><span style=display:flex><span>}    
</span></span></code></pre></div><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/ff1b3db643d8fdd4d1a1a84b4c0fac542717effd>Commit: &ldquo;Migrate to compose theme&rdquo;</a></p></blockquote><h2 id=all-in-with-compose>All-in with Compose</h2><p>At this point, it&rsquo;s time to go full Compose. I decided to go forward with the migration to try the entire experience, but having a &ldquo;mixed&rdquo; application would be fine, especially for really complex existing applications.</p><h3 id=goodbye-activities-and-fragments>Goodbye Activities and Fragments</h3><p>The first step is deleting all the Activities and Fragments and use Jetpack Navigation for Compose. To use Jetpack Navigation in Compose, it is necessary to add the dependency:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#5af78e>&#34;androidx.navigation:navigation-compose:&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>Next, a <code>NavHost</code>, that will contain all the different Composable functions that the app requires, can be defined.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>MainActivity</span> : ComponentActivity() {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>override</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        setContent {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>val</span> navController = rememberNavController()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            NavHost(
</span></span><span style=display:flex><span>                navController = navController, 
</span></span><span style=display:flex><span>                startDestination = Screen.Splash.name
</span></span><span style=display:flex><span>            ) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                composable(Screen.Splash.name) {
</span></span><span style=display:flex><span>                    SplashScreen()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                composable(Screen.WelcomeScreen.name) {
</span></span><span style=display:flex><span>                    WelcomeScreen()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                composable(Screen.ScanScreen.name) {
</span></span><span style=display:flex><span>                    ScanScreen()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                composable(Screen.ResultScreen.name) {
</span></span><span style=display:flex><span>                    ResultScreen()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                composable(Screen.AboutScreen.name) {
</span></span><span style=display:flex><span>                    AboutScreen()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>NavHost</code> is placed in the <code>MainActivity</code>, the only Activity that will be kept with the new Compose-only app setup.</p><p>For more information about Navigation in Compose, you can look <a href=https://developer.android.com/jetpack/compose/navigation>at the official documentation</a>.</p><h3 id=handling-permissions>Handling Permissions</h3><p>To easily manage <a href=https://developer.android.com/guide/topics/permissions/overview>Android Runtime Permissions</a> on Compose, there is an Accompanist library called <a href=https://google.github.io/accompanist/permissions/>Jetpack Compose Permissions</a>.</p><p><a href=https://google.github.io/accompanist/>Accompanist</a> is a group of libraries provided by Google to help with commonly required features not yet available in Jetpack Compose, for example, permissions, system UI controllers, navigation animation, etc.</p><p>As usual, it is first necessary to import the library artifact:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#5af78e>&#34;com.google.accompanist:accompanist-permissions:&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>After that, it is possible to define a state with the requested permission, launch the permission request, and build a UI depending on the permission state. The <code>rememberPermissionState</code> will ensure that the status of the permission will be kept across different recompositions.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> cameraPermissionState = rememberPermissionState(
</span></span><span style=display:flex><span>    android.Manifest.permission.CAMERA
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LaunchedEffect(Unit) {
</span></span><span style=display:flex><span>    cameraPermissionState.launchPermissionRequest()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>when</span>(cameraPermissionState.status) {
</span></span><span style=display:flex><span>    PermissionStatus.Granted <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>is</span> PermissionStatus.Denied <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/4692b50b6e8248ebd8e3af860b25e70045cb8f8e>Commit: &ldquo;Go full compose&rdquo;</a></p></blockquote><h3 id=status-bar-color-handling>Status Bar color handling</h3><p>To delete more XML theming, I used <a href=https://google.github.io/accompanist/systemuicontroller/>System UI Controller for Jetpack Compose</a> from Accompanist. The library provides some utilities for updating the System UI bar colors directly from Compose. As usual, it is first necessary to import the library:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#5af78e>&#34;com.google.accompanist:accompanist-systemuicontroller:&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>The status bar and icon colors can then be modified with the <code>setStatusBarColor</code> function:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> systemUiController = rememberSystemUiController()
</span></span><span style=display:flex><span><span style=color:#ff6ac1>val</span> minLuminanceForDarkIcons = .<span style=color:#ff9f43>5f</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SideEffect {
</span></span><span style=display:flex><span>    systemUiController.setStatusBarColor(
</span></span><span style=display:flex><span>        color = actualBackgroundColor,
</span></span><span style=display:flex><span>        darkIcons = actualBackgroundColor.luminance() &gt; minLuminanceForDarkIcons
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/20e22ecd4539375cd025f28c3f95f37b51d32808>Commit: &ldquo;Use accompanist system ui controller to change status bar color&rdquo;</a></p></blockquote><h3 id=navigation-animations>Navigation Animations</h3><p>To have a better user experience, I decided to add some transitions between different screens. To do that, Accompanist comes to the rescue again, with the <a href=https://google.github.io/accompanist/navigation-animation/>Jetpack Navigation Compose Animation</a> library.</p><p>After adding the dependency:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>dependencies <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    implementation <span style=color:#5af78e>&#34;com.google.accompanist:accompanist-navigation-animation:&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>the <code>navController</code> and the <code>NavHost</code> must be replaced with <code>animatedNavController</code> and <code>AnimatedNavHost</code>. The <code>AnimatedNavHost</code> enhance the regular <code>NavHost</code> with some parameters to customize all the transitions.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> navController = rememberAnimatedNavController()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AnimatedNavHost(
</span></span><span style=display:flex><span>    navController = navController,
</span></span><span style=display:flex><span>    startDestination = Screen.Splash.name,
</span></span><span style=display:flex><span>    enterTransition = { fadeIn() + slideIntoContainer(AnimatedContentScope.SlideDirection.Start) },
</span></span><span style=display:flex><span>    exitTransition = { fadeOut() + slideOutOfContainer(AnimatedContentScope.SlideDirection.Start) },
</span></span><span style=display:flex><span>    popEnterTransition = { fadeIn() + slideIntoContainer(AnimatedContentScope.SlideDirection.End) },
</span></span><span style=display:flex><span>    popExitTransition = { fadeOut() + slideOutOfContainer(AnimatedContentScope.SlideDirection.End) }
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}    
</span></span></code></pre></div><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/28628dd051f572f454c68aedbef62590391336a3>Commit: &ldquo;Move to Animated Nav Host&rdquo;</a></p></blockquote><h2 id=landscape-support>Landscape Support</h2><p>The final step in this migration journey is adding support for the landscape orientation. I guilty <del>skipped</del> YOLOed this step during the app&rsquo;s first iteration because it was too painful to support. But with Compose, it&rsquo;s not necessary to have different XMLs but only to check the current configuration and return a specific Composable function.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> configuration = LocalConfiguration.current
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>when</span> (configuration.orientation) {
</span></span><span style=display:flex><span>    Configuration.ORIENTATION_LANDSCAPE <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>        LandscapeView(showOnGithubClicked, licensesClicked, nameClicked)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>else</span> <span style=color:#ff6ac1>-&gt;</span> {
</span></span><span style=display:flex><span>        PortraitView(showOnGithubClicked, licensesClicked, nameClicked)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p><a href=https://github.com/prof18/Secure-QR-Reader/commit/2a44136000730a8cba32ef6d91f3b88572433fb8>Commit:" Add horizontal orientation support"</a></p></blockquote><h2 id=conclusions>Conclusions</h2><p>And that was the journey of migrating Secure QR Reader to Jetpack Compose.</p><p>The main takeaway of this journey is that Compose can be iteratively introduced in an application without a big-bang approach. It&rsquo;s possible to migrate only a little UI element, an entire screen, or the whole application. The process can be done step by step as I did for my app, and it&rsquo;s even possible to stop in the middle of the process and keep having a fully functioning app.</p><p>I hope that this article will be helpful for all the developers embarking on their own migration journey to Jetpack Compose. You can check out Secure QR Reader on <a href=https://github.com/prof18/Secure-QR-Reader>Github</a> or download it from the <a href="https://play.google.com/store/apps/details?id=com.prof18.secureqrreader">Play Store</a>.</p></section><div class=article-footer><div class=body>To stay up to date with my writing and my projects, follow me on <a href=https://androiddev.social/@marcogom target=_blank>Mastodon</a> or <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-69FZ1TLE7E","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>