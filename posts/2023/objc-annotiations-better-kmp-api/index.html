<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Using annotations to improve iOS APIs on Kotlin Multiplatform - Marco Gomiero</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kotlin 1.8 has introduced new annotations to improve the interoperability of Kotlin with Objective-C and Swift:
@ObjCName: allows to customize the name that will be used in Swift or Objective-C @HiddenFromObjC: allows hiding a Kotlin declaration from Objective-C (and Swift). @ShouldRefineInSwift: it marks a Kotlin declaration as swift_private in the Objective-C API, allowing to replace it with a wrapper written in Swift. You can see the release announcement for more details about the interoperability improvements introduced with Kotlin 1."><meta property="og:image" content><meta name=google-site-verification content="7rDTNqn214SsZ9mmV8Ps5v2vqy8aXFWyoq08udChYCs"><meta property="og:title" content="Using annotations to improve iOS APIs on Kotlin Multiplatform"><meta property="og:description" content="Kotlin 1.8 has introduced new annotations to improve the interoperability of Kotlin with Objective-C and Swift:
@ObjCName: allows to customize the name that will be used in Swift or Objective-C @HiddenFromObjC: allows hiding a Kotlin declaration from Objective-C (and Swift). @ShouldRefineInSwift: it marks a Kotlin declaration as swift_private in the Objective-C API, allowing to replace it with a wrapper written in Swift. You can see the release announcement for more details about the interoperability improvements introduced with Kotlin 1."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2023/objc-annotiations-better-kmp-api/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-19T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-19T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using annotations to improve iOS APIs on Kotlin Multiplatform"><meta name=twitter:description content="Kotlin 1.8 has introduced new annotations to improve the interoperability of Kotlin with Objective-C and Swift:
@ObjCName: allows to customize the name that will be used in Swift or Objective-C @HiddenFromObjC: allows hiding a Kotlin declaration from Objective-C (and Swift). @ShouldRefineInSwift: it marks a Kotlin declaration as swift_private in the Objective-C API, allowing to replace it with a wrapper written in Swift. You can see the release announcement for more details about the interoperability improvements introduced with Kotlin 1."><script async src="https://www.googletagmanager.com/gtag/js?id=G-69FZ1TLE7E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-69FZ1TLE7E",{anonymize_ip:!1})}</script><script src=https://www.marcogomiero.com/js/feather.min.js></script>
<link href="https://fonts.googleapis.com/css?family=JetBrains+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.marcogomiero.com/css/main.f2c7f60ec2d0155a784ade9b1b272143e1b8eb864a95bf75e606b49d8774389e.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://www.marcogomiero.com/css/dark.26c5bf79ef760a8f4feb8fc7be32ec86fc1f1da292b42c9fcc37879d4f774e3f.css disabled></head><body><div class=content><header><div class=main><a href=https://www.marcogomiero.com><h2>Marco Gomiero</h2></a></div><nav class=navbar><a href=/posts/><span>Write</span></a>
<a href=/talks/><span>Speak</span></a>
<a href=/projects/><span>Build</span></a>
<a href=/about-me/><span>About</span></a>
| <span class=dark-mode-toggle id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://www.marcogomiero.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Using annotations to improve iOS APIs on Kotlin Multiplatform</h1><div class=post-meta><span title='2023-09-19 00:00:00 +0000 UTC'>19 September 2023</span></div></div><section class=body><p>Kotlin 1.8 has introduced new annotations to improve the interoperability of Kotlin with Objective-C and Swift:</p><ul><li><code>@ObjCName</code>: allows to customize the name that will be used in Swift or Objective-C</li><li><code>@HiddenFromObjC</code>: allows hiding a Kotlin declaration from Objective-C (and Swift).</li><li><code>@ShouldRefineInSwift</code>: it marks a Kotlin declaration as <code>swift_private</code> in the Objective-C API, allowing to replace it with a wrapper written in Swift.</li></ul><p>You can see the <a href=https://kotlinlang.org/docs/whatsnew18.html#improved-objective-c-swift-interoperability>release announcement</a> for more details about the interoperability improvements introduced with Kotlin 1.8.</p><p>In this article, I will cover how I used the <code>@HiddenFromObjC</code> and <code>@ObjCName</code> annotations to improve the architecture of <a href=https://github.com/prof18/MoneyFlow>MoneyFlow</a>, a pet project to manage personal finances that I started a couple of years ago and that became a personal playground for a Kotlin Multiplatform mobile app.</p><h2 id=moneyflow-architecture>MoneyFlow architecture</h2><p>MoneyFlow uses an MVVM architecture with native ViewModels and a “shared middleware actor”, the UseCase, that prepares and serves the data for the UI. For every UseCase, there is an iOS-specific implementation placed in the <code>iOSMain</code> source set that receives in the constructor a reference of the shared UseCase and re-exposes the methods.</p><p>For example, the <code>HomeUseCase</code> will have an iOS-specific implementation called <code>HomeUseCaseIos</code>.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>HomeUseCase</span>(
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> moneyRepository: MoneyRepository,
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> errorMapper: MoneyFlowErrorMapper,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>observeHomeModel</span>(): Flow&lt;HomeModel&gt; =
</span></span><span style=display:flex><span>        moneyRepository.getMoneySummary().map {
</span></span><span style=display:flex><span>            HomeModel.HomeState(
</span></span><span style=display:flex><span>                balanceRecap = <span style=color:#ff6ac1>it</span>.balanceRecap,
</span></span><span style=display:flex><span>                latestTransactions = <span style=color:#ff6ac1>it</span>.latestTransactions
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>suspend</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>deleteTransaction</span>(transactionId: Long): MoneyFlowResult&lt;Unit&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>try</span> {
</span></span><span style=display:flex><span>            moneyRepository.deleteTransaction(transactionId)
</span></span><span style=display:flex><span>            MoneyFlowResult.Success(Unit)
</span></span><span style=display:flex><span>        } <span style=color:#ff6ac1>catch</span> (throwable: Throwable) {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>val</span> error = MoneyFlowError.DeleteTransaction(throwable)
</span></span><span style=display:flex><span>            throwable.logError(error)
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>val</span> errorMessage = errorMapper.getUIErrorMessage(error)
</span></span><span style=display:flex><span>            MoneyFlowResult.Error(errorMessage)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>HomeUseCaseIos</span>(
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> homeUseCase: HomeUseCase
</span></span><span style=display:flex><span>) : BaseUseCaseIos() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>getMoneySummary</span>(): FlowWrapper&lt;HomeModel&gt; =
</span></span><span style=display:flex><span>        FlowWrapper(scope, homeUseCase.observeHomeModel())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>deleteTransaction</span>(transactionId: Long, onError: (UIErrorMessage) <span style=color:#ff6ac1>-&gt;</span> Unit) {
</span></span><span style=display:flex><span>        scope.launch {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>val</span> result = homeUseCase.deleteTransaction(transactionId)
</span></span><span style=display:flex><span>            result.doOnError { onError(<span style=color:#ff6ac1>it</span>) }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This approach introduces some code duplication, but I think that it’s a good compromise to bridge the gap between different platforms (to handle Flows and Coroutine cancellation). With this solution, the majority of the business logic is shared, and a “slim” ViewModel will be used to fulfill different needs of different platforms.</p><p>For more details about this architecture, you can look at the following articles that I wrote:</p><blockquote><p><a href=https://www.marcogomiero.com/posts/2022/improved-kmm-shared-app-arch/>Improving shared architecture for a Kotlin Multiplatform, Jetpack Compose and SwiftUI app</a></p></blockquote><blockquote><p><a href=https://www.marcogomiero.com/posts/2020/kmm-shared-app-architecture/>Choosing the right architecture for a [new] Kotlin Multiplatform, Jetpack Compose and SwiftUI app</a></p></blockquote><p>An alternative approach would be using <a href=https://github.com/rickclephas/KMP-NativeCoroutines>KMP-NativeCoroutines</a> or <a href=https://github.com/touchlab/SKIE>SKIE</a>, two libraries that improve Kotlin interoperability with iOS. But for this project, I started with this approach, and I will keep that to experience the difference.</p><p>However, having two classes with very similar names (<code>HomeUseCase</code> and <code>HomeUseCaseIos</code>) can be misleading and will increase the binary size of the exported Objective-C framework.</p><h2 id=hiddenfromobjc-and-objcname-usage>@HiddenFromObjC and @ObjCName usage</h2><p>As mentioned above, the <code>HiddenFromObjC</code> annotation prevents certain Kotlin declarations from being exported to Objective-C and Swift. The <code>ObjCName</code> annotation instead can be used to change the name of the Kotlin declaration that will be exported to Objective-C and Swift.</p><p>Those two annotations can be combined to export to the iOS application only the iOS-specific implementation of the UseCase while keeping the same name.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff9f43>@HiddenFromObjC</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>HomeUseCase</span>(
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> moneyRepository: MoneyRepository,
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> errorMapper: MoneyFlowErrorMapper,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff9f43>@ObjCName</span>(<span style=color:#5af78e>&#34;HomeUseCase&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>HomeUseCaseIos</span>(
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> homeUseCase: HomeUseCase,
</span></span><span style=display:flex><span>) : BaseUseCaseIos() {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This way, the iOS application will be completely transparent about the different implementations of the UseCase.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#ff5c57>class</span> <span style=color:#f3f99d>HomeViewModel</span>: ObservableObject {    
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>func</span> <span style=color:#57c7ff>homeUseCase</span>() -&gt; HomeUseCase {
</span></span><span style=display:flex><span>        DI.getHomeUseCase()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>func</span> <span style=color:#57c7ff>deleteTransaction</span>(transactionId: <span style=color:#ff5c57>Int64</span>) {
</span></span><span style=display:flex><span>        homeUseCase().deleteTransaction(
</span></span><span style=display:flex><span>            transactionId: transactionId,
</span></span><span style=display:flex><span>            onError: { error <span style=color:#ff6ac1>in</span>
</span></span><span style=display:flex><span>                <span style=color:#ff6ac1>self</span>.snackbarData = error.toSnackbarData()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that’s all. The usage of those annotations is helping to create a cleaner API and export only the necessary components in the iOS framework, contributing to less complexity and reduced binary size.</p><p>You can find the code mentioned in the article on <a href=https://github.com/prof18/MoneyFlow>GitHub</a>.</p></section><div class=article-footer><div class=body>To stay up to date with my writing and my projects, follow me on <a href=https://androiddev.social/@marcogom target=_blank>Mastodon</a> or <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-69FZ1TLE7E","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>