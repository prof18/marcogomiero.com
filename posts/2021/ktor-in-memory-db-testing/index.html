<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>How to use an in-memory database for testing on Ktor - Marco Gomiero</title><meta name=Description content="Software Engineer · Google Developer Expert for Kotlin"><meta property="og:title" content="How to use an in-memory database for testing on Ktor"><meta property="og:description" content="SERIES: Building a backend with Ktor   Part 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor     Usually, in a backend project, there are different instances of the same database: one for production (or more than one, it depends on the architecture), one for staging, and a local one that runs in the development machine."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-04T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-04T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to use an in-memory database for testing on Ktor"><meta name=twitter:description content="SERIES: Building a backend with Ktor   Part 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor     Usually, in a backend project, there are different instances of the same database: one for production (or more than one, it depends on the architecture), one for staging, and a local one that runs in the development machine."><meta name=application-name content="Marco Gomiero"><meta name=apple-mobile-web-app-title content="Marco Gomiero"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/><link rel=prev href=https://www.marcogomiero.com/posts/2021/kmp-xcframework-official-support/><link rel=next href=https://www.marcogomiero.com/posts/2021/kmp-no-java-runtime-error-xcode/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><meta name=google-site-verification content="7rDTNqn214SsZ9mmV8Ps5v2vqy8aXFWyoq08udChYCs"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"How to use an in-memory database for testing on Ktor","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.marcogomiero.com\/posts\/2021\/ktor-in-memory-db-testing\/"},"image":["https:\/\/www.marcogomiero.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":2062,"url":"https:\/\/www.marcogomiero.com\/posts\/2021\/ktor-in-memory-db-testing\/","datePublished":"2021-10-04T00:00:00+00:00","dateModified":"2021-10-04T00:00:00+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Marco Gomiero"},"author":{"@type":"Person","name":"Marco Gomiero"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Marco Gomiero">Marco Gomiero</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts>Posts </a><a class=menu-item href=/talks>Talks </a><a class=menu-item href=/projects>Projects </a><a class=menu-item href=/about-me>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Marco Gomiero">Marco Gomiero</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts title>Posts</a><a class=menu-item href=/talks title>Talks</a><a class=menu-item href=/projects title>Projects</a><a class=menu-item href=/about-me title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel=stylesheet><main class=main><div class=container><article class="page single"><h1 class=single-title>How to use an in-memory database for testing on Ktor</h1><br><div class=post-meta><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="4 Oct 2021">4 Oct 2021</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2062 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;10 minutes&nbsp;</div></div><br><div class=content id=content><div id=banner style=overflow:hidden;justify-content:space-around><div style=display:inline-block;margin-right:10px><a href=https://androidweekly.net/issues/issue-487><img style=margin:0 src=https://androidweekly.net/issues/issue-487/badge></a></div><div style=display:inline-block><a href="https://us12.campaign-archive.com/?u=f39692e245b94f7fb693b6d82&id=2b57b99606"><img style=margin:0 src=https://img.shields.io/badge/Featured%20in%20kotlinweekly.net-Issue%20%23271-%237874b4></a></div></div><div class="details admonition abstract open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw"></i>SERIES: Building a backend with Ktor<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><ul><li>Part 1: <a href=https://www.marcogomiero.com/posts/2021/ktor-project-structure/ target=_blank rel="noopener noreffer">Structuring a Ktor project</a></li><li>Part 2: <a href=https://www.marcogomiero.com/posts/2021/ktor-logging-on-disk/ target=_blank rel="noopener noreffer">How to persist Ktor logs</a></li><li>Part 3: How to use an in-memory database for testing on Ktor</li><li>Part 4: <a href=https://www.marcogomiero.com/posts/2022/ktor-migration-liquibase/ target=_blank rel="noopener noreffer">How to handle database migrations with Liquibase on Ktor</a></li><li>Part 5 <a href=https://www.marcogomiero.com/posts/2021/ktor-setup-documentation/ target=_blank rel="noopener noreffer">Generate API documentation from Swagger on Ktor</a></li></ul></div></div></div><p>Usually, in a backend project, there are different instances of the same database: one for production (or more than one, it depends on the architecture), one for staging, and a local one that runs in the development machine.</p><p>However, for automated testing, none of these databases will be suitable to use. Since the purpose of testing is checking that every part of the software is working as expected, it will be necessary to test also situations where there isn’t any data saved in the database. To achieve that, the database must be cleared after every test (or group of tests) or pre-populated before.</p><p>An approach to achieve that is using an in-memory database. As the name suggests, all the data will be saved in memory and not on disk, so they can be easily deleted when closing the database connection. Another approach could be using Docker to spin up every time a dedicated container for the database, to have a database that is like the one used in production. In my case, I preferred to use an in-memory solution but if you are interested in the topic, I suggest looking at this article by Philip Hauer: <a href=https://phauer.com/2017/dont-use-in-memory-databases-tests-h2/ target=_blank rel="noopener noreffer">Don&rsquo;t use In-Memory Databases (H2, Fongo) for Tests</a></p><p>In this article, I will cover how to setup an in-memory database with <a href=https://www.h2database.com/html/main.html target=_blank rel="noopener noreffer">H2</a> for testing on a Ktor project that uses a MySQL database in production.</p><p>This post is part of a series of posts dedicated to Ktor where I cover all the topics that made me struggle during development and that was not easy to achieve out of the box. You can check out the other instances of the series in the index above or <a href=https://twitter.com/marcoGomier target=_blank rel="noopener noreffer">follow me on Twitter</a> to keep up to date.</p><h2 id=setup>Setup</h2><p>The ORM that I’ve decided to use is <a href=https://github.com/JetBrains/Exposed target=_blank rel="noopener noreffer">Exposed</a> from Jetbrains. It is very nice to deal with and it offers the possibility to use a typesafe DSL that wraps SQL and a lightweight data access object.
Exposed supports different databases like MySQL, H2, PostgreSQL, SQLite. For a complete list, refer <a href=https://github.com/JetBrains/Exposed#supported-databases target=_blank rel="noopener noreffer">to the documentation</a>.</p><p>Exposed comes with a <a href=https://github.com/JetBrains/Exposed/wiki/Getting-Started target=_blank rel="noopener noreffer">different set of artifacts</a> that you can decide to use. For this project I’ve added the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;org.jetbrains.exposed:exposed-core:</span><span class=si>$exposed_version</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;org.jetbrains.exposed:exposed-dao:</span><span class=si>$exposed_version</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;org.jetbrains.exposed:exposed-jdbc:</span><span class=si>$exposed_version</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>The connection to the MySQL database is performed with the JDBC driver and with a connection pool provided by <a href=https://github.com/brettwooldridge/HikariCP target=_blank rel="noopener noreffer">Hikari</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;com.zaxxer:HikariCP:</span><span class=si>$hikaricp_version</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=n>implementation</span><span class=p>(</span><span class=s2>&#34;mysql:mysql-connector-java:</span><span class=si>$mysql_connector_version</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>The last required dependency is <a href=https://github.com/h2database/h2database target=_blank rel="noopener noreffer">H2</a> that is needed only for tests.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>testImplementation</span><span class=p>(</span><span class=s2>&#34;com.h2database:h2:</span><span class=si>$h2_version</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h2 id=database-connection>Database Connection:</h2><p>The connection and the disposal of the database is performed through a method defined in the <code>DatabaseFactory</code> interface</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>interface</span> <span class=nc>DatabaseFactory</span> <span class=p>{</span>
	<span class=k>fun</span> <span class=nf>connect</span><span class=p>()</span>
	<span class=k>fun</span> <span class=nf>close</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>This interface will then have a different implementation, depending on if the server is running in production or for unit or integration testing.</p><p>The factory implementation used in production creates a private <em>HikariDataSource</em> that will be used by the <code>connect</code> method</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>DatabaseFactoryImpl</span><span class=p>(</span><span class=n>appConfig</span><span class=p>:</span> <span class=n>AppConfig</span><span class=p>)</span> <span class=p>:</span> <span class=n>DatabaseFactory</span> <span class=p>{</span>

	<span class=k>private</span> <span class=k>val</span> <span class=py>dbConfig</span> <span class=p>=</span> <span class=n>appConfig</span><span class=p>.</span><span class=n>databaseConfig</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>connect</span><span class=p>()</span> <span class=p>{</span>
		<span class=n>Database</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>hikari</span><span class=p>())</span>
	<span class=p>}</span>

	<span class=k>private</span> <span class=k>fun</span> <span class=nf>hikari</span><span class=p>():</span> <span class=n>HikariDataSource</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>HikariConfig</span><span class=p>()</span>
        <span class=n>config</span><span class=p>.</span><span class=n>driverClassName</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>driverClass</span>
        <span class=n>config</span><span class=p>.</span><span class=n>jdbcUrl</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>url</span>
        <span class=n>config</span><span class=p>.</span><span class=n>username</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>user</span>
        <span class=n>config</span><span class=p>.</span><span class=n>password</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>password</span>
        <span class=n>config</span><span class=p>.</span><span class=n>maximumPoolSize</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>maxPoolSize</span>
        <span class=n>config</span><span class=p>.</span><span class=n>isAutoCommit</span> <span class=p>=</span> <span class=k>false</span>
        <span class=n>config</span><span class=p>.</span><span class=n>transactionIsolation</span> <span class=p>=</span> <span class=s2>&#34;TRANSACTION_REPEATABLE_READ&#34;</span>

        <span class=c1>// More configuration suggestions from https://github.com/brettwooldridge/HikariCP/wiki/MySQL-Configuration
</span><span class=c1></span>
        <span class=n>config</span><span class=p>.</span><span class=n>validate</span><span class=p>()</span>
        <span class=k>return</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>close</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// used only on Unit tests
</span><span class=c1></span>	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>The <code>connect</code> method will be called inside the Ktor module function during the initialization and the setup of the server.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>fun</span> <span class=nf>Application</span><span class=p>.</span><span class=n>module</span><span class=p>(</span><span class=n>testing</span><span class=p>:</span> <span class=n>Boolean</span> <span class=p>=</span> <span class=k>false</span><span class=p>,</span> <span class=n>koinModules</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Module</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span><span class=n>appModule</span><span class=p>))</span> <span class=p>{</span>
	<span class=o>..</span><span class=p>.</span>
	<span class=k>val</span> <span class=py>databaseFactory</span> <span class=k>by</span> <span class=n>inject</span><span class=p>&lt;</span><span class=n>DatabaseFactory</span><span class=p>&gt;()</span> <span class=n>databaseFactory</span><span class=p>.</span><span class=n>connect</span><span class=p>()</span>
	<span class=o>..</span><span class=p>.</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>As you may have noticed, the <code>DatabaseFactoryImpl</code> class uses some fields provided by <code>AppConfig</code>. These fields are the driver class used for the connection, the name, user, and password of the database, and other fields that are specific to the connection. These fields are placed inside the <code>application.conf</code> file to be able to change them on different instances of the server.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>ktor {

  ...

  database {
    driverClass = &#34;com.mysql.cj.jdbc.Driver&#34;
    url = &#34;jdbc:mysql://localhost:3308/chucknorris?useUnicode=true&amp;characterEncoding=UTF-8&#34;
    user = &#34;root&#34;
    password = &#34;password&#34;
    maxPoolSize = 3
  }
}
</code></pre></td></tr></table></div></div><p>After adding the <code>database</code> block, it is necessary to update accordingly the <code>AppConfig</code> class.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>data</span> <span class=k>class</span> <span class=nc>DatabaseConfig</span><span class=p>(</span>
	<span class=k>val</span> <span class=py>driverClass</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
	<span class=k>val</span> <span class=py>url</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
	<span class=k>val</span> <span class=py>user</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
	<span class=k>val</span> <span class=py>password</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
	<span class=k>val</span> <span class=py>maxPoolSize</span><span class=p>:</span> <span class=n>Int</span>
<span class=p>)</span>

<span class=k>class</span> <span class=nc>AppConfig</span> <span class=p>{</span>
	<span class=k>lateinit</span> <span class=k>var</span> <span class=py>databaseConfig</span><span class=p>:</span> <span class=n>DatabaseConfig</span>
	<span class=k>lateinit</span> <span class=k>var</span> <span class=py>serverConfig</span><span class=p>:</span> <span class=n>ServerConfig</span>
	<span class=c1>// Place here other configurations
</span><span class=c1></span><span class=p>}</span>

<span class=k>fun</span> <span class=nf>Application</span><span class=p>.</span><span class=n>setupConfig</span><span class=p>()</span> <span class=p>{</span>

	<span class=o>..</span><span class=p>.</span>

	<span class=c1>// Database
</span><span class=c1></span>	<span class=k>val</span> <span class=py>databaseObject</span> <span class=p>=</span> <span class=n>environment</span><span class=p>.</span><span class=n>config</span><span class=p>.</span><span class=n>config</span><span class=p>(</span><span class=s2>&#34;ktor.database&#34;</span><span class=p>)</span>
	<span class=k>val</span> <span class=py>driverClass</span> <span class=p>=</span> <span class=n>databaseObject</span><span class=p>.</span><span class=k>property</span><span class=p>(</span><span class=s2>&#34;driverClass&#34;</span><span class=p>).</span><span class=n>getString</span><span class=p>()</span>
	<span class=k>val</span> <span class=py>url</span> <span class=p>=</span> <span class=n>databaseObject</span><span class=p>.</span><span class=k>property</span><span class=p>(</span><span class=s2>&#34;url&#34;</span><span class=p>).</span><span class=n>getString</span><span class=p>()</span>
	<span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=n>databaseObject</span><span class=p>.</span><span class=k>property</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>).</span><span class=n>getString</span><span class=p>()</span>
	<span class=k>val</span> <span class=py>password</span> <span class=p>=</span> <span class=n>databaseObject</span><span class=p>.</span><span class=k>property</span><span class=p>(</span><span class=s2>&#34;password&#34;</span><span class=p>).</span><span class=n>getString</span><span class=p>()</span>
	<span class=k>val</span> <span class=py>maxPoolSize</span> <span class=p>=</span> <span class=n>databaseObject</span><span class=p>.</span><span class=k>property</span><span class=p>(</span><span class=s2>&#34;maxPoolSize&#34;</span><span class=p>).</span><span class=n>getString</span><span class=p>().</span><span class=n>toInt</span><span class=p>()</span>
	<span class=n>appConfig</span><span class=p>.</span><span class=n>databaseConfig</span> <span class=p>=</span> <span class=n>DatabaseConfig</span><span class=p>(</span><span class=n>driverClass</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=n>password</span><span class=p>,</span> <span class=n>maxPoolSize</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>For more informations about the configuration process, you can give a look at the first episode of the series: <a href=https://www.marcogomiero.com/posts/2021/ktor-project-structure#configuration target=_blank rel="noopener noreffer">Structuring a Ktor project</a></p><h2 id=testing>Testing</h2><p>For testing, it is necessary to cover two different situations: unit tests and integration tests (in this case I refer to integration tests that involve the server).</p><h3 id=setup-1>Setup</h3><p><strong>Integration testing</strong> that involves the server is performed with a <code>TestEngine</code> that does not create a web server but hooks directly into the internal mechanism. For more information about testing on Ktor, you can look at the first episode of the series: <a href=https://www.marcogomiero.com/posts/2021/ktor-project-structure#testing target=_blank rel="noopener noreffer">Structuring a Ktor project</a>. When this type of test is run, the same Ktor module function that initializes the server on production is called. In this way, the connection of the database is automatically performed.</p><p>When running <strong>unit tests</strong> instead, the server is not involved, so the connection to the database must be performed manually.</p><p>These two behaviors can be achieved with two implementations of the <code>DatabaseFactory</code>: <code>DatabaseFactoryForServerTest</code> and <code>DatabaseFactoryForUnitTest</code>.</p><p>The former receives the configuration data from the <code>AppConfig</code> class since the Ktor module function will be called.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>DatabaseFactoryForServerTest</span><span class=p>(</span><span class=n>appConfig</span><span class=p>:</span> <span class=n>AppConfig</span><span class=p>):</span> <span class=n>DatabaseFactory</span> <span class=p>{</span>

	<span class=o>..</span><span class=p>.</span>

	<span class=k>private</span> <span class=k>fun</span> <span class=nf>hikari</span><span class=p>():</span> <span class=n>HikariDataSource</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>HikariConfig</span><span class=p>()</span>
        <span class=n>config</span><span class=p>.</span><span class=n>driverClassName</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>driverClass</span>
        <span class=n>config</span><span class=p>.</span><span class=n>jdbcUrl</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>url</span>
        <span class=n>config</span><span class=p>.</span><span class=n>maximumPoolSize</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>maxPoolSize</span>
        <span class=n>config</span><span class=p>.</span><span class=n>isAutoCommit</span> <span class=p>=</span> <span class=k>true</span>
        <span class=n>config</span><span class=p>.</span><span class=n>validate</span><span class=p>()</span>
        <span class=k>return</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=o>..</span><span class=p>.</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>The latter instead has the configuration data hardcoded since the connection to the database must be performed manually.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>DatabaseFactoryForUnitTest</span><span class=p>:</span> <span class=n>DatabaseFactory</span> <span class=p>{</span>

	<span class=o>..</span><span class=p>.</span>

	<span class=k>private</span> <span class=k>fun</span> <span class=nf>hikari</span><span class=p>():</span> <span class=n>HikariDataSource</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>HikariConfig</span><span class=p>()</span>
        <span class=n>config</span><span class=p>.</span><span class=n>driverClassName</span> <span class=p>=</span> <span class=s2>&#34;org.h2.Driver&#34;</span>
        <span class=n>config</span><span class=p>.</span><span class=n>jdbcUrl</span> <span class=p>=</span> <span class=s2>&#34;jdbc:h2:mem:;DATABASE_TO_UPPER=false;MODE=MYSQL&#34;</span>
        <span class=n>config</span><span class=p>.</span><span class=n>maximumPoolSize</span> <span class=p>=</span> <span class=m>2</span>
        <span class=n>config</span><span class=p>.</span><span class=n>isAutoCommit</span> <span class=p>=</span> <span class=k>true</span>
        <span class=n>config</span><span class=p>.</span><span class=n>validate</span><span class=p>()</span>
        <span class=n>source</span> <span class=p>=</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>source</span>
	<span class=p>}</span>

    <span class=o>..</span><span class=p>.</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Since the database used is <strong>H2</strong>, the driver and the URL change a bit.
The driver class name is now: <code>org.h2.Driver</code> and the URL is: <code>jdbc:h2:mem:;DATABASE_TO_UPPER=false;MODE=MYSQL</code>. The URL specifies also some features:</p><ul><li><code>mem</code> -> it tells to use the in-memory version of H2</li><li><code>:</code> -> it does not specify a name for the database</li><li><code>DATABASE_TO_UPPER=false</code> -> it disable the default feature of using uppercase for identifiers. For example, if it is not disabled, the table names are uppercase and queries will fail</li><li><code>MODE=MYSQL</code> -> it uses the MySQL compatibility mode in order to have the same features of MySQL.</li></ul><p>To learn more about H2 database settings and features, I suggest you to look at the documentation for <a href=https://www.h2database.com/javadoc/org/h2/engine/DbSettings.html target=_blank rel="noopener noreffer">settings</a> and <a href=http://www.h2database.com/html/features.html target=_blank rel="noopener noreffer">features</a>.</p><p>After the connection to the database, it is necessary to create its structure, since the database will be destroyed after each test (or after a set of tests).</p><p>To do that, it is possible to use the features of Exposed.
After defining a table with the Exposed DSL (for more info about it, give a look at the <a href=https://github.com/JetBrains/Exposed/wiki/DSL target=_blank rel="noopener noreffer">Exposed documentation</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>object</span> <span class=nc>JokeTable</span><span class=p>:</span> <span class=n>IdTable</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;(</span><span class=n>name</span> <span class=p>=</span> <span class=s2>&#34;joke&#34;</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>val</span> <span class=py>createdAt</span> <span class=p>=</span> <span class=n>datetime</span><span class=p>(</span><span class=s2>&#34;created_at&#34;</span><span class=p>)</span>
	<span class=k>val</span> <span class=py>updatedAt</span> <span class=p>=</span> <span class=n>datetime</span><span class=p>(</span><span class=s2>&#34;updated_at&#34;</span><span class=p>)</span>
	<span class=k>val</span> <span class=py>value</span> <span class=p>=</span> <span class=n>text</span><span class=p>(</span><span class=s2>&#34;value&#34;</span><span class=p>)</span>

	<span class=k>override</span> <span class=k>val</span> <span class=py>id</span><span class=p>:</span> <span class=n>Column</span><span class=p>&lt;</span><span class=n>EntityID</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;&gt;</span> <span class=p>=</span> <span class=n>varchar</span><span class=p>(</span><span class=s2>&#34;joke_id&#34;</span><span class=p>,</span> <span class=m>255</span><span class=p>).</span><span class=n>entityId</span><span class=p>()</span>
	<span class=k>override</span> <span class=k>val</span> <span class=py>primaryKey</span><span class=p>:</span> <span class=n>PrimaryKey</span> <span class=p>=</span> <span class=n>PrimaryKey</span><span class=p>(</span><span class=n>id</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>it is possible to create the table:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>SchemaUtils</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>JokeTable</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Since this operation must be repeated for every table, it is better to create a function that can be called inside the DatabaseFactory.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>object</span> <span class=nc>SchemaDefinition</span> <span class=p>{</span>
	<span class=k>fun</span> <span class=nf>createSchema</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>transaction</span> <span class=p>{</span>
            <span class=n>SchemaUtils</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>JokeTable</span><span class=p>)</span>
        <span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>The <code>connect</code> function in both the database factories will look like that:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>override</span> <span class=k>fun</span> <span class=nf>connect</span><span class=p>()</span> <span class=p>{</span>
	<span class=n>Database</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>hikari</span><span class=p>())</span>
	<span class=n>SchemaDefinition</span><span class=p>.</span><span class=n>createSchema</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>However, during unit tests, it is necessary to manually close the connection to the database, to be sure that all the data are cleared between each test run. To be able to do that, it is necessary to store in the Factory an instance of <code>HikariDataSource</code> that can be closed with the <code>close</code> method.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>DatabaseFactoryForUnitTest</span><span class=p>:</span> <span class=n>DatabaseFactory</span> <span class=p>{</span>

	<span class=k>lateinit</span> <span class=k>var</span> <span class=py>source</span><span class=p>:</span> <span class=n>HikariDataSource</span>

	<span class=o>..</span><span class=p>.</span>

	<span class=k>private</span> <span class=k>fun</span> <span class=nf>hikari</span><span class=p>():</span> <span class=n>HikariDataSource</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>HikariConfig</span><span class=p>()</span>
        <span class=o>..</span><span class=p>.</span>
        <span class=n>source</span> <span class=p>=</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>source</span>
	<span class=p>}</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>close</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>source</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>As reference, here are the entire <code>DatabaseFactoryForServerTest</code> and <code>DatabaseFactoryForUnitTest</code> class.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>DatabaseFactoryForServerTest</span><span class=p>(</span><span class=n>appConfig</span><span class=p>:</span> <span class=n>AppConfig</span><span class=p>):</span> <span class=n>DatabaseFactory</span> <span class=p>{</span>

	<span class=k>private</span> <span class=k>val</span> <span class=py>dbConfig</span> <span class=p>=</span> <span class=n>appConfig</span><span class=p>.</span><span class=n>databaseConfig</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>connect</span><span class=p>()</span> <span class=p>{</span>
		<span class=n>Database</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>hikari</span><span class=p>())</span>
		<span class=n>SchemaDefinition</span><span class=p>.</span><span class=n>createSchema</span><span class=p>()</span>
	<span class=p>}</span>

	<span class=k>private</span> <span class=k>fun</span> <span class=nf>hikari</span><span class=p>():</span> <span class=n>HikariDataSource</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>HikariConfig</span><span class=p>()</span>
        <span class=n>config</span><span class=p>.</span><span class=n>driverClassName</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>driverClass</span>
        <span class=n>config</span><span class=p>.</span><span class=n>jdbcUrl</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>url</span>
        <span class=n>config</span><span class=p>.</span><span class=n>maximumPoolSize</span> <span class=p>=</span> <span class=n>dbConfig</span><span class=p>.</span><span class=n>maxPoolSize</span>
        <span class=n>config</span><span class=p>.</span><span class=n>isAutoCommit</span> <span class=p>=</span> <span class=k>true</span>
        <span class=n>config</span><span class=p>.</span><span class=n>validate</span><span class=p>()</span>
        <span class=k>return</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>close</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// used only for Unit tests
</span><span class=c1></span>	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>DatabaseFactoryForUnitTest</span><span class=p>:</span> <span class=n>DatabaseFactory</span> <span class=p>{</span>

	<span class=k>lateinit</span> <span class=k>var</span> <span class=py>source</span><span class=p>:</span> <span class=n>HikariDataSource</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>connect</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>Database</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>hikari</span><span class=p>())</span>
        <span class=n>SchemaDefinition</span><span class=p>.</span><span class=n>createSchema</span><span class=p>()</span>
	<span class=p>}</span>

	<span class=k>private</span> <span class=k>fun</span> <span class=nf>hikari</span><span class=p>():</span> <span class=n>HikariDataSource</span> <span class=p>{</span>
        <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>HikariConfig</span><span class=p>()</span>
        <span class=n>config</span><span class=p>.</span><span class=n>driverClassName</span> <span class=p>=</span> <span class=s2>&#34;org.h2.Driver&#34;</span>
        <span class=n>config</span><span class=p>.</span><span class=n>jdbcUrl</span> <span class=p>=</span> <span class=s2>&#34;jdbc:h2:mem:;DATABASE_TO_UPPER=false;MODE=MYSQL&#34;</span>
        <span class=n>config</span><span class=p>.</span><span class=n>maximumPoolSize</span> <span class=p>=</span> <span class=m>2</span>
        <span class=n>config</span><span class=p>.</span><span class=n>isAutoCommit</span> <span class=p>=</span> <span class=k>true</span>
        <span class=n>config</span><span class=p>.</span><span class=n>validate</span><span class=p>()</span>
        <span class=n>source</span> <span class=p>=</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>source</span>
	<span class=p>}</span>

	<span class=k>override</span> <span class=k>fun</span> <span class=nf>close</span><span class=p>()</span> <span class=p>{</span>
		<span class=n>source</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=execution>Execution</h3><p>As mentioned early, during <strong>integration tests</strong> that involve the server, the database connection is performed automatically since the Ktor module function will be called. The only thing to do is to replace in the Koin test module the <code>DatabaseFactory</code> implementation from <code>DatabaseFactoryImpl</code>, which is used in production, to <code>DatabaseFactoryForServerTest</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>val</span> <span class=py>appTestModule</span> <span class=p>=</span> <span class=n>module</span> <span class=p>{</span>
	<span class=o>..</span><span class=p>.</span>
	<span class=n>singleBy</span><span class=p>&lt;</span><span class=n>DatabaseFactory</span><span class=p>,</span> <span class=n>DatabaseFactoryForServerTest</span><span class=p>&gt;()</span>
	<span class=o>..</span><span class=p>.</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>As you can see in the following example of test, it is not required any initialization or setup in the test class.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>JokeResourceTest</span> <span class=p>:</span> <span class=n>AutoCloseKoinTest</span><span class=p>()</span> <span class=p>{</span>

	<span class=nd>@Test</span>
	<span class=k>fun</span> <span class=nf>`random joke api works correctly`</span><span class=p>()</span> <span class=p>=</span> <span class=n>withTestServer</span><span class=p>()</span> <span class=p>{</span>

		<span class=c1>// Setup
</span><span class=c1></span>		<span class=k>val</span> <span class=py>joke</span> <span class=p>=</span> <span class=n>transaction</span> <span class=p>{</span>
			<span class=n>Joke</span><span class=p>.</span><span class=n>new</span><span class=p>(</span><span class=s2>&#34;joke_1&#34;</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>this</span><span class=p>.</span><span class=n>value</span> <span class=p>=</span> <span class=s2>&#34;Chuck Norris tests are always green&#34;</span>
                <span class=k>this</span><span class=p>.</span><span class=n>createdAt</span> <span class=p>=</span> <span class=n>LocalDateTime</span><span class=p>.</span><span class=n>now</span><span class=p>()</span>
                <span class=k>this</span><span class=p>.</span><span class=n>updatedAt</span> <span class=p>=</span> <span class=n>LocalDateTime</span><span class=p>.</span><span class=n>now</span><span class=p>()</span>
	        <span class=p>}</span>
		<span class=p>}</span>

		<span class=k>val</span> <span class=py>href</span> <span class=p>=</span> <span class=n>application</span><span class=p>.</span><span class=n>locations</span><span class=p>.</span><span class=n>href</span><span class=p>(</span>
            <span class=n>JokeEndpoint</span><span class=p>.</span><span class=n>Random</span><span class=p>(</span>
                <span class=n>parent</span> <span class=p>=</span> <span class=n>JokeEndpoint</span><span class=p>()</span>
            <span class=p>)</span>
		<span class=p>)</span>

		<span class=n>handleRequest</span><span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=n>Get</span><span class=p>,</span> <span class=n>href</span><span class=p>).</span><span class=n>apply</span> <span class=p>{</span>
            <span class=n>assertEquals</span><span class=p>(</span><span class=n>HttpStatusCode</span><span class=p>.</span><span class=n>OK</span><span class=p>,</span> <span class=n>response</span><span class=p>.</span><span class=n>status</span><span class=p>())</span>

            <span class=k>val</span> <span class=py>response</span> <span class=p>=</span> <span class=n>Json</span><span class=p>.</span><span class=n>decodeFromString</span><span class=p>&lt;</span><span class=n>JokeDTO</span><span class=p>&gt;(</span><span class=n>response</span><span class=p>.</span><span class=n>content</span><span class=o>!!</span><span class=p>)</span>

            <span class=n>assertEquals</span><span class=p>(</span><span class=n>transaction</span> <span class=p>{</span> <span class=n>joke</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>value</span> <span class=p>},</span> <span class=n>response</span><span class=p>.</span><span class=n>jokeId</span><span class=p>)</span>
            <span class=n>assertEquals</span><span class=p>(</span><span class=n>transaction</span> <span class=p>{</span> <span class=n>joke</span><span class=p>.</span><span class=n>value</span> <span class=p>},</span> <span class=n>response</span><span class=p>.</span><span class=n>jokeContent</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>On <strong>unit tests</strong> instead, the connection and the disconnection from the database must be performed manually before and after the test, or whenever it is necessary.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>JokeRepositoryImplTest</span> <span class=p>:</span> <span class=n>KoinTest</span> <span class=p>{</span>

    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>databaseFactory</span><span class=p>:</span> <span class=n>DatabaseFactoryForUnitTest</span>

    <span class=k>private</span> <span class=k>val</span> <span class=py>jokeRepository</span><span class=p>:</span> <span class=n>JokeRepository</span> <span class=k>by</span> <span class=n>inject</span><span class=p>()</span>

    <span class=nd>@Before</span>
    <span class=k>fun</span> <span class=nf>setup</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>databaseFactory</span> <span class=p>=</span> <span class=n>DatabaseFactoryForUnitTest</span><span class=p>()</span>
        <span class=n>databaseFactory</span><span class=p>.</span><span class=n>connect</span><span class=p>()</span>
    <span class=p>}</span>

    <span class=nd>@After</span>
    <span class=k>fun</span> <span class=nf>tearDown</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>databaseFactory</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
    <span class=p>}</span>

    <span class=nd>@Test</span>
    <span class=k>fun</span> <span class=nf>`getRandomJoke returns data correctly`</span><span class=p>()</span> <span class=p>=</span> <span class=n>runBlockingTest</span> <span class=p>{</span>
        <span class=o>..</span><span class=p>.</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h2 id=conclusions>Conclusions</h2><p>And that’s it for today. You can find the code mentioned in the article on <a href=https://github.com/prof18/ktor-chuck-norris-sample/tree/part3 target=_blank rel="noopener noreffer">GitHub</a>.</p><p>In the next episode, I’ll cover database migrations. You can follow me on <a href=https://twitter.com/marcoGomier target=_blank rel="noopener noreffer">Twitter</a> to know when I’ll publish the next episodes.</p></div><section style=width:90%;margin-left:auto;margin-right:auto;margin-top:30px;margin-bottom:30px><hr><div style=padding:25px><div class=content>To stay up to date with my writing and my projects, follow me on <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div><hr></section><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/ data-title="How to use an in-memory database for testing on Ktor" data-via=marcoGomier><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/ data-title="How to use an in-memory database for testing on Ktor"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2021/kmp-xcframework-official-support/ class=prev rel=prev title="Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30"><i class="fas fa-angle-left fa-fw"></i>Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30</a>
<a href=/posts/2021/kmp-no-java-runtime-error-xcode/ class=next rel=next title='How to fix the "Unable to locate a Java Runtime" error on Xcode with Kotlin Multiplatform'>How to fix the "Unable to locate a Java Runtime" error on Xcode with Kotlin Multiplatform<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://www.marcogomiero.com/ target=_blank>Marco Gomiero</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:1e5},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-90975904-1 ',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-90975904-1%20" async></script></body></html>