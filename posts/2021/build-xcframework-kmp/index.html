<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>How to build an XCFramework on Kotlin Multiplatform - Marco Gomiero</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When you start integrating Kotlin Multiplatform (I‚Äôll call it KMP in the rest of the article) in an existing project you most likely don‚Äôt have a mono-repo structure (and making a refactor to achieve this kind of architecture will not be easy). An example of architecture is the following, with a repository for every platform.
To understand how to integrate KMP into existing code, give a look at my previous article: ‚ÄúIntroducing Kotlin Multiplatform in an existing project‚Äù"><meta property="og:image" content><meta name=google-site-verification content="7rDTNqn214SsZ9mmV8Ps5v2vqy8aXFWyoq08udChYCs"><meta property="og:title" content="How to build an XCFramework on Kotlin Multiplatform"><meta property="og:description" content="When you start integrating Kotlin Multiplatform (I‚Äôll call it KMP in the rest of the article) in an existing project you most likely don‚Äôt have a mono-repo structure (and making a refactor to achieve this kind of architecture will not be easy). An example of architecture is the following, with a repository for every platform.
To understand how to integrate KMP into existing code, give a look at my previous article: ‚ÄúIntroducing Kotlin Multiplatform in an existing project‚Äù"><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2021/build-xcframework-kmp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-14T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to build an XCFramework on Kotlin Multiplatform"><meta name=twitter:description content="When you start integrating Kotlin Multiplatform (I‚Äôll call it KMP in the rest of the article) in an existing project you most likely don‚Äôt have a mono-repo structure (and making a refactor to achieve this kind of architecture will not be easy). An example of architecture is the following, with a repository for every platform.
To understand how to integrate KMP into existing code, give a look at my previous article: ‚ÄúIntroducing Kotlin Multiplatform in an existing project‚Äù"><script async src="https://www.googletagmanager.com/gtag/js?id=G-69FZ1TLE7E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-69FZ1TLE7E",{anonymize_ip:!1})}</script><script src=https://www.marcogomiero.com/js/feather.min.js></script>
<link href="https://fonts.googleapis.com/css?family=JetBrains+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.marcogomiero.com/css/main.f2c7f60ec2d0155a784ade9b1b272143e1b8eb864a95bf75e606b49d8774389e.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://www.marcogomiero.com/css/dark.2d1f13dc82ea2d94683809543a326af8a9a1f3a6c000f7b7af5d8f02a2e6ec25.css disabled></head><body><div class=content><header><div class=main><a href=https://www.marcogomiero.com><h2>Marco Gomiero</h2></a></div><nav class=navbar><a href=/posts/><span>Write</span></a>
<a href=/talks/><span>Speak</span></a>
<a href=/projects/><span>Build</span></a>
<a href=/about-me/><span>About</span></a>
| <span class=dark-mode-toggle id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://www.marcogomiero.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>How to build an XCFramework on Kotlin Multiplatform</h1><div class=post-meta><span title='2021-07-14 00:00:00 +0000 UTC'>14 July 2021</span></div></div><section class=body><span class=raw-html><div class=post-award-container><a href=https://androidweekly.net/issues/issue-475><img src=https://androidweekly.net/issues/issue-475/badge></a>
<a href=https://mailchi.mp/kotlinweekly/kotlin-weekly-259><img src=https://img.shields.io/badge/Featured%20in%20kotlinweekly.net-Issue%20%23259-%237874b4></a></div></span><p>When you start integrating Kotlin Multiplatform (I‚Äôll call it KMP in the rest of the article) in an existing project you most likely don‚Äôt have a mono-repo structure (and making a refactor to achieve this kind of architecture will not be easy). An example of architecture is the following, with a repository for every platform.</p><figure><a href=/img/kmp-existing-project/kmp-publish-arch.png><img src=/img/kmp-existing-projects/kmp-publish-arch.png></a></figure><blockquote><p>To understand how to integrate KMP into existing code, give a look at my previous article: <a href=https://www.marcogomiero.com/posts/2021/kmp-existing-project/>‚ÄúIntroducing Kotlin Multiplatform in an existing project‚Äù</a></p></blockquote><p>KMP code will be served as a library: the compiler generates a .jar for the JVM, a .aar for Android, and a Framework for iOS.</p><p>For iOS, the Framework will be a FatFramework, because it is necessary to have in the same package the architecture for the simulator and the real device. In <a href=https://www.marcogomiero.com/posts/2021/kmp-existing-project/>a past article</a>, I‚Äôve explained how to generate a FatFramework and how to distribute it in a CocoaPod repo. It is possible with some Gradle tasks or with the <a href=https://github.com/prof18/kmp-fatframework-cocoa>KMP FatFramework Cocoa</a> Gradle plugin that I wrote.</p><p>However, FatFrameworks seems not to be the ‚Äúcurrent state of the art‚Äù solution to distribute multiple architectures at the same time. In fact, Apple during <a href=https://developer.apple.com/videos/play/wwdc2019/416/>WWDC 2019</a> has introduced <a href=https://help.apple.com/xcode/mac/11.4/#/dev544efab96>XCFramework</a>, a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time).</p><p>Apple is pushing toward the use of XCFrameworks and you could encounter errors like the following one that happened to <a href=https://twitter.com/handstandsam>Sam Edwards</a>.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>It WAS working... now... üò≠ü§î<br><br>Any ideas <a href="https://twitter.com/marcoGomier?ref_src=twsrc%5Etfw">@marcoGomier</a>? <a href=https://t.co/K8f5bPO44P>pic.twitter.com/K8f5bPO44P</a></p>&mdash; Sam Edwards (@HandstandSam) <a href="https://twitter.com/HandstandSam/status/1403456462689550345?ref_src=twsrc%5Etfw">June 11, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>Sam <a href=https://handstandsam.com/2021/06/11/kotlin-multiplatform-building-a-fat-ios-framework-for-iosarm64-and-iosx64/>followed the same approach</a> I‚Äôve followed but I never encounter the error! And the reason could be the following:</p><blockquote class=twitter-tweet><p lang=en dir=ltr>for those who really can't use xcframework, usage of VALIDATE_WORKSPACE = NO, on Build Settings, can be leverage. just make sure to set to YES and then NO so that xcode persists the value onto pbxproj</p>&mdash; Jo√£o Gon√ßalves (@Chuckytuh) <a href="https://twitter.com/Chuckytuh/status/1403673057487687682?ref_src=twsrc%5Etfw">June 12, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>Unfortunately, there isn‚Äôt native support for XCFrameworks on Kotlin Multiplatform yet (it should come hopefully with Kotlin 1.5.30) and to generate an XCFramework, you have to create manually an XCFramework starting from the different frameworks built by KMP.</p><blockquote><p>From Kotlin 1.5.30, XCFrameworks are officialy supported. I wrote another article on how to replace the custom gradle tasks, that are showcased below, with the official ones. <a href=https://www.marcogomiero.com/posts/2021/kmp-xcframework-official-support.md/>Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30</a>.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>xcrun xcodebuild -create-xcframework <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>    -framework /path/to/device.framework <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>    -debug-symbols /path/to/device.DSYM <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>    -framework /path/to/simulator.framework <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>    -debug-symbols /path/to/simulator.DSYM <span style=color:#5af78e>\
</span></span></span><span style=display:flex><span><span style=color:#5af78e></span>    -output frameworkName.xcframework
</span></span></code></pre></div><p>This is a boring thing to do manually every time, so there‚Äôs room for some scripting.</p><p>The first step is building a custom Gradle task, named <code>buildDebugXCFramework</code> to build a debug version of the XCFramework.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> libName = <span style=color:#ff5c57>‚Äú</span>LibraryName<span style=color:#ff5c57>‚Äù</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>register(<span style=color:#5af78e>&#34;buildDebugXCFramework&#34;</span>, Exec<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>.java) {
</span></span><span style=display:flex><span>    description = <span style=color:#5af78e>&#34;Create a Debug XCFramework&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFrameworkIosArm64&#34;</span>)
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFrameworkIosX64&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> arm64FrameworkPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosArm64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> arm64DebugSymbolsPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosArm64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework.dSYM&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> x64FrameworkPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosX64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> x64DebugSymbolsPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosX64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework.dSYM&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> xcFrameworkDest = File(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/../kmp-xcframework-dest/</span><span style=color:#5af78e>$libName</span><span style=color:#5af78e>.xcframework&#34;</span>)
</span></span><span style=display:flex><span>    executable = <span style=color:#5af78e>&#34;xcodebuild&#34;</span>
</span></span><span style=display:flex><span>    args(mutableListOf&lt;String&gt;().apply {
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-create-xcframework&#34;</span>)
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-output&#34;</span>)
</span></span><span style=display:flex><span>        add(xcFrameworkDest.path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// Real Device
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        add(<span style=color:#5af78e>&#34;-framework&#34;</span>)
</span></span><span style=display:flex><span>        add(arm64FrameworkPath)
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-debug-symbols&#34;</span>)
</span></span><span style=display:flex><span>        add(arm64DebugSymbolsPath)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// Simulator
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        add(<span style=color:#5af78e>&#34;-framework&#34;</span>)
</span></span><span style=display:flex><span>        add(x64FrameworkPath)
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-debug-symbols&#34;</span>)
</span></span><span style=display:flex><span>        add(x64DebugSymbolsPath)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    doFirst {
</span></span><span style=display:flex><span>        xcFrameworkDest.deleteRecursively()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first thing to do is building the frameworks for the required architectures: arm64 for the ‚Äúreal‚Äù device and X64 for the simulator. The build process can be triggered with the <code>link</code> task, in this case for the <code>Debug</code> variant of the framework.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFrameworkIosArm64&#34;</span>)
</span></span><span style=display:flex><span>dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>DebugFrameworkIosX64&#34;</span>)
</span></span></code></pre></div><p>The frameworks will be saved in the <code>build/bin</code> folder of the project:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>build
</span></span><span style=display:flex><span>‚îî‚îÄ‚îÄ bin
</span></span><span style=display:flex><span>    ‚îú‚îÄ‚îÄ iosArm64
</span></span><span style=display:flex><span>    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ LibraryNameDebugFramework
</span></span><span style=display:flex><span>    ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ LibraryName.framework
</span></span><span style=display:flex><span>    ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ LibraryName.framework.dSYM
</span></span><span style=display:flex><span>    ‚îî‚îÄ‚îÄ iosX64
</span></span><span style=display:flex><span>        ‚îú‚îÄ‚îÄ LibraryNameDebugFramework
</span></span><span style=display:flex><span>        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ LibraryName.framework
</span></span><span style=display:flex><span>        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ LibraryName.framework.dSYM
</span></span></code></pre></div><p>At this point, it is necessary to provide to the task all the parameters required by <code>xcodebuild</code> command.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>executable = <span style=color:#5af78e>&#34;xcodebuild&#34;</span>
</span></span><span style=display:flex><span>args(mutableListOf&lt;String&gt;().apply {
</span></span><span style=display:flex><span>    add(<span style=color:#5af78e>&#34;-create-xcframework&#34;</span>)
</span></span><span style=display:flex><span>    add(<span style=color:#5af78e>&#34;-output&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>‚Ä¶</span>
</span></span><span style=display:flex><span>}    
</span></span></code></pre></div><p>Before executing the task, it‚Äôs better to clear the files inside the XCFramework destination, because the <code>xcodebuild</code> command will not replace the old artifacts.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>doFirst {
</span></span><span style=display:flex><span>    xcFrameworkDest.deleteRecursively()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that‚Äôs it! Now there is a Debug XCFramework ready to be distributed.</p><p>The steps required to build a Release version of the framework are very similar.</p><p>First of all, it is necessary to build the frameworks for both the required architectures:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span> dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFrameworkIosArm64&#34;</span>)
</span></span><span style=display:flex><span> dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFrameworkIosX64&#34;</span>)
</span></span></code></pre></div><p>The frameworks will be saved in the <code>build/bin</code> folder like for the Debug version:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>build
</span></span><span style=display:flex><span>‚îî‚îÄ‚îÄ bin
</span></span><span style=display:flex><span>    ‚îú‚îÄ‚îÄ iosArm64
</span></span><span style=display:flex><span>    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ LibraryNameReleaseFramework
</span></span><span style=display:flex><span>    ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ LibraryName.framework
</span></span><span style=display:flex><span>    ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ LibraryName.framework.dSYM
</span></span><span style=display:flex><span>    ‚îî‚îÄ‚îÄ iosX64
</span></span><span style=display:flex><span>        ‚îî‚îÄ‚îÄ LibraryNameReleaseFramework
</span></span><span style=display:flex><span>            ‚îú‚îÄ‚îÄ LibraryName.framework
</span></span><span style=display:flex><span>            ‚îî‚îÄ‚îÄ LibraryName.framework.dSYM
</span></span></code></pre></div><p>The parameters for the <code>xcodebuild</code> command will be the same, except for the path.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span> register(<span style=color:#5af78e>&#34;buildReleaseXCFramework&#34;</span>, Exec<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>.java) {
</span></span><span style=display:flex><span>    description = <span style=color:#5af78e>&#34;Create a Release XCFramework&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFrameworkIosArm64&#34;</span>)
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#5af78e>&#34;link</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFrameworkIosX64&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> arm64FrameworkPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosArm64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> arm64DebugSymbolsPath =
</span></span><span style=display:flex><span>        <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosArm64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework.dSYM&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> x64FrameworkPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosX64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> x64DebugSymbolsPath = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/build/bin/iosX64/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>ReleaseFramework/</span><span style=color:#5af78e>${libName}</span><span style=color:#5af78e>.framework.dSYM&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> xcFrameworkDest = File(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/../kmp-xcframework-dest/</span><span style=color:#5af78e>$libName</span><span style=color:#5af78e>.xcframework&#34;</span>)
</span></span><span style=display:flex><span>    executable = <span style=color:#5af78e>&#34;xcodebuild&#34;</span>
</span></span><span style=display:flex><span>    args(mutableListOf&lt;String&gt;().apply {
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-create-xcframework&#34;</span>)
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-output&#34;</span>)
</span></span><span style=display:flex><span>        add(xcFrameworkDest.path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// Real Device
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        add(<span style=color:#5af78e>&#34;-framework&#34;</span>)
</span></span><span style=display:flex><span>        add(arm64FrameworkPath)
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-debug-symbols&#34;</span>)
</span></span><span style=display:flex><span>        add(arm64DebugSymbolsPath)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// Simulator
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        add(<span style=color:#5af78e>&#34;-framework&#34;</span>)
</span></span><span style=display:flex><span>        add(x64FrameworkPath)
</span></span><span style=display:flex><span>        add(<span style=color:#5af78e>&#34;-debug-symbols&#34;</span>)
</span></span><span style=display:flex><span>        add(x64DebugSymbolsPath)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    doFirst {
</span></span><span style=display:flex><span>        xcFrameworkDest.deleteRecursively()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The newly built XCFramework can now be distributed. The distribution can be archived in different ways: for example in a <em><a href=https://cocoapods.org/>CocoaPods</a></em> repository, in the <a href=https://swift.org/package-manager/>Swift Package Manager</a> or with <a href=https://github.com/Carthage/Carthage>Carthage</a>. Since I‚Äôm familiar with CocoaPods, that‚Äôs what I‚Äôm using.</p><p>To make the publishing process as streamlined as possible, I‚Äôve written a bunch of Gradle tasks to automatically build and publish through git the Debug and Release version of the XCFramework. For the details and to understand how the task works, I suggest you give a look at <a href=https://www.marcogomiero.com/posts/2021/kmp-existing-project/>this article</a> that I wrote a few months ago.</p><p><strong>Publish Debug Version</strong>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>register(<span style=color:#5af78e>&#34;publishDevFramework&#34;</span>) {
</span></span><span style=display:flex><span>    description = <span style=color:#5af78e>&#34;Publish Debug XCFramework to the Cocoa Repo&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    project.exec {
</span></span><span style=display:flex><span>        workingDir = File(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>        commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;checkout&#34;</span>, <span style=color:#5af78e>&#34;develop&#34;</span>).standardOutput
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#5af78e>&#34;buildDebugXCFramework&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    doLast {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> dir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;/&lt;your-library-name&gt;.podspec&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> tempFile = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;/&lt;your-library-name&gt;.podspec.new&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> reader = dir.bufferedReader()
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> writer = tempFile.bufferedWriter()
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>var</span> currentLine: String?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>while</span> (reader.readLine().also { currLine <span style=color:#ff6ac1>-&gt;</span> currentLine = currLine } <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>if</span> (currentLine<span style=color:#ff6ac1>?.</span>startsWith(<span style=color:#5af78e>&#34;s.version&#34;</span>) <span style=color:#ff6ac1>==</span> <span style=color:#ff6ac1>true</span>) {
</span></span><span style=display:flex><span>                writer.write(<span style=color:#5af78e>&#34;s.version       = </span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>${libVersionName}</span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>&#34;</span> + System.lineSeparator())
</span></span><span style=display:flex><span>            } <span style=color:#ff6ac1>else</span> {
</span></span><span style=display:flex><span>                writer.write(currentLine + System.lineSeparator())
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        writer.close()
</span></span><span style=display:flex><span>        reader.close()
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> successful = tempFile.renameTo(dir)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>if</span> (successful) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>val</span> dateFormatter = SimpleDateFormat(<span style=color:#5af78e>&#34;dd/MM/yyyy - HH:mm&#34;</span>, Locale.getDefault())
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;commit&#34;</span>, <span style=color:#5af78e>&#34;-a&#34;</span>, <span style=color:#5af78e>&#34;-m&#34;</span>, <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>New dev release: </span><span style=color:#5af78e>${libVersionName}</span><span style=color:#5af78e>-</span><span style=color:#5af78e>${dateFormatter.format(Date())}</span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;push&#34;</span>, <span style=color:#5af78e>&#34;origin&#34;</span>, <span style=color:#5af78e>&#34;develop&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Publish Release Version</strong>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>register(<span style=color:#5af78e>&#34;publishFramework&#34;</span>) {
</span></span><span style=display:flex><span>    description = <span style=color:#5af78e>&#34;Publish Release XCFramework to the Cocoa Repo&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    project.exec {
</span></span><span style=display:flex><span>        workingDir = File(<span style=color:#5af78e>&#34;</span><span style=color:#5af78e>$rootDir</span><span style=color:#5af78e>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>        commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;checkout&#34;</span>, <span style=color:#5af78e>&#34;master&#34;</span>).standardOutput
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#5af78e>&#34;buildReleaseXCFramework&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    doLast {
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> dir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;/&lt;your-library-name&gt;.podspec&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> tempFile = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;/&lt;your-library-name&gt;.podspec.new&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> reader = dir.bufferedReader()
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> writer = tempFile.bufferedWriter()
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>var</span> currentLine: String?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>while</span> (reader.readLine().also { currLine <span style=color:#ff6ac1>-&gt;</span> currentLine = currLine } <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>if</span> (currentLine<span style=color:#ff6ac1>?.</span>startsWith(<span style=color:#5af78e>&#34;s.version&#34;</span>) <span style=color:#ff6ac1>==</span> <span style=color:#ff6ac1>true</span>) {
</span></span><span style=display:flex><span>                writer.write(<span style=color:#5af78e>&#34;s.version       = </span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>${libVersionName}</span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>&#34;</span> + System.lineSeparator())
</span></span><span style=display:flex><span>            } <span style=color:#ff6ac1>else</span> {
</span></span><span style=display:flex><span>                writer.write(currentLine + System.lineSeparator())
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        writer.close()
</span></span><span style=display:flex><span>        reader.close()
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>val</span> successful = tempFile.renameTo(dir)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>if</span> (successful) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;commit&#34;</span>, <span style=color:#5af78e>&#34;-a&#34;</span>, <span style=color:#5af78e>&#34;-m&#34;</span>, <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>New release: </span><span style=color:#5af78e>${libVersionName}</span><span style=color:#5af78e>\&#34;</span><span style=color:#5af78e>&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;tag&#34;</span>, libVersionName).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#5af78e>&#34;&lt;framework-destination&gt;&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#5af78e>&#34;git&#34;</span>, <span style=color:#5af78e>&#34;push&#34;</span>, <span style=color:#5af78e>&#34;origin&#34;</span>, <span style=color:#5af78e>&#34;master&#34;</span>, <span style=color:#5af78e>&#34;--tags&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All the tasks mentioned in the article are available in the <a href=https://github.com/prof18/kmp-fatframework-cocoa>KMP FatFramework Cocoa Gradle plugin</a> that I wrote. The support for XCFrameworks has been added since <a href=https://github.com/prof18/kmp-fatframework-cocoa/releases/tag/0.2.1>version 0.2.1</a>.</p><p>On GitHub, I‚Äôve published <a href=https://github.com/prof18/kmp-xcframework-sample>a sample project</a> to showcase the usage of the task. In the <a href=https://github.com/prof18/kmp-xcframework-sample/tree/pre-kotlin-1.5.30>pre-kotlin-1.5.30</a> branch the tasks are manually added in the <a href=https://github.com/prof18/kmp-xcframework-sample/blob/pre-kotlin-1.5.30/build.gradle.kts>build.gradle.kts</a> file. In the <a href=https://github.com/prof18/kmp-xcframework-sample/tree/pre-kotlin-1.5.30-with-plugin>pre-kotlin-1.5.30-with-plugin</a> branch instead, the KMP FatFramework Cocoa plugin is used.</p><p>You can follow me on <a href=https://twitter.com/marcoGomier>Twitter</a> to know when there will be some update of the plugin (and this is a spoiler! :))</p><p style=font-size:12px>// Thanks to <a href=https://twitter.com/handstandsam>Sam Edwards</a> for mentioning my article and ‚Äútrigger‚Äù the creation of this one.</p></section><div class=article-footer><div class=body>To stay up to date with my writing and my projects, follow me on <a href=https://androiddev.social/@marcogom target=_blank>Mastodon</a> or <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-69FZ1TLE7E","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>