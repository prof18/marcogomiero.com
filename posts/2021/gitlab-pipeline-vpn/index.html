<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Connect to Open VPN during Gitlab Pipeline | Marco Gomiero</title><meta name=keywords content><meta name=description content="Gitlab CI/CD offers the possibility to create a pipeline, which runs when something changes in the repository. A pipeline consists of one or more stages that run in order and in these stages, for example, it is possible to build the project, run the tests, create the artifacts, etc. For more information about Gitlab CI/CD, I suggest you look over the documentation.
These out-of-the-box solutions really simplify the work to be done to have a CI up and running."><meta name=author content="Marco Gomiero"><link rel=canonical href=https://www.marcogomiero.com/posts/2021/gitlab-pipeline-vpn/><link crossorigin=anonymous href=/assets/css/stylesheet.min.686715e54e31dbf63447efd76235e41e047fd8826df608657b7b0ddb3a0d900d.css integrity="sha256-aGcV5U4x2/Y0R+/XYjXkHgR/2IJt9ghle3sN2zoNkA0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.marcogomiero.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.marcogomiero.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.marcogomiero.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.marcogomiero.com/apple-touch-icon.png><link rel=mask-icon href=https://www.marcogomiero.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-90975904-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="Connect to Open VPN during Gitlab Pipeline"><meta property="og:description" content="Gitlab CI/CD offers the possibility to create a pipeline, which runs when something changes in the repository. A pipeline consists of one or more stages that run in order and in these stages, for example, it is possible to build the project, run the tests, create the artifacts, etc. For more information about Gitlab CI/CD, I suggest you look over the documentation.
These out-of-the-box solutions really simplify the work to be done to have a CI up and running."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2021/gitlab-pipeline-vpn/"><meta property="og:image" content="https://www.marcogomiero.com/img/profile.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-28T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-28T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.marcogomiero.com/img/profile.webp"><meta name=twitter:title content="Connect to Open VPN during Gitlab Pipeline"><meta name=twitter:description content="Gitlab CI/CD offers the possibility to create a pipeline, which runs when something changes in the repository. A pipeline consists of one or more stages that run in order and in these stages, for example, it is possible to build the project, run the tests, create the artifacts, etc. For more information about Gitlab CI/CD, I suggest you look over the documentation.
These out-of-the-box solutions really simplify the work to be done to have a CI up and running."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.marcogomiero.com/posts/"},{"@type":"ListItem","position":3,"name":"Connect to Open VPN during Gitlab Pipeline","item":"https://www.marcogomiero.com/posts/2021/gitlab-pipeline-vpn/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Connect to Open VPN during Gitlab Pipeline","name":"Connect to Open VPN during Gitlab Pipeline","description":"Gitlab CI/CD offers the possibility to create a pipeline, which runs when something changes in the repository. A pipeline consists of one or more stages that run in order and in these stages, for example, it is possible to build the project, run the tests, create the artifacts, etc. For more information about Gitlab CI/CD, I suggest you look over the documentation.\nThese out-of-the-box solutions really simplify the work to be done to have a CI up and running.","keywords":[],"articleBody":"Gitlab CI/CD offers the possibility to create a pipeline, which runs when something changes in the repository. A pipeline consists of one or more stages that run in order and in these stages, for example, it is possible to build the project, run the tests, create the artifacts, etc. For more information about Gitlab CI/CD, I suggest you look over the documentation.\nThese out-of-the-box solutions really simplify the work to be done to have a CI up and running. For example, this is the configuration file (a file called .gitlab-ci.yml placed at the repository’s root) needed for running all the tests of a Kotlin project.\nimage: openjdk:11-jdk cache: key: ${CI_PROJECT_ID} paths: - .gradle/ before_script: - export GRADLE_USER_HOME=$(pwd)/.gradle - chmod +x ./gradlew stages: - test test: stage: test script: - ./gradlew test --info --stacktrace But, let’s assume that the project is using some libraries that are published on a private Maven repository behind a VPN. The pipeline will fail because it can’t download the dependencies.\nTo connect to a VPN, it is necessary to do some tweaks before starting the stages of the pipeline. And it is possible to do it by writing the commands inside the before_script: phase.\nFor this example, I will use OpenVPN but the script can be adapted for whatever type of VPN.\nBefore writing any code, it is necessary to write some secret variables (the menu is available under Settings  CI/CD  Variables - here for more info). Three variables are necessary:\n CLIENT_OVPN - the content of the .ovpn file VPN_USER - the VPN user VPN_PWD - the VPN password  First of all, some dependencies are needed\nbefore_script: ... ## VPN - echo \"Setup Open VPN\" - which openvpn || (apt-get update -y -qq \u0026\u0026 apt-get install -y -qq openvpn \u0026\u0026 apt-get install -y -qq iputils-ping) Then the secrets need to be loaded:\nbefore_script: ... - cat /etc/openvpn/client.ovpn - cat /etc/openvpn/cred.txt - cat  /etc/openvpn/cred.txt # append at the bottom Now, the connection can be performed:\nbefore_script: ... - openvpn --config /etc/openvpn/client.ovpn --auth-user-pass /etc/openvpn/cred.txt --daemon To check that everything is ok I make a 30 seconds sleep (yes, it’s brutal but it works) and then I ping the server:\nbefore_script: ... - sleep 30s - ping -c 1  And that’s it! Now the pipeline can download all the dependencies, even the ones under VPN.\nFor reference, here’s the complete .gitlab-ci.yml file:\nimage: openjdk:11-jdk cache: key: ${CI_PROJECT_ID} paths: - .gradle/ before_script: - export GRADLE_USER_HOME=$(pwd)/.gradle - chmod +x ./gradlew ## VPN - echo \"Setup Open VPN\" - which openvpn || (apt-get update -y -qq \u0026\u0026 apt-get install -y -qq openvpn \u0026\u0026 apt-get install -y -qq iputils-ping) - cat /etc/openvpn/client.ovpn - cat /etc/openvpn/cred.txt - cat  /etc/openvpn/cred.txt  - openvpn --config /etc/openvpn/client.ovpn --auth-user-pass /etc/openvpn/cred.txt --daemon - sleep 30s - ping -c 1  stages: - test test: stage: test script: - ./gradlew test --info --stacktrace ","wordCount":"493","inLanguage":"en","datePublished":"2021-06-28T00:00:00Z","dateModified":"2021-06-28T00:00:00Z","author":{"@type":"Person","name":"Marco Gomiero"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.marcogomiero.com/posts/2021/gitlab-pipeline-vpn/"},"publisher":{"@type":"Organization","name":"Marco Gomiero","logo":{"@type":"ImageObject","url":"https://www.marcogomiero.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://www.marcogomiero.com accesskey=h title="Marco Gomiero (Alt + H)">Marco Gomiero</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.marcogomiero.com/posts/ title=Write><span>Write</span></a></li><li><a href=https://www.marcogomiero.com/talks/ title=Speak><span>Speak</span></a></li><li><a href=https://www.marcogomiero.com/projects/ title=Build><span>Build</span></a></li><li><a href=https://www.marcogomiero.com/about-me/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Connect to Open VPN during Gitlab Pipeline</h1><div class=post-meta style=margin-top:16px><span title="2021-06-28 00:00:00 +0000 UTC">28 June 2021</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>Gitlab CI/CD offers the possibility to create a pipeline, which runs when something changes in the repository. A pipeline consists of one or more stages that run in order and in these stages, for example, it is possible to build the project, run the tests, create the artifacts, etc. For more information about Gitlab CI/CD, I suggest you look over the <a href=https://docs.gitlab.com/ee/ci/>documentation</a>.</p><p>These out-of-the-box solutions really simplify the work to be done to have a CI up and running. For example, this is the configuration file (a file called <code>.gitlab-ci.yml</code> placed at the repository’s root) needed for running all the tests of a Kotlin project.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>image</span>: <span style=color:#ae81ff>openjdk:11-jdk</span>

<span style=color:#f92672>cache</span>:
  <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${CI_PROJECT_ID}</span>
  <span style=color:#f92672>paths</span>:
    - <span style=color:#ae81ff>.gradle/</span>

<span style=color:#f92672>before_script</span>:
  - <span style=color:#ae81ff>export GRADLE_USER_HOME=$(pwd)/.gradle</span>
  - <span style=color:#ae81ff>chmod +x ./gradlew</span>

<span style=color:#f92672>stages</span>:
  - <span style=color:#ae81ff>test</span>

<span style=color:#f92672>test</span>:
  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
  <span style=color:#f92672>script</span>:
    - <span style=color:#ae81ff>./gradlew test --info --stacktrace</span>
</code></pre></div><p>But, let’s assume that the project is using some libraries that are published on a private Maven repository behind a VPN. The pipeline will fail because it can’t download the dependencies.</p><p>To connect to a VPN, it is necessary to do some tweaks before starting the stages of the pipeline. And it is possible to do it by writing the commands inside the <code>before_script:</code> phase.</p><p>For this example, I will use OpenVPN but the script can be adapted for whatever type of VPN.</p><p>Before writing any code, it is necessary to write some secret variables (the menu is available under Settings > CI/CD > Variables - <a href=https://docs.gitlab.com/ee/ci/variables/README.html#create-a-custom-variable-in-the-ui>here</a> for more info).
Three variables are necessary:</p><ul><li>CLIENT_OVPN -> the content of the .ovpn file</li><li>VPN_USER -> the VPN user</li><li>VPN_PWD -> the VPN password</li></ul><p>First of all, some dependencies are needed</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>before_script</span>:
  <span style=color:#ae81ff>...</span>
  <span style=color:#75715e>## VPN</span>
  - <span style=color:#ae81ff>echo &#34;Setup Open VPN&#34;</span>
  - <span style=color:#ae81ff>which openvpn || (apt-get update -y -qq &amp;&amp; apt-get install -y -qq openvpn &amp;&amp; apt-get install -y -qq iputils-ping)</span>
</code></pre></div><p>Then the secrets need to be loaded:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>before_script</span>:
  <span style=color:#ae81ff>...</span>
  - <span style=color:#ae81ff>cat &lt;&lt;&lt; $CLIENT_OVPN &gt; /etc/openvpn/client.ovpn</span>
  - <span style=color:#ae81ff>cat &lt;&lt;&lt; $VPN_USER &gt; /etc/openvpn/cred.txt</span>
  - <span style=color:#ae81ff>cat &lt;&lt;&lt; $VPN_PWD &gt;&gt; /etc/openvpn/cred.txt</span> <span style=color:#75715e># append at the bottom</span>
</code></pre></div><p>Now, the connection can be performed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>before_script</span>:
  <span style=color:#ae81ff>...</span>
  - <span style=color:#ae81ff>openvpn --config /etc/openvpn/client.ovpn --auth-user-pass /etc/openvpn/cred.txt --daemon</span>
</code></pre></div><p>To check that everything is ok I make a 30 seconds sleep (yes, it’s brutal but it works) and then I ping the server:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>before_script</span>:
  <span style=color:#ae81ff>...</span>
  - <span style=color:#ae81ff>sleep 30s</span>
  - <span style=color:#ae81ff>ping -c 1 &lt;your-ip&gt;</span>
</code></pre></div><p>And that’s it! Now the pipeline can download all the dependencies, even the ones under VPN.</p><p>For reference, here’s the complete <code>.gitlab-ci.yml</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>image</span>: <span style=color:#ae81ff>openjdk:11-jdk</span>

<span style=color:#f92672>cache</span>:
  <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${CI_PROJECT_ID}</span>
  <span style=color:#f92672>paths</span>:
    - <span style=color:#ae81ff>.gradle/</span>

<span style=color:#f92672>before_script</span>:
  - <span style=color:#ae81ff>export GRADLE_USER_HOME=$(pwd)/.gradle</span>
  - <span style=color:#ae81ff>chmod +x ./gradlew</span>
  <span style=color:#75715e>## VPN</span>
  - <span style=color:#ae81ff>echo &#34;Setup Open VPN&#34;</span>
  - <span style=color:#ae81ff>which openvpn || (apt-get update -y -qq &amp;&amp; apt-get install -y -qq openvpn &amp;&amp; apt-get install -y -qq iputils-ping)</span>
  - <span style=color:#ae81ff>cat &lt;&lt;&lt; $CLIENT_OVPN &gt; /etc/openvpn/client.ovpn</span>
  - <span style=color:#ae81ff>cat &lt;&lt;&lt; $VPN_USER &gt; /etc/openvpn/cred.txt</span>
  - <span style=color:#ae81ff>cat &lt;&lt;&lt; $VPN_PWD &gt;&gt; /etc/openvpn/cred.txt </span>
  - <span style=color:#ae81ff>openvpn --config /etc/openvpn/client.ovpn --auth-user-pass /etc/openvpn/cred.txt --daemon</span>
  - <span style=color:#ae81ff>sleep 30s</span>
  - <span style=color:#ae81ff>ping -c 1 &lt;your-ip&gt;</span>

<span style=color:#f92672>stages</span>:
  - <span style=color:#ae81ff>test</span>

<span style=color:#f92672>test</span>:
  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
  <span style=color:#f92672>script</span>:
    - <span style=color:#ae81ff>./gradlew test --info --stacktrace</span>
</code></pre></div></div><div class=article-footer><div class=post-content>To stay up to date with my writing and my projects, follow me on <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.marcogomiero.com/posts/2021/build-xcframework-kmp/><span class=title>« Prev</span><br><span>How to build an XCFramework on Kotlin Multiplatform</span></a>
<a class=next href=https://www.marcogomiero.com/posts/2021/ktor-logging-on-disk/><span class=title>Next »</span><br><span>How to persist Ktor logs</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>