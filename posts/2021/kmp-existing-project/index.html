<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Introducing Kotlin Multiplatform in an existing project - Marco Gomiero</title><meta name=Description content="Software Engineer · Google Developer Expert for Kotlin"><meta property="og:title" content="Introducing Kotlin Multiplatform in an existing project"><meta property="og:description" content="After discovering a new interesting technology or framework, you will probably start asking yourself how to integrate it into an existing project. That’s because, the possibility to start with a blank canvas is rare (not impossible, but rare).
This is also the case for Kotlin Multiplatform (I’ll call it KMP in the rest of the article).
When starting a new blank KMP project it is easier to have a mono-repo structure like this:"><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2021/kmp-existing-project/"><meta property="og:image" content="https://www.marcogomiero.com/img/profile.webp"><meta property="article:published_time" content="2021-02-25T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-25T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.marcogomiero.com/img/profile.webp"><meta name=twitter:title content="Introducing Kotlin Multiplatform in an existing project"><meta name=twitter:description content="After discovering a new interesting technology or framework, you will probably start asking yourself how to integrate it into an existing project. That’s because, the possibility to start with a blank canvas is rare (not impossible, but rare).
This is also the case for Kotlin Multiplatform (I’ll call it KMP in the rest of the article).
When starting a new blank KMP project it is easier to have a mono-repo structure like this:"><meta name=application-name content="Marco Gomiero"><meta name=apple-mobile-web-app-title content="Marco Gomiero"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.marcogomiero.com/posts/2021/kmp-existing-project/><link rel=prev href=https://www.marcogomiero.com/posts/2021/move-libray-jcenter-to-maven/><link rel=next href=https://www.marcogomiero.com/posts/2021/kmp-fatframework-cocoa-release/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><meta name=google-site-verification content="7rDTNqn214SsZ9mmV8Ps5v2vqy8aXFWyoq08udChYCs"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Introducing Kotlin Multiplatform in an existing project","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.marcogomiero.com\/posts\/2021\/kmp-existing-project\/"},"image":["https:\/\/www.marcogomiero.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":2660,"url":"https:\/\/www.marcogomiero.com\/posts\/2021\/kmp-existing-project\/","datePublished":"2021-02-25T00:00:00+00:00","dateModified":"2021-02-25T00:00:00+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Marco Gomiero","logo":"https:\/\/www.marcogomiero.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Marco Gomiero"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Marco Gomiero">Marco Gomiero</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts>Posts </a><a class=menu-item href=/talks>Talks </a><a class=menu-item href=/projects>Projects </a><a class=menu-item href=/about-me>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Marco Gomiero">Marco Gomiero</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts>Posts</a><a class=menu-item href=/talks>Talks</a><a class=menu-item href=/projects>Projects</a><a class=menu-item href=/about-me>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel=stylesheet><main class=main><div class=container><article class="page single"><h1 class=single-title>Introducing Kotlin Multiplatform in an existing project</h1><br><div class=post-meta><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="25 Feb 2021">25 Feb 2021</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2660 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;13 minutes&nbsp;</div></div><br><div class=content id=content><div id=banner style=overflow:hidden;justify-content:space-around><div style=display:inline-block;margin-right:10px><a href=https://androidweekly.net/issues/issue-455><img style=margin:0 src=https://androidweekly.net/issues/issue-455/badge></a></div><div style=display:inline-block><a href="https://us12.campaign-archive.com/?u=f39692e245b94f7fb693b6d82&id=22e5320947"><img style=margin:0 src=https://img.shields.io/badge/Featured%20in%20kotlinweekly.net-Issue%20%23239-%237874b4></a></div></div><p>After discovering a new interesting technology or framework, you will probably start asking yourself how to integrate it into an existing project. That’s because, the possibility to start with a blank canvas is rare (not impossible, but rare).</p><p>This is also the case for Kotlin Multiplatform (I’ll call it KMP in the rest of the article).</p><p>When starting a new blank KMP project it is easier to have a mono-repo structure like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>.
└── kmm-project
    ├── androidApp
    ├── iosApp
    └── shared
</code></pre></td></tr></table></div></div><p>However, existing projects most likely don’t have a mono-repo structure. And making a refactor to achieve this structure can be extremely difficult for time or management constraints. But KMP is built around the concept of sharing as much non-UI code as possible, and it is possible to start sharing a little piece of tech stack. Then, this “little piece of tech stack” will be served to the existing projects as a library.</p><p>Where to start from is subjective and it depends on the specific project, but there are some parts that better suit this topic. For example, all the boilerplate code (constants, data models, DTOs, etc), that is boring to write and is more error-prone. Or it could be a feature that centralizes the source of truth (e.g. if a field is nullable or not) because with a single source of truth there will also be a single point of failure. Or it could be some utility or analytics helper that every project has.</p><p>An important thing to take in mind is that all the features chosen for sharing must have the possibility to be extracted gradually. That’s because, during the evaluation process of KMP, it is better to make a final decision without using too much time. For example, it will be not a good idea to start sharing the entire network layer because you will risk ending up with useless work if KMP is not the right solution for the project. Otherwise, starting with some small features like a DTO or a data model will require less “extraction time” and it will leave enough time to work on the architecture needed to have a Kotlin Multiplatform library in an existing project.</p><p>For example, at <a href=https://www.uniwhere.com/ target=_blank rel="noopener noreffer">Uniwhere</a> we have decided to start with some DTOs and after validating the process, we have migrated all the others.</p><h2 id=publishing-architecture>Publishing Architecture</h2><p>The architecture of an existing project with Kotlin Multiplatform will look like this:</p><figure><a href=/img/kmp-existing-project/kmp-publish-arch.png><img src=/img/kmp-existing-projects/kmp-publish-arch.png></a></figure><p>There is a repository for every platform:</p><ul><li>a repository for the KMP library;</li><li>a repository for the Backend;</li><li>a repository for the Android app;</li><li>a repository for the iOS app.</li></ul><p>As mentioned early on, the KMP code is served as a library. The compiler generates a <em>.jar</em> for the JVM, a <em>.aar</em> for Android, and a <em>Framework</em> for iOs. The <em>.jar</em> and the <em>.aar</em> can be published in a <em>Maven</em> repository. A <em>Framework</em> can be published in different places: for example in a <em><a href=https://cocoapods.org/ target=_blank rel="noopener noreffer">CocoaPods</a></em> repository, in the <a href=https://swift.org/package-manager/ target=_blank rel="noopener noreffer">Swift Package Manager</a> or with <a href=https://github.com/Carthage/Carthage target=_blank rel="noopener noreffer">Carthage</a>. Since I’m familiar with CocoaPods (and because we are using it at Uniwhere), I’ve decided to stick with it.</p><h3 id=publishing-for-android-and-the-jvm>Publishing for Android and the JVM</h3><p>The amount of work needed to publish a JVM and an Android library to Maven is pretty straightforward, thanks to the <a href=https://docs.gradle.org/current/userguide/publishing_maven.html target=_blank rel="noopener noreffer">Maven Publish Plugin</a>.
Only a few lines of configuration on the <em>build.gradle.kts</em> file, are necessary (here I’m assuming that you have already configured a Maven repository since it’s not the scope of the article to explain how. Otherwise, you can use a local Maven repository on your computer that does not require any kind of configuration):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>plugins</span> <span class=p>{</span>
    <span class=c1>//...
</span><span class=c1></span>    <span class=n>id</span><span class=p>(</span><span class=s>&#34;maven-publish&#34;</span><span class=p>)</span>
<span class=p>}</span>

<span class=n>group</span> <span class=p>=</span> <span class=s>&#34;&lt;your-group-id&gt;&#34;</span>
<span class=n>artifactId</span> <span class=p>=</span> <span class=s>&#34;&lt;your-library-name&gt;&#34;</span> <span class=c1>// If not specified, it will use the name of the project
</span><span class=c1></span><span class=n>version</span> <span class=p>=</span> <span class=s>&#34;&lt;version-name&gt;&#34;</span>

<span class=c1>// This block is only needed to publish on a online maven repo
</span><span class=c1></span><span class=n>publishing</span> <span class=p>{</span>
    <span class=n>repositories</span> <span class=p>{</span>
        <span class=n>maven</span><span class=p>{</span>
            <span class=n>credentials</span> <span class=p>{</span>
                <span class=n>username</span> <span class=p>=</span> <span class=s>&#34;&lt;username&gt;&#34;</span>
                <span class=n>password</span> <span class=p>=</span> <span class=s>&#34;&lt;pwd&gt;&#34;</span>
            <span class=p>}</span>
            <span class=n>url</span> <span class=p>=</span> <span class=n>url</span><span class=p>(</span><span class=s>&#34;https://mymavenrepo.com&#34;</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><p>After that, it is possible to build and publish the KMP library with the <code>./gradlew publish</code> command (or with <code>./gradlew publishToMavenLocal</code>).</p><p>Then, it is possible to pull the library on Android:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>implementation</span><span class=p>(</span><span class=s>&#34;&lt;your-group-id&gt;:&lt;your-library-name&gt;-android:&lt;version-name&gt;&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>and on the JVM project:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>implementation</span><span class=p>(</span><span class=s>&#34;&lt;your-group-id&gt;:&lt;your-library-name&gt;-jvm:&lt;version-name&gt;&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><h3 id=publishing-for-ios>Publishing for iOs</h3><blockquote><p>On iOS things are harder.</p></blockquote><h4 id=pack-for-xcode>Pack for Xcode</h4><p>On newly created KMP projects, there is a Gradle task, named <strong><code>packForXcode</code></strong>, that automatically builds the framework and places it in a specific build folder.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>val</span> <span class=py>packForXcode</span> <span class=k>by</span> <span class=n>tasks</span><span class=p>.</span><span class=n>creating</span><span class=p>(</span><span class=n>Sync</span><span class=o>::</span><span class=k>class</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>group</span> <span class=p>=</span> <span class=s>&#34;build&#34;</span>
    <span class=k>val</span> <span class=py>mode</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>getenv</span><span class=p>(</span><span class=s>&#34;CONFIGURATION&#34;</span><span class=p>)</span> <span class=o>?:</span> <span class=s>&#34;DEBUG&#34;</span>
    <span class=k>val</span> <span class=py>sdkName</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>getenv</span><span class=p>(</span><span class=s>&#34;SDK_NAME&#34;</span><span class=p>)</span> <span class=o>?:</span> <span class=s>&#34;iphonesimulator&#34;</span>
    <span class=k>val</span> <span class=py>targetName</span> <span class=p>=</span> <span class=s>&#34;ios&#34;</span> <span class=p>+</span> <span class=k>if</span> <span class=p>(</span><span class=n>sdkName</span><span class=p>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s>&#34;iphoneos&#34;</span><span class=p>))</span> <span class=s>&#34;Arm64&#34;</span> <span class=k>else</span> <span class=s>&#34;X64&#34;</span>
    <span class=k>val</span> <span class=py>framework</span> <span class=p>=</span> <span class=n>kotlin</span><span class=p>.</span><span class=n>targets</span><span class=p>.</span><span class=n>getByName</span><span class=p>&lt;</span><span class=n>KotlinNativeTarget</span><span class=p>&gt;(</span><span class=n>targetName</span><span class=p>).</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span>
    <span class=n>inputs</span><span class=p>.</span><span class=n>property</span><span class=p>(</span><span class=s>&#34;mode&#34;</span><span class=p>,</span> <span class=n>mode</span><span class=p>)</span>
    <span class=n>dependsOn</span><span class=p>(</span><span class=n>framework</span><span class=p>.</span><span class=n>linkTask</span><span class=p>)</span>
    <span class=k>val</span> <span class=py>targetDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=n>buildDir</span><span class=p>,</span> <span class=s>&#34;xcode-frameworks&#34;</span><span class=p>)</span>
    <span class=n>from</span><span class=p>({</span> <span class=n>framework</span><span class=p>.</span><span class=n>outputDirectory</span> <span class=p>})</span>
    <span class=n>into</span><span class=p>(</span><span class=n>targetDir</span><span class=p>)</span>
<span class=p>}</span>
<span class=n>tasks</span><span class=p>.</span><span class=n>getByName</span><span class=p>(</span><span class=s>&#34;build&#34;</span><span class=p>).</span><span class=n>dependsOn</span><span class=p>(</span><span class=n>packForXcode</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>This task is automatically called by Xcode when the iOS (or macOS) application is built.</p><figure><a href=/img/kmp-existing-projects/build-script-xcode.png><img src=/img/kmp-existing-projects/build-script-xcode.png></a></figure><p>The task uses the configuration of the iOS project to define the build mode and the target architecture.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>val</span> <span class=py>mode</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>getenv</span><span class=p>(</span><span class=s>&#34;CONFIGURATION&#34;</span><span class=p>)</span> <span class=o>?:</span> <span class=s>&#34;DEBUG&#34;</span>
<span class=k>val</span> <span class=py>sdkName</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>getenv</span><span class=p>(</span><span class=s>&#34;SDK_NAME&#34;</span><span class=p>)</span> <span class=o>?:</span> <span class=s>&#34;iphonesimulator&#34;</span>
<span class=k>val</span> <span class=py>targetName</span> <span class=p>=</span> <span class=s>&#34;ios&#34;</span> <span class=p>+</span> <span class=k>if</span> <span class=p>(</span><span class=n>sdkName</span><span class=p>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s>&#34;iphoneos&#34;</span><span class=p>))</span> <span class=s>&#34;Arm64&#34;</span> <span class=k>else</span> <span class=s>&#34;X64&#34;</span>
</code></pre></td></tr></table></div></div><p>The build mode can be <code>RELEASE</code> or <code>DEBUG</code> while the target name depends on the architecture which we are building for. The real devices use the <em>Arm64</em> architecture, while the simulator uses the host computer architecture which in most of the cases is <em>X64</em> (at least until when Apple Silicon will be sufficiently spread).</p><p>And this is the problem of this task!</p><p>Since the aim is to publish a framework to be used by an existing project, it’s impossible to know a priori which architecture is necessary or the build mode.</p><h4 id=cocoapods-gradle-plugin>CocoaPods Gradle Plugin</h4><p>Another way to build a framework from the KMP code is using the <a href=https://kotlinlang.org/docs/reference/native/cocoapods.html target=_blank rel="noopener noreffer">CocoaPods Gradle Plugin</a>. This plugin builds the framework and places it inside a CocoaPods repository that will be added as dependency on Xcode (The plugin can be used also to add other Pod libraries on the native target).</p><p>To start using the plugin, some configurations are necessary:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>plugins</span> <span class=p>{</span>
     <span class=n>kotlin</span><span class=p>(</span><span class=s>&#34;multiplatform&#34;</span><span class=p>)</span> <span class=n>version</span> <span class=s>&#34;1.4.10&#34;</span>
     <span class=n>kotlin</span><span class=p>(</span><span class=s>&#34;native.cocoapods&#34;</span><span class=p>)</span> <span class=n>version</span> <span class=s>&#34;1.4.10&#34;</span>
 <span class=p>}</span>

 <span class=c1>// CocoaPods requires the podspec to have a version.
</span><span class=c1></span> <span class=n>version</span> <span class=p>=</span> <span class=s>&#34;1.0&#34;</span>

 <span class=n>kotlin</span> <span class=p>{</span>
     <span class=n>cocoapods</span> <span class=p>{</span>
         <span class=c1>// Configure fields required by CocoaPods.
</span><span class=c1></span>         <span class=n>summary</span> <span class=p>=</span> <span class=s>&#34;Some description for a Kotlin/Native module&#34;</span>
         <span class=n>homepage</span> <span class=p>=</span> <span class=s>&#34;Link to a Kotlin/Native module homepage&#34;</span>

         <span class=c1>// You can change the name of the produced framework.
</span><span class=c1></span>         <span class=c1>// By default, it is the name of the Gradle project.
</span><span class=c1></span>         <span class=n>frameworkName</span> <span class=p>=</span> <span class=s>&#34;&lt;framework-name&gt;&#34;</span>
     <span class=p>}</span>
 <span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Then, during the build, the <a href=https://guides.cocoapods.org/syntax/podspec.html target=_blank rel="noopener noreffer">Podspec file</a> (a file that describes the Pod library - it contains the name, version, and description, where the source should be fetched from, what files to use, the build settings to apply, etc) is generated starting from the information provided in the <code>cocoapods</code> block.</p><p>The Podspec contains also a script that is automatically added as a build script, called every time the iOS application is built, like <code>packForXcode</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>spec</span><span class=o>.</span><span class=n>script_phases</span> <span class=o>=</span> <span class=o>[</span>
    <span class=p>{</span>
        <span class=ss>:name</span> <span class=o>=&gt;</span> <span class=s1>&#39;Build shared&#39;</span><span class=p>,</span>
        <span class=ss>:execution_position</span> <span class=o>=&gt;</span> <span class=ss>:before_compile</span><span class=p>,</span>
        <span class=ss>:shell_path</span> <span class=o>=&gt;</span> <span class=s1>&#39;/bin/sh&#39;</span><span class=p>,</span>
        <span class=ss>:script</span> <span class=o>=&gt;</span> <span class=s>&lt;&lt;-SCRIPT
</span><span class=s></span>            <span class=n>set</span> <span class=o>-</span><span class=n>ev</span>
            <span class=no>REPO_ROOT</span><span class=o>=</span><span class=s2>&#34;$PODS_TARGET_SRCROOT&#34;</span>
            <span class=s2>&#34;$REPO_ROOT/../gradlew&#34;</span> <span class=o>-</span><span class=nb>p</span> <span class=s2>&#34;$REPO_ROOT&#34;</span> <span class=ss>:shared:syncFramework</span> <span class=p>\</span>
                <span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>target</span><span class=o>=</span><span class=vg>$KOTLIN_TARGET</span> <span class=p>\</span>
                <span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>configuration</span><span class=o>=</span><span class=vg>$CONFIGURATION</span> <span class=p>\</span>
                <span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>cflags</span><span class=o>=</span><span class=s2>&#34;$OTHER_CFLAGS&#34;</span> <span class=p>\</span>
                <span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>paths</span><span class=o>.</span><span class=n>headers</span><span class=o>=</span><span class=s2>&#34;$HEADER_SEARCH_PATHS&#34;</span> <span class=p>\</span>
                <span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>paths</span><span class=o>.</span><span class=n>frameworks</span><span class=o>=</span><span class=s2>&#34;$FRAMEWORK_SEARCH_PATHS&#34;</span>
        <span class=no>SCRIPT</span>
    <span class=p>}</span>
<span class=o>]</span>
</code></pre></td></tr></table></div></div><p>Unfortunately, this script has the same problems as <code>packForXcode</code>, because the configuration and the target architecture are computed during the build phase.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>target</span><span class=o>=</span><span class=vg>$KOTLIN_TARGET</span> <span class=p>\</span>
<span class=o>-</span><span class=no>Pkotlin</span><span class=o>.</span><span class=n>native</span><span class=o>.</span><span class=n>cocoapods</span><span class=o>.</span><span class=n>configuration</span><span class=o>=</span><span class=vg>$CONFIGURATION</span> <span class=p>\</span>
</code></pre></td></tr></table></div></div><p>So, also the CocoaPods Gradle Plugin can’t be used.</p><h4 id=fat-framework>Fat Framework</h4><p>The solution is to use a Fat Framework that contains the code for every required architecture. To build it, there is a Gradle task named <code>FatFrameworkTask</code> that can be customized to meet the specific needs.</p><p>The first step is building a custom Gradle task to build a debug version of the Fat Framework.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>tasks</span> <span class=p>{</span>
    <span class=n>register</span><span class=p>(</span><span class=s>&#34;universalFrameworkDebug&#34;</span><span class=p>,</span> <span class=n>org</span><span class=p>.</span><span class=n>jetbrains</span><span class=p>.</span><span class=n>kotlin</span><span class=p>.</span><span class=n>gradle</span><span class=p>.</span><span class=n>tasks</span><span class=p>.</span><span class=n>FatFrameworkTask</span><span class=o>::</span><span class=k>class</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>baseName</span> <span class=p>=</span> <span class=n>libName</span>
        <span class=n>from</span><span class=p>(</span>
            <span class=n>iosArm64</span><span class=p>().</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=s>&#34;&lt;your-library-name&gt;&#34;</span><span class=p>,</span> <span class=s>&#34;Debug&#34;</span><span class=p>),</span>
            <span class=n>iosX64</span><span class=p>().</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=s>&#34;&lt;your-library-name&gt;&#34;</span><span class=p>,</span> <span class=s>&#34;Debug&#34;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>destinationDir</span> <span class=p>=</span> <span class=n>buildDir</span><span class=p>.</span><span class=n>resolve</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
        <span class=n>group</span> <span class=p>=</span> <span class=s>&#34;&lt;your-library-name&gt;&#34;</span>
        <span class=n>description</span> <span class=p>=</span> <span class=s>&#34;Create the debug fat framework for iOs&#34;</span>
        <span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;link&lt;your-library-name&gt;DebugFrameworkIosArm64&#34;</span><span class=p>)</span>
        <span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;link&lt;your-library-name&gt;DebugFrameworkIosX64&#34;</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>        
</code></pre></td></tr></table></div></div><p>This custom Gradle task, named <code>universalFrameworkDebug</code> is necessary to provide some customizations to the <code>FatFrameworkTask</code>. After some cosmetic info, like the name and the group of the Framework, the required architectures and configurations must be provided. In this case, the required architectures are <em>x64</em> for the simulator and <em>arm64</em> for the real devices. The configuration instead is <code>Debug</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>from</span><span class=p>(</span>
    <span class=n>iosArm64</span><span class=p>().</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=s>&#34;&lt;your-library-name&gt;&#34;</span><span class=p>,</span> <span class=s>&#34;Debug&#34;</span><span class=p>),</span>
    <span class=n>iosX64</span><span class=p>().</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=s>&#34;&lt;your-library-name&gt;&#34;</span><span class=p>,</span> <span class=s>&#34;Debug&#34;</span><span class=p>)</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><p>The last needed information is the destination of the framework.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>destinationDir</span> <span class=p>=</span> <span class=n>buildDir</span><span class=p>.</span><span class=n>resolve</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>The destination will be a CocoaPods repository that at the end is a git repository that contains the framework, the debug symbols, and a Podspec file.</p><figure><a href=/img/kmp-existing-projects/cocoa-repo-git.png><img src=/img/kmp-existing-projects/cocoa-repo-git.png alt="An example of a CocoaPod repo hosted on a git repo"></a><figcaption><p>An example of a CocoaPod repo hosted on a git repo</p></figcaption></figure><p>The git repository uses branches and tagging for handling debug and release versions. The debug versions of the Framework are pushed directly to the develop branch without any tagging. The release version instead is pushed on master and tagged.</p><p>For more information about setting up a private CocoaPod repo, I suggest you give a look at the <a href=https://guides.cocoapods.org/making/private-cocoapods.html target=_blank rel="noopener noreffer">official documentation</a>.</p><p>After pushing the changes on git, the Pod library is ready to be pulled by XCode. On the <code>Podfile</code> of the iOs project, is necessary to specify the Pod library with the information about the source and the version.</p><p>For debug releases, it is enough to specify to pull the latest version from the <code>develop</code> branch</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>pod</span> <span class=s1>&#39;&lt;your-library-name&gt;&#39;</span><span class=p>,</span> <span class=ss>:git</span> <span class=o>=&gt;</span> <span class=s2>&#34;git@github.com:&lt;git-username&gt;/&lt;repo-name&gt;.git&#34;</span><span class=p>,</span> <span class=ss>:branch</span> <span class=o>=&gt;</span> <span class=s1>&#39;develop&#39;</span>
</code></pre></td></tr></table></div></div><p>For production releases instead, it is better to specify the required version number.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>pod</span> <span class=s1>&#39;&lt;your-library-name&gt;&#39;</span><span class=p>,</span> <span class=ss>:git</span> <span class=o>=&gt;</span> <span class=s2>&#34;git@github.com:&lt;git-username&gt;/&lt;repo-name&gt;.git&#34;</span><span class=p>,</span> <span class=ss>:tag</span> <span class=o>=&gt;</span> <span class=s1>&#39;&lt;version-number&gt;&#39;</span>
</code></pre></td></tr></table></div></div><p>The last step is building another Gradle task, to build a release version of the Fat Framework.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>tasks</span> <span class=p>{</span>
    <span class=n>register</span><span class=p>(</span><span class=s>&#34;universalFrameworkRelease&#34;</span><span class=p>,</span> <span class=n>org</span><span class=p>.</span><span class=n>jetbrains</span><span class=p>.</span><span class=n>kotlin</span><span class=p>.</span><span class=n>gradle</span><span class=p>.</span><span class=n>tasks</span><span class=p>.</span><span class=n>FatFrameworkTask</span><span class=o>::</span><span class=k>class</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>baseName</span> <span class=p>=</span> <span class=n>libName</span>
        <span class=n>from</span><span class=p>(</span>
            <span class=n>iosArm64</span><span class=p>().</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=s>&#34;&lt;your-library-name&gt;&#34;</span><span class=p>,</span> <span class=s>&#34;Release&#34;</span><span class=p>),</span>
            <span class=n>iosX64</span><span class=p>().</span><span class=n>binaries</span><span class=p>.</span><span class=n>getFramework</span><span class=p>(</span><span class=s>&#34;&lt;your-library-name&gt;&#34;</span><span class=p>,</span> <span class=s>&#34;Release&#34;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>destinationDir</span> <span class=p>=</span> <span class=n>buildDir</span><span class=p>.</span><span class=n>resolve</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
        <span class=n>group</span> <span class=p>=</span> <span class=s>&#34;&lt;your-library-name&gt;&#34;</span>
        <span class=n>description</span> <span class=p>=</span> <span class=s>&#34;Create the debug fat framework for iOs&#34;</span>
        <span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;link&lt;your-library-name&gt;ReleaseFrameworkIosArm64&#34;</span><span class=p>)</span>
        <span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;link&lt;your-library-name&gt;ReleaseFrameworkIosX64&#34;</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>        
</code></pre></td></tr></table></div></div><p>The script is the same as the previous one, with the exception that the target is changed from <code>Debug</code> to <code>Release</code>.</p><p>And, that’s it! Finally, it is possible to start using the KMP library on iOS as well.</p><p>However, there is room for improvement and I wanted to minimize the effort of publishing. All the steps for publishing the framework in the CocoaPods repository can be automated with a Gradle task.</p><p>The <code>publishDevFramework</code> task will build the framework and automatically publish the changes in the develop branch of the CocoaPods repository.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>tasks</span> <span class=p>{</span>
    <span class=n>register</span><span class=p>(</span><span class=s>&#34;publishDevFramework&#34;</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>description</span> <span class=p>=</span> <span class=s>&#34;Publish iOs framweork to the Cocoa Repo&#34;</span>
    
        <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
            <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
            <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;checkout&#34;</span><span class=p>,</span> <span class=s>&#34;develop&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
        <span class=p>}</span>
    
        <span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;universalFrameworkDebug&#34;</span><span class=p>)</span>
    
        <span class=n>doLast</span> <span class=p>{</span>
            <span class=k>val</span> <span class=py>dir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;/&lt;your-library-name&gt;.podspec&#34;</span><span class=p>)</span>
            <span class=k>val</span> <span class=py>tempFile</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;/&lt;your-library-name&gt;.podspec.new&#34;</span><span class=p>)</span>
    
            <span class=k>val</span> <span class=py>reader</span> <span class=p>=</span> <span class=n>dir</span><span class=p>.</span><span class=n>bufferedReader</span><span class=p>()</span>
            <span class=k>val</span> <span class=py>writer</span> <span class=p>=</span> <span class=n>tempFile</span><span class=p>.</span><span class=n>bufferedWriter</span><span class=p>()</span>
            <span class=k>var</span> <span class=py>currentLine</span><span class=p>:</span> <span class=n>String</span><span class=p>?</span>
    
            <span class=k>while</span> <span class=p>(</span><span class=n>reader</span><span class=p>.</span><span class=n>readLine</span><span class=p>().</span><span class=n>also</span> <span class=p>{</span> <span class=n>currLine</span> <span class=p>-&gt;</span> <span class=n>currentLine</span> <span class=p>=</span> <span class=n>currLine</span> <span class=p>}</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>currentLine</span><span class=o>?.</span><span class=n>startsWith</span><span class=p>(</span><span class=s>&#34;s.version&#34;</span><span class=p>)</span> <span class=p>==</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>writer</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=s>&#34;s.version       = \&#34;${libVersionName}\&#34;&#34;</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>lineSeparator</span><span class=p>())</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=n>writer</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>currentLine</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>lineSeparator</span><span class=p>())</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=n>writer</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
            <span class=n>reader</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
            <span class=k>val</span> <span class=py>successful</span> <span class=p>=</span> <span class=n>tempFile</span><span class=p>.</span><span class=n>renameTo</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span>
    
            <span class=k>if</span> <span class=p>(</span><span class=n>successful</span><span class=p>)</span> <span class=p>{</span>
    
                <span class=k>val</span> <span class=py>dateFormatter</span> <span class=p>=</span> <span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;dd/MM/yyyy - HH:mm&#34;</span><span class=p>,</span> <span class=n>Locale</span><span class=p>.</span><span class=n>getDefault</span><span class=p>())</span>
                <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
                    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
                    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;commit&#34;</span><span class=p>,</span> <span class=s>&#34;-a&#34;</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;\&#34;New dev release: ${libVersionName}-${dateFormatter.format(Date())}\&#34;&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
                <span class=p>}</span>
    
                <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
                    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
                    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;push&#34;</span><span class=p>,</span> <span class=s>&#34;origin&#34;</span><span class=p>,</span> <span class=s>&#34;develop&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>First of all, the task changes the working branch and then builds the debug framework.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;checkout&#34;</span><span class=p>,</span> <span class=s>&#34;develop&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>

<span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;universalFrameworkDebug&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Before publishing the new version, the version name inside the Podspec file must be updated.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=o>...</span>
<span class=n>s</span><span class=o>.</span><span class=n>name</span>          <span class=o>=</span> <span class=s2>&#34;&lt;your-library-name&#34;</span>
<span class=n>s</span><span class=o>.</span><span class=n>version</span>       <span class=o>=</span> <span class=s2>&#34;&lt;version-name&gt;&#34;</span>
<span class=o>...</span>
</code></pre></td></tr></table></div></div><p>And this is done automatically by the task.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>val</span> <span class=py>dir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;/&lt;your-library-name&gt;.podspec&#34;</span><span class=p>)</span>
<span class=p>...</span>
<span class=k>if</span> <span class=p>(</span><span class=n>currentLine</span><span class=o>?.</span><span class=n>startsWith</span><span class=p>(</span><span class=s>&#34;s.version&#34;</span><span class=p>)</span> <span class=p>==</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>writer</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=s>&#34;s.version       = \&#34;${libVersionName}\&#34;&#34;</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>lineSeparator</span><span class=p>())</span>
<span class=p>}</span> 
</code></pre></td></tr></table></div></div><p>And at the end, the new changes are committed and published into the develop branch of the repository.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>val</span> <span class=py>dateFormatter</span> <span class=p>=</span> <span class=n>SimpleDateFormat</span><span class=p>(</span><span class=s>&#34;dd/MM/yyyy - HH:mm&#34;</span><span class=p>,</span> <span class=n>Locale</span><span class=p>.</span><span class=n>getDefault</span><span class=p>())</span>
<span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;commit&#34;</span><span class=p>,</span> <span class=s>&#34;-a&#34;</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;\&#34;New dev release: ${libVersionName}-${dateFormatter.format(Date())}\&#34;&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>
    
<span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;push&#34;</span><span class=p>,</span> <span class=s>&#34;origin&#34;</span><span class=p>,</span> <span class=s>&#34;develop&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>To publish a release version of the Framework, there is the <code>publishFramework</code> task.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>tasks</span> <span class=p>{</span>
    <span class=n>register</span><span class=p>(</span><span class=s>&#34;publishFramework&#34;</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>description</span> <span class=p>=</span> <span class=s>&#34;Publish iOs framework to the Cocoa Repo&#34;</span>
    
        <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
            <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
            <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;checkout&#34;</span><span class=p>,</span> <span class=s>&#34;master&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
        <span class=p>}</span>
    
        <span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;universalFrameworkRelease&#34;</span><span class=p>)</span>
    
        <span class=n>doLast</span> <span class=p>{</span>
            <span class=k>val</span> <span class=py>dir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;/&lt;your-library-name&gt;.podspec&#34;</span><span class=p>)</span>
            <span class=k>val</span> <span class=py>tempFile</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;/&lt;your-library-name&gt;.podspec.new&#34;</span><span class=p>)</span>
    
            <span class=k>val</span> <span class=py>reader</span> <span class=p>=</span> <span class=n>dir</span><span class=p>.</span><span class=n>bufferedReader</span><span class=p>()</span>
            <span class=k>val</span> <span class=py>writer</span> <span class=p>=</span> <span class=n>tempFile</span><span class=p>.</span><span class=n>bufferedWriter</span><span class=p>()</span>
            <span class=k>var</span> <span class=py>currentLine</span><span class=p>:</span> <span class=n>String</span><span class=p>?</span>
    
            <span class=k>while</span> <span class=p>(</span><span class=n>reader</span><span class=p>.</span><span class=n>readLine</span><span class=p>().</span><span class=n>also</span> <span class=p>{</span> <span class=n>currLine</span> <span class=p>-&gt;</span> <span class=n>currentLine</span> <span class=p>=</span> <span class=n>currLine</span> <span class=p>}</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>currentLine</span><span class=o>?.</span><span class=n>startsWith</span><span class=p>(</span><span class=s>&#34;s.version&#34;</span><span class=p>)</span> <span class=p>==</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>writer</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=s>&#34;s.version       = \&#34;${libVersionName}\&#34;&#34;</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>lineSeparator</span><span class=p>())</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=n>writer</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>currentLine</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>lineSeparator</span><span class=p>())</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=n>writer</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
            <span class=n>reader</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
            <span class=k>val</span> <span class=py>successful</span> <span class=p>=</span> <span class=n>tempFile</span><span class=p>.</span><span class=n>renameTo</span><span class=p>(</span><span class=n>dir</span><span class=p>)</span>
    
            <span class=k>if</span> <span class=p>(</span><span class=n>successful</span><span class=p>)</span> <span class=p>{</span>
    
                <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
                    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
                    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;commit&#34;</span><span class=p>,</span> <span class=s>&#34;-a&#34;</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;\&#34;New release: ${libVersionName}\&#34;&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
                <span class=p>}</span>
    
                <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
                    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
                    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;tag&#34;</span><span class=p>,</span> <span class=n>libVersionName</span><span class=p>).</span><span class=n>standardOutput</span>
                <span class=p>}</span>
    
                <span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
                    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;$rootDir/../../hn-foundation-cocoa&#34;</span><span class=p>)</span>
                    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;push&#34;</span><span class=p>,</span> <span class=s>&#34;origin&#34;</span><span class=p>,</span> <span class=s>&#34;master&#34;</span><span class=p>,</span> <span class=s>&#34;--tags&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>This task is very similar to the <code>publishDevFramework</code> task. First of all, since it is a release, the master branch will be used.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;checkout&#34;</span><span class=p>,</span> <span class=s>&#34;master&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>

<span class=n>dependsOn</span><span class=p>(</span><span class=s>&#34;universalFrameworkRelease&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>Then, before publishing, the commit will be tagged to specify the version name of the release.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;commit&#34;</span><span class=p>,</span> <span class=s>&#34;-a&#34;</span><span class=p>,</span> <span class=s>&#34;-m&#34;</span><span class=p>,</span> <span class=s>&#34;\&#34;New release: ${libVersionName}\&#34;&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>
    
<span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;&lt;fat-framework-destination&gt;&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;tag&#34;</span><span class=p>,</span> <span class=n>libVersionName</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>
    
<span class=n>project</span><span class=p>.</span><span class=n>exec</span> <span class=p>{</span>
    <span class=n>workingDir</span> <span class=p>=</span> <span class=n>File</span><span class=p>(</span><span class=s>&#34;$rootDir/../../hn-foundation-cocoa&#34;</span><span class=p>)</span>
    <span class=n>commandLine</span><span class=p>(</span><span class=s>&#34;git&#34;</span><span class=p>,</span> <span class=s>&#34;push&#34;</span><span class=p>,</span> <span class=s>&#34;origin&#34;</span><span class=p>,</span> <span class=s>&#34;master&#34;</span><span class=p>,</span> <span class=s>&#34;--tags&#34;</span><span class=p>).</span><span class=n>standardOutput</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>And, that’s it! When the KMP library is ready to be published, three tasks can ben called:</p><ul><li><code>publish</code> to publish JVM and Android artifacts;</li><li><code>publishDevFramework</code> to publish a debug version of the iOs Framework;</li><li><code>publishFramework</code> to publish a release version of the iOs Framework.</li></ul><h2 id=conclusions>Conclusions</h2><p>As shown in this article, the process of integrating Kotlin Multiplatform in an existing project requires more work on the architecture side. That’s why is preferable to start sharing a feature that can be extracted gradually.</p><p>The framework to follow is:</p><blockquote><p>Start little and then go bigger.</p></blockquote><p>By starting little, it is possible to validate the process with a “contained” effort, and then, after the validation, it is possible to go bigger and start sharing more and more features. For example at Uniwhere, we started sharing the DTOs and after validating the process, we decided to share also the persistence layer with <a href=https://cashapp.github.io/sqldelight/ target=_blank rel="noopener noreffer">SQLDelight</a>.</p><p>All the code that I showed in this article came from <a href=https://github.com/prof18/shared-hn-android-ios-backend target=_blank rel="noopener noreffer">a sample that I’ve published on GitHub</a> (if you are interested only in the custom Gradle task, <a href=https://github.com/prof18/shared-hn-android-ios-backend/blob/master/hn-foundation/build.gradle.kts#L99 target=_blank rel="noopener noreffer">click here</a>). This sample is composed of an Android app, an iOs app, and a backend that share some common code via a Kotlin Multiplatform library.</p><blockquote><p>Update: I’ve grouped all the tasks mentioned in the article in a Gradle plugin! To know more about it, give a look to <a href=https://www.marcogomiero.com/posts/2021/kmp-fatframework-cocoa-release/ target=_blank rel="noopener noreffer">this post</a>.</p></blockquote><h2 id=bonus>Bonus:</h2><p>I’ve spoke about this topic in a talk <a href=https://fosdem.org/2021/schedule/event/and_that_folks_is_how_we_shared_code/ target=_blank rel="noopener noreffer">in the Kotlin Dev Room at Fosdem 2021</a>.</p><p>Here’s the recording of the session:</p><br><video controls width=100%>
<source src=https://mirror.as35701.net/video.fosdem.org/2021/D.kotlin/and_that_folks_is_how_we_shared_code.webm type=video/webm></video><p>and the slides:</p><br><script async class=speakerdeck-embed data-id=e29e5d5369894442a23544dc6feb4b4c data-ratio=1.77777777777778 src=//speakerdeck.com/assets/embed.js></script></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.marcogomiero.com/posts/2021/kmp-existing-project/ data-title="Introducing Kotlin Multiplatform in an existing project" data-via=marcoGomier><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://www.marcogomiero.com/posts/2021/kmp-existing-project/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.marcogomiero.com/posts/2021/kmp-existing-project/ data-title="Introducing Kotlin Multiplatform in an existing project"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://www.marcogomiero.com/posts/2021/kmp-existing-project/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2021/move-libray-jcenter-to-maven/ class=prev rel=prev title="Migrating old artifacts from JCenter to MavenCentral"><i class="fas fa-angle-left fa-fw"></i>Migrating old artifacts from JCenter to MavenCentral</a>
<a href=/posts/2021/kmp-fatframework-cocoa-release/ class=next rel=next title="Introducing KMP FatFramework Cocoa, a Gradle plugin for iOS FatFramework">Introducing KMP FatFramework Cocoa, a Gradle plugin for iOS FatFramework<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://www.marcogomiero.com/ target=_blank>Marco Gomiero</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":100000},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-90975904-1 ',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-90975904-1%20" async></script></body></html>