<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30 | Marco Gomiero</title><meta name=keywords content><meta name=description content="A few days ago, Kotlin 1.5.30 has been released. One of the features contained in the release is the official support for XCFrameworks on Kotlin Multiplatform.
XCFramework is a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time). It has been introduced by Apple during the WWDC 2019 as a replacement for FatFrameworks.
Before Kotlin 1.5.30, an XCFramework could be created only by running the xcrun command that will pack the frameworks for every different required platform into an XCFramework."><meta name=author content="Marco Gomiero"><link rel=canonical href=https://www.marcogomiero.com/posts/2021/kmp-xcframework-official-support/><link crossorigin=anonymous href=/assets/css/stylesheet.min.686715e54e31dbf63447efd76235e41e047fd8826df608657b7b0ddb3a0d900d.css integrity="sha256-aGcV5U4x2/Y0R+/XYjXkHgR/2IJt9ghle3sN2zoNkA0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.marcogomiero.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.marcogomiero.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.marcogomiero.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.marcogomiero.com/apple-touch-icon.png><link rel=mask-icon href=https://www.marcogomiero.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-69FZ1TLE7E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-69FZ1TLE7E",{anonymize_ip:!1})}</script><meta property="og:title" content="Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30"><meta property="og:description" content="A few days ago, Kotlin 1.5.30 has been released. One of the features contained in the release is the official support for XCFrameworks on Kotlin Multiplatform.
XCFramework is a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time). It has been introduced by Apple during the WWDC 2019 as a replacement for FatFrameworks.
Before Kotlin 1.5.30, an XCFramework could be created only by running the xcrun command that will pack the frameworks for every different required platform into an XCFramework."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2021/kmp-xcframework-official-support/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-30T00:00:00+00:00"><meta property="article:modified_time" content="2021-08-30T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30"><meta name=twitter:description content="A few days ago, Kotlin 1.5.30 has been released. One of the features contained in the release is the official support for XCFrameworks on Kotlin Multiplatform.
XCFramework is a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time). It has been introduced by Apple during the WWDC 2019 as a replacement for FatFrameworks.
Before Kotlin 1.5.30, an XCFramework could be created only by running the xcrun command that will pack the frameworks for every different required platform into an XCFramework."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.marcogomiero.com/posts/"},{"@type":"ListItem","position":3,"name":"Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30","item":"https://www.marcogomiero.com/posts/2021/kmp-xcframework-official-support/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30","name":"Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30","description":"A few days ago, Kotlin 1.5.30 has been released. One of the features contained in the release is the official support for XCFrameworks on Kotlin Multiplatform.\nXCFramework is a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time). It has been introduced by Apple during the WWDC 2019 as a replacement for FatFrameworks.\nBefore Kotlin 1.5.30, an XCFramework could be created only by running the xcrun command that will pack the frameworks for every different required platform into an XCFramework.","keywords":[],"articleBody":" A few days ago, Kotlin 1.5.30 has been released. One of the features contained in the release is the official support for XCFrameworks on Kotlin Multiplatform.\nXCFramework is a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time). It has been introduced by Apple during the WWDC 2019 as a replacement for FatFrameworks.\nBefore Kotlin 1.5.30, an XCFramework could be created only by running the xcrun command that will pack the frameworks for every different required platform into an XCFramework.\nA few weeks ago, I wrote an article to show how to create two Gradle tasks (buildDebugXCFramework and buildReleaseXCFramework) to automate the building of an XCFramework. With Kotlin 1.5.30 these tasks are not necessary anymore and in this article, I will show you how to replace the custom tasks with the official ones.\nBuild an XCFramework with Kotlin 1.5.30 To start using XCFrameworks, it is necessary to create an XCFramework object inside the kotlin block of the build.gradle.kts file. Then, every Apple target should be added to that object.\nimport org.jetbrains.kotlin.gradle.plugin.mpp.apple.XCFramework val libName = “LibraryName” kotlin { val xcFramework = XCFramework(libName) ios { binaries.framework(libName) { xcFramework.add(this) } } ... } After declaring the XCFramework object, three new tasks are added:\nassemble${libName}XCFramework assemble${libName}DebugXCFramework assemble${libName}ReleaseXCFramework The first one will create both the release and the debug version of the XCFramework, while the others will create only the requested variant.\nThe XCFrameworks are located in the XCFrameworks folder inside the build folder. There will be a subfolder for each of the built variants.\n. ├── build ├── XCFrameworks ├── debug │ └── LibraryName.xcframework └── release └── LibraryName.xcframework Publish an XCFramework The newly built XCFramework can now be distributed. The distribution can be archived in different ways: for example in a CocoaPods repository, in the Swift Package Manager or with Carthage. Since I’m familiar with CocoaPods, that’s what I’ve always used.\nTo make the publishing process as streamlined as possible, I’ve written a bunch of Gradle tasks to automatically build and publish through git the Debug and Release version of the XCFramework. For the details and to understand how the task works, I suggest you give a look at this article that I wrote a few months ago.\nThese tasks are the same used in the article that I wrote a few weeks ago about XCFrameworks. But they must be updated, since the tasks to build the XCFramework are changed.\nPublish Debug Version:\nregister(\"publishDevFramework\") { description = \"Publish iOs framework to the Cocoa Repo\" project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine(\"git\", \"checkout\", \"develop\").standardOutput } dependsOn(\"assemble${libName}DebugXCFramework\") doLast { copy { from(\"$buildDir/XCFrameworks/debug\") into(\"$rootDir/../kmp-xcframework-dest\") } val dir = File(\"$rootDir/../kmp-xcframework-dest/$libName.podspec\") val tempFile = File(\"$rootDir/../kmp-xcframework-dest/$libName.podspec.new\") val reader = dir.bufferedReader() val writer = tempFile.bufferedWriter() var currentLine: String? while (reader.readLine().also { currLine -\u003e currentLine = currLine } != null) { if (currentLine?.startsWith(\"s.version\") == true) { writer.write(\"s.version = \\\"${libVersionName}\\\"\" + System.lineSeparator()) } else { writer.write(currentLine + System.lineSeparator()) } } writer.close() reader.close() val successful = tempFile.renameTo(dir) if (successful) { project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine( \"git\", \"add\", \".\" ).standardOutput } val dateFormatter = SimpleDateFormat(\"dd/MM/yyyy - HH:mm\", Locale.getDefault()) project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine( \"git\", \"commit\", \"-m\", \"\\\"New dev release: ${libVersionName}-${dateFormatter.format(Date())}\\\"\" ).standardOutput } project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine(\"git\", \"push\", \"origin\", \"develop\").standardOutput } } } } The task now depends on the assemble${libName}DebugXCFramework task, which is officially provided by Kotlin. Then, the only thing to do is to move the XCFramework from the build folder to the CocoaPod repository.\ncopy { from(\"$buildDir/XCFrameworks/debug\") into(\"$rootDir/../kmp-xcframework-dest\") } The task that publishes the release version of the XCFramework is pretty much the same as the debug one, except for the task to build the framework, that is assemble${libName}ReleaseXCFramework, and the location in the build folder:\nregister(\"publishFramework\") { description = \"Publish iOs framework to the Cocoa Repo\" project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine(\"git\", \"checkout\", \"master\").standardOutput } // Create Release Framework for Xcode dependsOn(\"assemble${libName}ReleaseXCFramework\") // Replace doLast { copy { from(\"$buildDir/XCFrameworks/release\") into(\"$rootDir/../kmp-xcframework-dest\") } val dir = File(\"$rootDir/../kmp-xcframework-dest/$libName.podspec\") val tempFile = File(\"$rootDir/../kmp-xcframework-dest/$libName.podspec.new\") val reader = dir.bufferedReader() val writer = tempFile.bufferedWriter() var currentLine: String? while (reader.readLine().also { currLine -\u003e currentLine = currLine } != null) { if (currentLine?.startsWith(\"s.version\") == true) { writer.write(\"s.version = \\\"${libVersionName}\\\"\" + System.lineSeparator()) } else { writer.write(currentLine + System.lineSeparator()) } } writer.close() reader.close() val successful = tempFile.renameTo(dir) if (successful) { project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine( \"git\", \"add\", \".\" ).standardOutput } project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine(\"git\", \"commit\", \"-m\", \"\\\"New release: ${libVersionName}\\\"\").standardOutput } project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine(\"git\", \"tag\", libVersionName).standardOutput } project.exec { workingDir = File(\"$rootDir/../kmp-xcframework-dest\") commandLine(\"git\", \"push\", \"origin\", \"master\", \"--tags\").standardOutput } } } } And that’s it! With these little modifications, it is possible to use the official Kotlin support for XCFrameworks and automatically publish them in a CocoaPod repository.\nOn GitHub, I’ve updated the sample project with the new tasks on the kotlin-1.5.30 branch. Instead, if you are interested in XCFramework support before Kotlin 1.5.30, you can look at the pre-kotlin-1.5.30 branch. And to see what are the changes between the two branches, you can look at this commit.\n","wordCount":"829","inLanguage":"en","datePublished":"2021-08-30T00:00:00Z","dateModified":"2021-08-30T00:00:00Z","author":{"@type":"Person","name":"Marco Gomiero"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.marcogomiero.com/posts/2021/kmp-xcframework-official-support/"},"publisher":{"@type":"Organization","name":"Marco Gomiero","logo":{"@type":"ImageObject","url":"https://www.marcogomiero.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.marcogomiero.com accesskey=h title="Marco Gomiero (Alt + H)">Marco Gomiero</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.marcogomiero.com/posts/ title=Write><span>Write</span></a></li><li><a href=https://www.marcogomiero.com/talks/ title=Speak><span>Speak</span></a></li><li><a href=https://www.marcogomiero.com/projects/ title=Build><span>Build</span></a></li><li><a href=https://www.marcogomiero.com/about-me/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Building an XCFramework on Kotlin Multiplatform from Kotlin 1.5.30</h1><div class=post-meta style=margin-top:16px><span title='2021-08-30 00:00:00 +0000 UTC'>30 August 2021</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><div id=banner style=overflow:hidden;justify-content:space-around><div style=display:inline-block><a href=https://mailchi.mp/kotlinweekly/kotlin-weekly-266><img style=margin:0 src=https://img.shields.io/badge/Featured%20in%20kotlinweekly.net-Issue%20%23266-%237874b4></a></div></div><p>A few days ago, <a href=https://kotlinlang.org/docs/whatsnew1530.html>Kotlin 1.5.30 has been released</a>. One of the features contained in the release is the official support for XCFrameworks on Kotlin Multiplatform.</p><p><a href=https://help.apple.com/xcode/mac/11.4/#/dev544efab96>XCFramework</a> is a binary that can contain multiple platform-specific variants (even for iOS and macOS at the same time). It has been introduced by Apple during the <a href=https://developer.apple.com/videos/play/wwdc2019/416/>WWDC 2019</a> as a replacement for FatFrameworks.</p><p>Before Kotlin 1.5.30, an XCFramework could be created only by running the <code>xcrun</code> command that will pack the frameworks for every different required platform into an XCFramework.</p><p>A few weeks ago, I wrote <a href=https://www.marcogomiero.com/posts/2021/build-xcframework-kmp/>an article</a> to show how to create two Gradle tasks (<code>buildDebugXCFramework</code> and <code>buildReleaseXCFramework</code>) to automate the building of an XCFramework. With Kotlin 1.5.30 these tasks are not necessary anymore and in this article, I will show you how to replace the custom tasks with the official ones.</p><h2 id=build-an-xcframework-with-kotlin-1530>Build an XCFramework with Kotlin 1.5.30<a hidden class=anchor aria-hidden=true href=#build-an-xcframework-with-kotlin-1530>#</a></h2><p>To start using XCFrameworks, it is necessary to create an XCFramework object inside the <code>kotlin</code> block of the <code>build.gradle.kts</code> file. Then, every Apple target should be added to that object.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>import</span> org.jetbrains.kotlin.gradle.plugin.mpp.apple.XCFramework
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> libName = <span style=color:#960050;background-color:#1e0010>“</span>LibraryName<span style=color:#960050;background-color:#1e0010>”</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kotlin {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> xcFramework = XCFramework(libName)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ios {
</span></span><span style=display:flex><span>        binaries.framework(libName) {
</span></span><span style=display:flex><span>            xcFramework.add(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After declaring the XCFramework object, three new tasks are added:</p><ul><li>assemble${libName}XCFramework</li><li>assemble${libName}DebugXCFramework</li><li>assemble${libName}ReleaseXCFramework</li></ul><p>The first one will create both the release and the debug version of the XCFramework, while the others will create only the requested variant.</p><p>The XCFrameworks are located in the <code>XCFrameworks</code> folder inside the <code>build</code> folder. There will be a subfolder for each of the built variants.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── build
</span></span><span style=display:flex><span>    ├── XCFrameworks
</span></span><span style=display:flex><span>        ├── debug
</span></span><span style=display:flex><span>        │   └── LibraryName.xcframework
</span></span><span style=display:flex><span>        └── release
</span></span><span style=display:flex><span>            └── LibraryName.xcframework
</span></span></code></pre></div><h2 id=publish-an-xcframework>Publish an XCFramework<a hidden class=anchor aria-hidden=true href=#publish-an-xcframework>#</a></h2><p>The newly built XCFramework can now be distributed. The distribution can be archived in different ways: for example in a <em><a href=https://cocoapods.org/>CocoaPods</a></em> repository, in the <a href=https://swift.org/package-manager/>Swift Package Manager</a> or with <a href=https://github.com/Carthage/Carthage>Carthage</a>. Since I’m familiar with CocoaPods, that’s what I’ve always used.</p><p>To make the publishing process as streamlined as possible, I’ve written a bunch of Gradle tasks to automatically build and publish through git the Debug and Release version of the XCFramework. For the details and to understand how the task works, I suggest you give a look at <a href=https://www.marcogomiero.com/posts/2021/kmp-existing-project/>this article</a> that I wrote a few months ago.</p><p>These tasks are the same used in <a href=https://www.marcogomiero.com/posts/2021/build-xcframework-kmp/>the article</a> that I wrote a few weeks ago about XCFrameworks. But they must be updated, since the tasks to build the XCFramework are changed.</p><p><strong>Publish Debug Version</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>register(<span style=color:#e6db74>&#34;publishDevFramework&#34;</span>) {
</span></span><span style=display:flex><span>    description = <span style=color:#e6db74>&#34;Publish iOs framework to the Cocoa Repo&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    project.exec {
</span></span><span style=display:flex><span>        workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>        commandLine(<span style=color:#e6db74>&#34;git&#34;</span>, <span style=color:#e6db74>&#34;checkout&#34;</span>, <span style=color:#e6db74>&#34;develop&#34;</span>).standardOutput
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dependsOn(<span style=color:#e6db74>&#34;assemble</span><span style=color:#e6db74>${libName}</span><span style=color:#e6db74>DebugXCFramework&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    doLast {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        copy {
</span></span><span style=display:flex><span>            from(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$buildDir</span><span style=color:#e6db74>/XCFrameworks/debug&#34;</span>)
</span></span><span style=display:flex><span>            into(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> dir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest/</span><span style=color:#e6db74>$libName</span><span style=color:#e6db74>.podspec&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> tempFile = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest/</span><span style=color:#e6db74>$libName</span><span style=color:#e6db74>.podspec.new&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> reader = dir.bufferedReader()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> writer = tempFile.bufferedWriter()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> currentLine: String?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (reader.readLine().also { currLine <span style=color:#f92672>-&gt;</span> currentLine = currLine } <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (currentLine<span style=color:#f92672>?.</span>startsWith(<span style=color:#e6db74>&#34;s.version&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>                writer.write(<span style=color:#e6db74>&#34;s.version       = </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>${libVersionName}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> + System.lineSeparator())
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                writer.write(currentLine + System.lineSeparator())
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        writer.close()
</span></span><span style=display:flex><span>        reader.close()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> successful = tempFile.renameTo(dir)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (successful) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;git&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;add&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>                ).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>val</span> dateFormatter = SimpleDateFormat(<span style=color:#e6db74>&#34;dd/MM/yyyy - HH:mm&#34;</span>, Locale.getDefault())
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;git&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;commit&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;-m&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>New dev release: </span><span style=color:#e6db74>${libVersionName}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>${dateFormatter.format(Date())}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>                ).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#e6db74>&#34;git&#34;</span>, <span style=color:#e6db74>&#34;push&#34;</span>, <span style=color:#e6db74>&#34;origin&#34;</span>, <span style=color:#e6db74>&#34;develop&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The task now depends on the <code>assemble${libName}DebugXCFramework</code> task, which is officially provided by Kotlin. Then, the only thing to do is to move the XCFramework from the <code>build</code> folder to the CocoaPod repository.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>copy {
</span></span><span style=display:flex><span>    from(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$buildDir</span><span style=color:#e6db74>/XCFrameworks/debug&#34;</span>)
</span></span><span style=display:flex><span>    into(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The task that publishes the release version of the XCFramework is pretty much the same as the debug one, except for the task to build the framework, that is <code>assemble${libName}ReleaseXCFramework</code>, and the location in the <code>build</code> folder:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>register(<span style=color:#e6db74>&#34;publishFramework&#34;</span>) {
</span></span><span style=display:flex><span>    description = <span style=color:#e6db74>&#34;Publish iOs framework to the Cocoa Repo&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    project.exec {
</span></span><span style=display:flex><span>        workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>        commandLine(<span style=color:#e6db74>&#34;git&#34;</span>, <span style=color:#e6db74>&#34;checkout&#34;</span>, <span style=color:#e6db74>&#34;master&#34;</span>).standardOutput
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create Release Framework for Xcode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    dependsOn(<span style=color:#e6db74>&#34;assemble</span><span style=color:#e6db74>${libName}</span><span style=color:#e6db74>ReleaseXCFramework&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Replace
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    doLast {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        copy {
</span></span><span style=display:flex><span>            from(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$buildDir</span><span style=color:#e6db74>/XCFrameworks/release&#34;</span>)
</span></span><span style=display:flex><span>            into(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> dir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest/</span><span style=color:#e6db74>$libName</span><span style=color:#e6db74>.podspec&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> tempFile = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest/</span><span style=color:#e6db74>$libName</span><span style=color:#e6db74>.podspec.new&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> reader = dir.bufferedReader()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> writer = tempFile.bufferedWriter()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> currentLine: String?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (reader.readLine().also { currLine <span style=color:#f92672>-&gt;</span> currentLine = currLine } <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (currentLine<span style=color:#f92672>?.</span>startsWith(<span style=color:#e6db74>&#34;s.version&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>                writer.write(<span style=color:#e6db74>&#34;s.version       = </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>${libVersionName}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> + System.lineSeparator())
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                writer.write(currentLine + System.lineSeparator())
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        writer.close()
</span></span><span style=display:flex><span>        reader.close()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> successful = tempFile.renameTo(dir)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (successful) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;git&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;add&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>                ).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#e6db74>&#34;git&#34;</span>, <span style=color:#e6db74>&#34;commit&#34;</span>, <span style=color:#e6db74>&#34;-m&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>New release: </span><span style=color:#e6db74>${libVersionName}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#e6db74>&#34;git&#34;</span>, <span style=color:#e6db74>&#34;tag&#34;</span>, libVersionName).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            project.exec {
</span></span><span style=display:flex><span>                workingDir = File(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rootDir</span><span style=color:#e6db74>/../kmp-xcframework-dest&#34;</span>)
</span></span><span style=display:flex><span>                commandLine(<span style=color:#e6db74>&#34;git&#34;</span>, <span style=color:#e6db74>&#34;push&#34;</span>, <span style=color:#e6db74>&#34;origin&#34;</span>, <span style=color:#e6db74>&#34;master&#34;</span>, <span style=color:#e6db74>&#34;--tags&#34;</span>).standardOutput
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And that’s it! With these little modifications, it is possible to use the official Kotlin support for XCFrameworks and automatically publish them in a CocoaPod repository.</p><p>On GitHub, I’ve updated the sample project with the new tasks on the <a href=https://github.com/prof18/kmp-xcframework-sample/tree/kotlin-1.5.30>kotlin-1.5.30 branch</a>. Instead, if you are interested in XCFramework support before Kotlin 1.5.30, you can look at the <a href=https://github.com/prof18/kmp-xcframework-sample/tree/pre-kotlin-1.5.30>pre-kotlin-1.5.30</a> branch. And to see what are the changes between the two branches, you can look <a href=https://github.com/prof18/kmp-xcframework-sample/commit/18fb4ec0fad6ec2b058a2a543c0c1de914c0a0c9#diff-c0dfa6bc7a8685217f70a860145fbdf416d449eaff052fa28352c5cec1a98c06>at this commit</a>.</p></div><div class=article-footer><div class=post-content>To stay up to date with my writing and my projects, follow me on <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>