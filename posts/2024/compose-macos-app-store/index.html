<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Publishing a Compose macOS app on App Store: architectures, sandboxing and native libraries - Marco Gomiero</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When I released FeedFlow (an RSS Reader available on Android, iOS, and macOS, built with Jetpack Compose for the Android app, Compose Multiplatform for the desktop app, and SwiftUI for the iOS app), I decided to publish the macOS version outside the App Store. I went this path because publishing on the App Store has different requirements that I wanted to avoid tackling during the first launch.
How to publish a Kotlin Multiplatform macOS app on GitHub Releases with GitHub Actions"><meta property="og:image" content><meta name=google-site-verification content="7rDTNqn214SsZ9mmV8Ps5v2vqy8aXFWyoq08udChYCs"><meta property="og:title" content="Publishing a Compose macOS app on App Store: architectures, sandboxing and native libraries"><meta property="og:description" content="When I released FeedFlow (an RSS Reader available on Android, iOS, and macOS, built with Jetpack Compose for the Android app, Compose Multiplatform for the desktop app, and SwiftUI for the iOS app), I decided to publish the macOS version outside the App Store. I went this path because publishing on the App Store has different requirements that I wanted to avoid tackling during the first launch.
How to publish a Kotlin Multiplatform macOS app on GitHub Releases with GitHub Actions"><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2024/compose-macos-app-store/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-21T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-21T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="Publishing a Compose macOS app on App Store: architectures, sandboxing and native libraries"><meta name=twitter:description content="When I released FeedFlow (an RSS Reader available on Android, iOS, and macOS, built with Jetpack Compose for the Android app, Compose Multiplatform for the desktop app, and SwiftUI for the iOS app), I decided to publish the macOS version outside the App Store. I went this path because publishing on the App Store has different requirements that I wanted to avoid tackling during the first launch.
How to publish a Kotlin Multiplatform macOS app on GitHub Releases with GitHub Actions"><script async src="https://www.googletagmanager.com/gtag/js?id=G-69FZ1TLE7E"></script>
<script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-69FZ1TLE7E")}</script><script src=https://www.marcogomiero.com/js/feather.min.js></script>
<link href="https://fonts.googleapis.com/css?family=JetBrains+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.marcogomiero.com/css/main.f2c7f60ec2d0155a784ade9b1b272143e1b8eb864a95bf75e606b49d8774389e.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://www.marcogomiero.com/css/dark.26c5bf79ef760a8f4feb8fc7be32ec86fc1f1da292b42c9fcc37879d4f774e3f.css disabled></head><body><div class=content><header><div class=main><a href=https://www.marcogomiero.com><h2>Marco Gomiero</h2></a></div><nav class=navbar><a href=/posts/><span>Write</span></a>
<a href=/talks/><span>Speak</span></a>
<a href=/projects/><span>Build</span></a>
<a href=/about-me/><span>About</span></a>
| <span class=dark-mode-toggle id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://www.marcogomiero.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Publishing a Compose macOS app on App Store: architectures, sandboxing and native libraries</h1><div class=post-meta><span title='2024-05-21 00:00:00 +0000 UTC'>21 May 2024</span></div></div><section class=body><p>When I released <a href=https://www.feedflow.dev/>FeedFlow</a> (an RSS Reader available on Android, iOS, and macOS, built with Jetpack Compose for the Android app, Compose Multiplatform for the desktop app, and SwiftUI for the iOS app), I decided to publish the macOS version outside the App Store. I went this path because publishing on the App Store has different requirements that I wanted to avoid tackling during the first launch.</p><blockquote><p><a href=https://www.marcogomiero.com/posts/2024/kmp-ci-macos-github-releases>How to publish a Kotlin Multiplatform macOS app on GitHub Releases with GitHub Actions</a></p></blockquote><p>A couple of months ago, I was ready for the challenge and decided it was time to publish FeedFlow on the macOS App Store.</p><h2 id=certificates-provisioning-profiles-and-entitlements>Certificates, Provisioning profiles and Entitlements</h2><p>A different set of certificates for code signing is required to publish on the App Store. Also, a provisioning profile (which ensures that a trusted developer in the Apple Developer Program created and signed the app) and entitlements for the app and the JVM runtime are required.</p><p>All the necessary steps to fulfill such requirements are already covered in the Compose Multiplatform documentation:</p><blockquote><p><a href=https://github.com/JetBrains/compose-multiplatform/blob/master/tutorials/Signing_and_notarization_on_macOS>Signing and notarizing distributions for macOS - Configuring Gradle</a></p></blockquote><p>and in an article that I&rsquo;ve written:</p><blockquote><p><a href=https://www.marcogomiero.com/posts/2024/kmp-ci-macos-appstore>How to publish a Kotlin Multiplatform macOS app on App Store with GitHub Actions</a></p></blockquote><h2 id=how-to-upload-a-macos-app>How to upload a macOS app</h2><p>The format of a macOS app distributed in the App Store is <code>pkg</code>. The <code>packageReleasePkg</code> Gradle task can be used to build a <code>pkg</code>.</p><p>After building the <code>pkg</code>, it can be uploaded on <a href=https://developer.apple.com/testflight/>TestFlight</a> without Xcode by using the <a href="https://apps.apple.com/us/app/transporter/id1450874784?mt=12">Transporter App</a> (more info about Transporter can be found <a href=https://help.apple.com/itc/transporteruserguide/en.lproj/static.html#apd70774093eddb4>in the official documentation</a>) or a <a href=https://www.marcogomiero.com/posts/2024/kmp-ci-macos-appstore>GitHub Action</a>.</p><h2 id=publish-an-apple-silicon-only-app>Publish an Apple Silicon-only app</h2><p>The first upload led to a failure.</p><figure><a href=/img/compose-macos-appstore/only-silicon.webp><img src=/img/compose-macos-appstore/only-silicon.webp></a></figure><p>The error says the app bundle must support both Apple Silicon&rsquo;s and Intel&rsquo;s architectures. Otherwise, the app must target macOS 12 to support only Apple Silicon.</p><p>After some digging, I discovered that the Compose Multiplatform Gradle plugin was targeting by default macOS 10.13. So I modified the Gradle plugin to allow setting a custom <code>minimumSystemVersion</code> (<a href=https://github.com/JetBrains/compose-multiplatform/pull/4271>Here&rsquo;s the PR</a>, for reference).</p><p>The change is available from Compose Multiplatform 1.6.10.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>compose {
</span></span><span style=display:flex><span>    desktop {
</span></span><span style=display:flex><span>        application {
</span></span><span style=display:flex><span>            macOS {
</span></span><span style=display:flex><span>                minimumSystemVersion = <span style=color:#5af78e>&#34;12.0&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With this change, I could publish my first build on TestFlight.</p><h2 id=app-sandbox>App Sandbox</h2><p>After publishing the first build on TestFlight, I tried to run it, and I got a mysterious error at runtime:</p><p><code>"sqlite-3.44.1.0-af9d43dd-3c96-4be7-bb35-f75cc21ceafb-libsqlitejdbc.dylib" can't be opened because Apple cannot check it for malicious software.</code></p><figure><a href=/img/compose-macos-appstore/native-lib.webp><img src=/img/compose-macos-appstore/native-lib.webp></a></figure><p>After some research, I discovered that this issue is happening because of macOS &ldquo;<a href=https://developer.apple.com/documentation/security/app_sandbox/protecting_user_data_with_app_sandbox>App Sandbox</a>,&rdquo; a feature that is required for distributing an app on the App Store and that forbids certain activities by default, like accessing system resources and user data. This will limit what a malicious app can do and which data it can access.</p><p>One thing that is forbidden is loading native libraries that are not part of the app bundle. Some libraries, <code>sqlite</code> in this case, extract native libraries from the dependency <code>JAR</code>, place them inside a temporary folder, and load them.</p><p>For the apps distributed outside the App Store that are not sandboxed, this folder is pointed by the <code>$TMPDIR</code> environmental variable; for example, on my machine, the value is the following:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>➜  ~ <span style=color:#ff5c57>echo</span> <span style=color:#ff5c57>$TMPDIR</span> 
</span></span><span style=display:flex><span>/var/folders/t8/25t7v371121b155qrxyb_cjc0000gn/T/
</span></span></code></pre></div><figure><a href=/img/compose-macos-appstore/tmp-lib-folder.webp><img src=/img/compose-macos-appstore/tmp-lib-folder.webp></a></figure><p>When running on a sandbox, the JVM tries to do the same; in this case, the native library is unpacked inside the Container that every sandboxed app has:</p><p><code>/Users/mg/Library/Containers/com.prof18.feedflow/Data/tmp</code></p><figure><a href=/img/compose-macos-appstore/tmp-sandbox-lib-folder.webp><img src=/img/compose-macos-appstore/tmp-sandbox-lib-folder.webp></a></figure><p>However, the loading fails because the native library was not part of the app bundle and was not signed, so Apple cannot verify if it&rsquo;s malicious.</p><p>To fix this issue, the native libraries must be included in the app bundle.</p><h3 id=loading-native-libraries>Loading native libraries</h3><p>The first step is to find the native library.</p><p>On FeedFlow, I&rsquo;m using <a href=https://cashapp.github.io/sqldelight/>SQLDelight</a>. <a href=https://github.com/cashapp/sqldelight/blob/master/drivers/sqlite-driver/build.gradle#L14>The SQLDelight SQLite driver</a> uses the <a href=https://github.com/xerial/sqlite-jdbc>SQLite JDBC Driver</a> library as a dependency, and the native library that will be packaged in the JAR can be found <a href=https://github.com/xerial/sqlite-jdbc/tree/master/src/main/resources/org/sqlite/native/Mac/aarch64>inside the repo</a> by architecture.</p><figure><a href=/img/compose-macos-appstore/native-lib-git.webp><img src=/img/compose-macos-appstore/native-lib-git.webp></a></figure><p>In my case, I&rsquo;m only interested in the version for Apple Silicon, so <code>aarch64</code>.</p><h4 id=include-native-libraries-in-the-app-bundle>Include native libraries in the app bundle</h4><p><a href=https://github.com/JetBrains/compose-multiplatform/blob/master/tutorials/Native_distributions_and_local_execution/README.md#adding-files-to-packaged-application>Compose Multiplatform lets you include assets</a>, like a native library, inside the app bundle. Those assets can be placed in an OS-specific (<code>windows</code>, <code>macos</code>, <code>linux</code>) or OS and architecture-specific (for example, <code>macos-x64</code> and <code>macos-arm64</code>) folder.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── desktopApp
</span></span><span style=display:flex><span>    ├── resources
</span></span><span style=display:flex><span>        └── macos-arm64
</span></span><span style=display:flex><span>            └── libsqlitejdbc.dylib
</span></span></code></pre></div><p>The path of the folders can then be configured in the <code>build.gradle.kts</code> file of the Compose Desktop app:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>compose {
</span></span><span style=display:flex><span>    desktop {
</span></span><span style=display:flex><span>        application {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>val</span> isAppStoreRelease = project.<span style=color:#ff6ac1>property</span>(<span style=color:#5af78e>&#34;macOsAppStoreRelease&#34;</span>).toString().toBoolean()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            nativeDistributions {
</span></span><span style=display:flex><span>                <span style=color:#ff6ac1>if</span> (isAppStoreRelease) {
</span></span><span style=display:flex><span>                    appResourcesRootDir.<span style=color:#ff6ac1>set</span>(project.layout.projectDirectory.dir(<span style=color:#5af78e>&#34;resources&#34;</span>))
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Since I only want to include the native libraries when I&rsquo;m creating an app bundle for the App Store, I&rsquo;ve created a custom Gradle property in the <code>gradle.properties</code> file that is set to <code>false</code> by default:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>macOsAppStoreRelease=false
</span></span></code></pre></div><p>When I need to build a new version for the App Store, the property can be overridden and set to <code>true</code> from the command line:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew packageReleasePkg -PmacOsAppStoreRelease<span style=color:#ff6ac1>=</span><span style=color:#ff5c57>true</span>
</span></span></code></pre></div><h4 id=change-native-library-path-at-startup>Change native library path at startup</h4><p>The last remaining step is changing the path from where the JVM can load the native library. This step must be done manually only if the app runs in the sandbox.</p><p>It&rsquo;s possible to check if an app is sandboxed by checking if the value of the <code>APP_SANDBOX_CONTAINER_ID</code> environmental variable is not null.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> isSandboxed = System.getenv(<span style=color:#5af78e>&#34;APP_SANDBOX_CONTAINER_ID&#34;</span>) <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>null</span>
</span></span></code></pre></div><p>To change the path, the <code>org.sqlite.lib.path</code> system property must be set. The path where the native libs are stored can be obtained from the <code>compose.application.resources.dir</code> system property. To avoid any possible issues, I&rsquo;ve also manually set the library&rsquo;s name, in this case, <code>libsqlitejdbc.dylib</code>.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>val</span> isSandboxed = System.getenv(<span style=color:#5af78e>&#34;APP_SANDBOX_CONTAINER_ID&#34;</span>) <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>null</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>if</span> (isSandboxed) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>val</span> resourcesPath = System.getProperty(<span style=color:#5af78e>&#34;compose.application.resources.dir&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    System.setProperty(<span style=color:#5af78e>&#34;org.sqlite.lib.path&#34;</span>, resourcesPath)
</span></span><span style=display:flex><span>    System.setProperty(<span style=color:#5af78e>&#34;org.sqlite.lib.name&#34;</span>, <span style=color:#5af78e>&#34;libsqlitejdbc.dylib&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusions>Conclusions</h2><p>And with those changes, FeedFlow is finally available on the <a href="https://apps.apple.com/it/app/feedflow-rss-reader/id6447210518?l=en-GB">macOS App Store</a></p><p>All the code mentioned in the article is available on <a href=https://github.com/prof18/feed-flow/tree/main/desktopApp>GitHub</a>.</p></section><div class=article-footer><div class=body>To stay up to date with my writing and my projects, follow me on <a href=https://bsky.app/profile/marcogomiero.com target=_blank>Bluesky</a>, <a href=https://androiddev.social/@marcogom target=_blank>Mastodon</a> or <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-69FZ1TLE7E"></script>
<script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-69FZ1TLE7E")}</script></div></body></html>