<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to handle database migrations with Liquibase on Ktor | Marco Gomiero</title><meta name=keywords content><meta name=description content="SERIES: Building a backend with Ktor
Part 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor Part 6: How to schedule jobs with Quartz on Ktor Part 7: Moving from mobile to backend development with Ktor Databases are an important and critical part of backend infrastructures."><meta name=author content="Marco Gomiero"><link rel=canonical href=https://www.marcogomiero.com/posts/2022/ktor-migration-liquibase/><link crossorigin=anonymous href=/assets/css/stylesheet.min.686715e54e31dbf63447efd76235e41e047fd8826df608657b7b0ddb3a0d900d.css integrity="sha256-aGcV5U4x2/Y0R+/XYjXkHgR/2IJt9ghle3sN2zoNkA0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.marcogomiero.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.marcogomiero.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.marcogomiero.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.marcogomiero.com/apple-touch-icon.png><link rel=mask-icon href=https://www.marcogomiero.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-69FZ1TLE7E"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-69FZ1TLE7E",{anonymize_ip:!1})}</script><meta property="og:title" content="How to handle database migrations with Liquibase on Ktor"><meta property="og:description" content="SERIES: Building a backend with Ktor
Part 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor Part 6: How to schedule jobs with Quartz on Ktor Part 7: Moving from mobile to backend development with Ktor Databases are an important and critical part of backend infrastructures."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2022/ktor-migration-liquibase/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-24T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to handle database migrations with Liquibase on Ktor"><meta name=twitter:description content="SERIES: Building a backend with Ktor
Part 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor Part 6: How to schedule jobs with Quartz on Ktor Part 7: Moving from mobile to backend development with Ktor Databases are an important and critical part of backend infrastructures."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.marcogomiero.com/posts/"},{"@type":"ListItem","position":3,"name":"How to handle database migrations with Liquibase on Ktor","item":"https://www.marcogomiero.com/posts/2022/ktor-migration-liquibase/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to handle database migrations with Liquibase on Ktor","name":"How to handle database migrations with Liquibase on Ktor","description":"SERIES: Building a backend with Ktor\nPart 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor Part 6: How to schedule jobs with Quartz on Ktor Part 7: Moving from mobile to backend development with Ktor Databases are an important and critical part of backend infrastructures.","keywords":[],"articleBody":" SERIES: Building a backend with Ktor\nPart 1: Structuring a Ktor project Part 2: How to persist Ktor logs Part 3: How to use an in-memory database for testing on Ktor Part 4: How to handle database migrations with Liquibase on Ktor Part 5 Generate API documentation from Swagger on Ktor Part 6: How to schedule jobs with Quartz on Ktor Part 7: Moving from mobile to backend development with Ktor Databases are an important and critical part of backend infrastructures. They are the place where all the information is stored and that data cannot be compromised or lost. That’s why it is important to have proper management of the evolution of the database: it is necessary to be able to modify the schema, migrate the data, or roll back to a previous schema version if something unexpected happened.\nThere are many different products or tools to manage a database schema, for example Flyway or Liquibase.\nIn this article, I will cover how to set up Liquibase in a Ktor project and how to create two Gradle tasks responsible to migrate a test and a production MySQL database. There is also a pro version of Liquibase, but the free community version was enough for me.\nThis post is part of a series of posts dedicated to Ktor where I cover all the topics that made me struggle during development and that was not easy to achieve out of the box. You can check out the other instances of the series in the index above or follow me on Twitter to keep up to date.\nSetup The first thing to do is to add all the required dependencies. The starting point is the Gradle plugin in the build.gradle.kts file:\nplugins { id(\"org.liquibase.gradle\") version \"\" } After syncing the project, it is possible to add now the required dependencies for the Liquibase runtime:\nliquibaseRuntime(\"org.liquibase:liquibase-core:$liquibase_core\") liquibaseRuntime(\"mysql:mysql-connector-java:$mysql_connector_version\") liquibaseRuntime(\"ch.qos.logback:logback-core:1.2.3\") liquibaseRuntime(\"ch.qos.logback:logback-classic:1.2.3\") liquibaseRuntime(\"javax.xml.bind:jaxb-api:2.2.4\") Note that here liquibaseRuntime is used instead of the usual implementation\nBesides the core functionality, the other dependencies are necessary for the database connection, for logging, and for parsing XML, since all the data about the migrations will be saved in an XML file (as shown later on).\nConfiguring the migration task To perform the database migrations, it is necessary to connect to the database, and to do so, some access information, like the database URL, the user, and the password, need to be stored somewhere and retrieved.\nThe access information can be saved, for example, on local.properties or in the environment variables:\nliquibase.dev.url=jdbc:mysql://localhost:3308/chucknorris liquibase.dev.pwd=password liquibase.dev.user=root liquibase.prod.url=jdbc\\:mysql\\://your-url.com liquibase.prod.pwd=password liquibase.prod.user=user and can be retrieved in the build.gradle.kts file:\nval propertiesFile = file(\"local.properties\") val properties = Properties() if (propertiesFile.exists()) { properties.load(propertiesFile.inputStream()) } val urlDev = properties.getProperty(\"liquibase.dev.url\") ?: System.getenv(\"LIQUIBASE_DEV_URL\") val userDev = properties.getProperty(\"liquibase.dev.user\") ?: System.getenv(\"LIQUIBASE_DEV_USER\") val pwdDev = properties.getProperty(\"liquibase.dev.pwd\") ?: System.getenv(\"LIQUIBASE_DEV_PWD\") val urlProd = properties.getProperty(\"liquibase.prod.url\") ?: System.getenv(\"LIQUIBASE_PROD_URL\") val userProd = properties.getProperty(\"liquibase.prod.user\") ?: System.getenv(\"LIQUIBASE_PROD_USER\") val pwdProd = properties.getProperty(\"liquibase.prod.pwd\") ?: System.getenv(\"LIQUIBASE_PROD_PWD\") The migration task can be configured and customized by providing some parameters in the activities.register block, inside the liquibase block.\nliquibase { activities.register { this.arguments = mapOf( \"logLevel\" to \"info\", \"changeLogFile\" to \"\", \"url\" to urlProd, \"username\" to userProd, \"password\" to pwdProd, ) } } The ones that I’ve provided are the following, but you can find more parameters in the Liquibase documentation:\nlogInfo -\u003e execution log level (debug, info, warning, severe, off). changeLogFile -\u003e the path of the changelog XML file to use; url -\u003e database JDBC URL; username -\u003e database username; password -\u003e database password; The location where the changelog XML file and the SQL files can be freely chosen depending on the project. I’ve decided to put them in the resources folder of the project, with the following structure:\n. └── src ├── main ├── kotlin └── resources ├── db └── migration ├── changesets │ ├── changeset-202102281045.sql │ └── changeset-202102281050.sql └── migrations.xml The SQL files are contained in the changesets subfolder and are named with the following pattern to make the file unique: changeset-YearMonthDayHourMinute.sql\nThe migrations.xml file contains the definitions of every migration:\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e ","wordCount":"1021","inLanguage":"en","datePublished":"2022-01-24T00:00:00Z","dateModified":"2022-01-24T00:00:00Z","author":{"@type":"Person","name":"Marco Gomiero"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.marcogomiero.com/posts/2022/ktor-migration-liquibase/"},"publisher":{"@type":"Organization","name":"Marco Gomiero","logo":{"@type":"ImageObject","url":"https://www.marcogomiero.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.marcogomiero.com accesskey=h title="Marco Gomiero (Alt + H)">Marco Gomiero</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.marcogomiero.com/posts/ title=Write><span>Write</span></a></li><li><a href=https://www.marcogomiero.com/talks/ title=Speak><span>Speak</span></a></li><li><a href=https://www.marcogomiero.com/projects/ title=Build><span>Build</span></a></li><li><a href=https://www.marcogomiero.com/about-me/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>How to handle database migrations with Liquibase on Ktor</h1><div class=post-meta style=margin-top:16px><span title='2022-01-24 00:00:00 +0000 UTC'>24 January 2022</span>&nbsp;·&nbsp;5 min</div></header><div class=post-content><a href="https://us12.campaign-archive.com/?u=f39692e245b94f7fb693b6d82&id=f4f6d67da0"><img style=margin:0 src=https://img.shields.io/badge/Featured%20in%20kotlinweekly.net-Issue%20%23289-%237874b4></a><blockquote><p><strong>SERIES: Building a backend with Ktor</strong></p><ul><li>Part 1: <a href=https://www.marcogomiero.com/posts/2021/ktor-project-structure/>Structuring a Ktor project</a></li><li>Part 2: <a href=https://www.marcogomiero.com/posts/2021/ktor-logging-on-disk/>How to persist Ktor logs</a></li><li>Part 3: <a href=https://www.marcogomiero.com/posts/2021/ktor-in-memory-db-testing/>How to use an in-memory database for testing on Ktor</a></li><li>Part 4: How to handle database migrations with Liquibase on Ktor</li><li>Part 5 <a href=https://www.marcogomiero.com/posts/2022/ktor-setup-documentation/>Generate API documentation from Swagger on Ktor</a></li><li>Part 6: <a href=https://www.marcogomiero.com/posts/2022/ktor-jobs-quartz/>How to schedule jobs with Quartz on Ktor</a></li><li>Part 7: <a href=https://www.marcogomiero.com/posts/2022/backend-from-mobile-ktor/>Moving from mobile to backend development with Ktor</a></li></ul></blockquote><p>Databases are an important and critical part of backend infrastructures. They are the place where all the information is stored and that data cannot be compromised or lost. That’s why it is important to have proper management of the evolution of the database: it is necessary to be able to modify the schema, migrate the data, or roll back to a previous schema version if something unexpected happened.</p><p>There are many different products or tools to manage a database schema, for example <a href=https://github.com/flyway/flyway>Flyway</a> or <a href=https://github.com/liquibase/liquibase>Liquibase</a>.</p><p>In this article, I will cover how to set up Liquibase in a Ktor project and how to create two Gradle tasks responsible to migrate a test and a production MySQL database. There is also a <a href=https://www.liquibase.com/products>pro version</a> of Liquibase, but the free community version was enough for me.</p><p>This post is part of a series of posts dedicated to Ktor where I cover all the topics that made me struggle during development and that was not easy to achieve out of the box. You can check out the other instances of the series in the index above or <a href=https://twitter.com/marcoGomier>follow me on Twitter</a> to keep up to date.</p><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>The first thing to do is to add all the required dependencies. The starting point is the <a href=https://github.com/liquibase/liquibase-gradle-plugin>Gradle plugin</a> in the <code>build.gradle.kts</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>plugins {
</span></span><span style=display:flex><span>    id(<span style=color:#e6db74>&#34;org.liquibase.gradle&#34;</span>) version <span style=color:#e6db74>&#34;&lt;version-number&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After syncing the project, it is possible to add now the required dependencies for the Liquibase runtime:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>liquibaseRuntime(<span style=color:#e6db74>&#34;org.liquibase:liquibase-core:</span><span style=color:#e6db74>$liquibase</span><span style=color:#e6db74>_core&#34;</span>)
</span></span><span style=display:flex><span>liquibaseRuntime(<span style=color:#e6db74>&#34;mysql:mysql-connector-java:</span><span style=color:#e6db74>$mysql</span><span style=color:#e6db74>_connector_version&#34;</span>)
</span></span><span style=display:flex><span>liquibaseRuntime(<span style=color:#e6db74>&#34;ch.qos.logback:logback-core:1.2.3&#34;</span>)
</span></span><span style=display:flex><span>liquibaseRuntime(<span style=color:#e6db74>&#34;ch.qos.logback:logback-classic:1.2.3&#34;</span>)
</span></span><span style=display:flex><span>liquibaseRuntime(<span style=color:#e6db74>&#34;javax.xml.bind:jaxb-api:2.2.4&#34;</span>)
</span></span></code></pre></div><p><em>Note that here <code>liquibaseRuntime</code> is used instead of the usual <code>implementation</code></em></p><p>Besides the core functionality, the other dependencies are necessary for the database connection, for logging, and for parsing XML, since all the data about the migrations will be saved in an XML file (as shown later on).</p><h2 id=configuring-the-migration-task>Configuring the migration task<a hidden class=anchor aria-hidden=true href=#configuring-the-migration-task>#</a></h2><p>To perform the database migrations, it is necessary to connect to the database, and to do so, some access information, like the database URL, the user, and the password, need to be stored somewhere and retrieved.</p><p>The access information can be saved, for example, on <code>local.properties</code> or in the environment variables:</p><pre tabindex=0><code class=language-properties data-lang=properties>liquibase.dev.url=jdbc:mysql://localhost:3308/chucknorris
liquibase.dev.pwd=password
liquibase.dev.user=root

liquibase.prod.url=jdbc\:mysql\://your-url.com
liquibase.prod.pwd=password
liquibase.prod.user=user
</code></pre><p>and can be retrieved in the <code>build.gradle.kts</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> propertiesFile = <span style=color:#66d9ef>file</span>(<span style=color:#e6db74>&#34;local.properties&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> properties = Properties()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (propertiesFile.exists()) {
</span></span><span style=display:flex><span>    properties.load(propertiesFile.inputStream())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> urlDev = properties.getProperty(<span style=color:#e6db74>&#34;liquibase.dev.url&#34;</span>) <span style=color:#f92672>?:</span> System.getenv(<span style=color:#e6db74>&#34;LIQUIBASE_DEV_URL&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> userDev = properties.getProperty(<span style=color:#e6db74>&#34;liquibase.dev.user&#34;</span>) <span style=color:#f92672>?:</span> System.getenv(<span style=color:#e6db74>&#34;LIQUIBASE_DEV_USER&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> pwdDev = properties.getProperty(<span style=color:#e6db74>&#34;liquibase.dev.pwd&#34;</span>) <span style=color:#f92672>?:</span> System.getenv(<span style=color:#e6db74>&#34;LIQUIBASE_DEV_PWD&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> urlProd = properties.getProperty(<span style=color:#e6db74>&#34;liquibase.prod.url&#34;</span>) <span style=color:#f92672>?:</span> System.getenv(<span style=color:#e6db74>&#34;LIQUIBASE_PROD_URL&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> userProd = properties.getProperty(<span style=color:#e6db74>&#34;liquibase.prod.user&#34;</span>) <span style=color:#f92672>?:</span> System.getenv(<span style=color:#e6db74>&#34;LIQUIBASE_PROD_USER&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> pwdProd = properties.getProperty(<span style=color:#e6db74>&#34;liquibase.prod.pwd&#34;</span>) <span style=color:#f92672>?:</span> System.getenv(<span style=color:#e6db74>&#34;LIQUIBASE_PROD_PWD&#34;</span>)
</span></span></code></pre></div><p>The migration task can be configured and customized by providing some parameters in the <code>activities.register</code> block, inside the <code>liquibase</code> block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>liquibase {
</span></span><span style=display:flex><span>    activities.register {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.arguments = mapOf(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;logLevel&#34;</span> to <span style=color:#e6db74>&#34;info&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;changeLogFile&#34;</span> to <span style=color:#e6db74>&#34;&lt;file-path&gt;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;url&#34;</span> to urlProd,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;username&#34;</span> to userProd,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;password&#34;</span> to pwdProd,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The ones that I’ve provided are the following, but you can find more parameters in the <a href=https://docs.liquibase.com/commands/home.html>Liquibase documentation</a>:</p><ul><li><code>logInfo</code> -> execution log level (<code>debug</code>, <code>info</code>, <code>warning</code>, <code>severe</code>, <code>off</code>).</li><li><code>changeLogFile</code> -> the path of the changelog XML file to use;</li><li><code>url</code> -> database JDBC URL;</li><li><code>username</code> -> database username;</li><li><code>password</code> -> database password;</li></ul><p>The location where the changelog <code>XML</code> file and the <code>SQL</code> files can be freely chosen depending on the project. I’ve decided to put them in the <code>resources</code> folder of the project, with the following structure:</p><pre tabindex=0><code>.
└── src
    ├── main
        ├── kotlin
        └── resources
            ├── db
                └── migration
                    ├── changesets
                    │   ├── changeset-202102281045.sql
                    │   └── changeset-202102281050.sql
                    └── migrations.xml
</code></pre><p>The SQL files are contained in the <code>changesets</code> subfolder and are named with the following pattern to make the file unique: <code>changeset-YearMonthDayHourMinute.sql</code></p><p>The <code>migrations.xml</code> file contains the definitions of every migration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;databaseChangeLog</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://www.liquibase.org/xml/ns/dbchangelog&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xmlns:xsi=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xsi:schemaLocation=</span><span style=color:#e6db74>&#34;http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;changeSet</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;202102281045&#34;</span> <span style=color:#a6e22e>author=</span><span style=color:#e6db74>&#34;Marco&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;comment&gt;</span>Jokes Table<span style=color:#f92672>&lt;/comment&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;sqlFile</span> <span style=color:#a6e22e>path=</span><span style=color:#e6db74>&#34;src/main/resources/db/migration/changesets/changeset-202102281045.sql&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/changeSet&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;changeSet</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;202102281050&#34;</span> <span style=color:#a6e22e>author=</span><span style=color:#e6db74>&#34;Marco&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;comment&gt;</span>Jokes Data<span style=color:#f92672>&lt;/comment&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;sqlFile</span> <span style=color:#a6e22e>path=</span><span style=color:#e6db74>&#34;src/main/resources/db/migration/changesets/changeset-202102281050.sql&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/changeSet&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/databaseChangeLog&gt;</span>
</span></span></code></pre></div><p>Every migration is represented by a <code>changeSet</code>, that has a unique ID. An ID could be, for example, the <em>YearMonthDayHourMinute</em> used for the file name.
In the changeSet object, it is necessary to provide the path of the SQL file for the migration, and also a comment can be added.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;changeSet</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;202102281050&#34;</span> <span style=color:#a6e22e>author=</span><span style=color:#e6db74>&#34;Marco&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;comment&gt;</span>Jokes Data<span style=color:#f92672>&lt;/comment&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;sqlFile</span> <span style=color:#a6e22e>path=</span><span style=color:#e6db74>&#34;src/main/resources/db/migration/changesets/changeset-202102281050.sql&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/changeSet&gt;</span>
</span></span></code></pre></div><p>Finally, at this point, it is possible to run the Gradle task that will perform the database migration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew update
</span></span></code></pre></div><h2 id=migrating-multiple-databases>Migrating multiple databases<a hidden class=anchor aria-hidden=true href=#migrating-multiple-databases>#</a></h2><p>As shown above, every <code>activity</code> registered in the <code>liquibase</code> block corresponds to a different database instance to connect to. However, to connect and migrate different databases instances, it is necessary to register different <code>activity</code> with different names.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>liquibase {
</span></span><span style=display:flex><span>    activities.register(<span style=color:#e6db74>&#34;dev&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.arguments = mapOf(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;logLevel&#34;</span> to <span style=color:#e6db74>&#34;info&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;changeLogFile&#34;</span> to <span style=color:#e6db74>&#34;&lt;file-path&gt;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;url&#34;</span> to urlDev,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;username&#34;</span> to userDev,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;password&#34;</span> to pwdDev,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    activities.register(<span style=color:#e6db74>&#34;prod&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.arguments = mapOf(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;logLevel&#34;</span> to <span style=color:#e6db74>&#34;info&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;changeLogFile&#34;</span> to <span style=color:#e6db74>&#34;&lt;file-path&gt;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;url&#34;</span> to urlProd,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;username&#34;</span> to userProd,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;password&#34;</span> to pwdProd,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>By default, the Liquibase plugin will run every activity. However, it is possible to set the <code>runList</code> parameter with the name of the activities to run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>liquibase {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>    runList = <span style=color:#960050;background-color:#1e0010>“</span>dev,prod<span style=color:#960050;background-color:#1e0010>”</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The value of the parameter can also be provided from the command line when running the Gradle task. To do that, it is necessary to first define an empty variable in the <code>gradle.properties</code> file:</p><pre tabindex=0><code class=language-properties data-lang=properties>dbEnv=
</code></pre><p>Then the variable will be retrieved in the <code>build.gradle.kts</code> file and assigned to the <code>runList</code> parameter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> dbEnv: String <span style=color:#66d9ef>by</span> project.ext
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>liquibase {
</span></span><span style=display:flex><span>    <span style=color:#f92672>..</span>.
</span></span><span style=display:flex><span>    runList = dbEnv
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The value of the variable can then be injected from the command line with the following argument:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./gradlew update -PdbEnv<span style=color:#f92672>=</span>dev
</span></span></code></pre></div><h2 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h2><p>And that’s it for today. You can find the code mentioned in the article on <a href=https://github.com/prof18/ktor-chuck-norris-sample/tree/part4>GitHub</a>.</p><p>In the next episode, I’ll cover how to show the API documentation from a Swagger specification. You can follow me on <a href=https://twitter.com/marcoGomier>Twitter</a> to know when I’ll publish the next episodes.</p></div><div class=article-footer><div class=post-content>To stay up to date with my writing and my projects, follow me on <a href=https://androiddev.social/@marcogom target=_blank>Mastodon</a> or <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>