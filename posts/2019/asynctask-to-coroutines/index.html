<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>A journey from Async Task to Kotlin Coroutines - Marco Gomiero</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Photo by felipe lopez on Unsplash
Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version."><meta property="og:image" content><meta property="og:title" content="A journey from Async Task to Kotlin Coroutines"><meta property="og:description" content="Photo by felipe lopez on Unsplash
Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version."><meta property="og:type" content="article"><meta property="og:url" content="https://www.marcogomiero.com/posts/2019/asynctask-to-coroutines/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-01-14T00:00:00+00:00"><meta property="article:modified_time" content="2019-01-14T00:00:00+00:00"><meta property="og:site_name" content="Marco Gomiero"><meta name=twitter:card content="summary"><meta name=twitter:title content="A journey from Async Task to Kotlin Coroutines"><meta name=twitter:description content="Photo by felipe lopez on Unsplash
Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version."><script src=https://www.marcogomiero.com/js/feather.min.js></script>
<link href="https://fonts.googleapis.com/css?family=JetBrains+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.marcogomiero.com/css/main.8fe5ace0a232e45b783ae12e0eef4deff9d16c430f2dddaa7c5e21f36da4cbba.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://www.marcogomiero.com/css/dark.2d1f13dc82ea2d94683809543a326af8a9a1f3a6c000f7b7af5d8f02a2e6ec25.css disabled></head><body><div class=content><header><div class=main><a href=https://www.marcogomiero.com><h2>Marco Gomiero</h2></a></div><nav class=navbar><a href=/posts/><span>Write</span></a>
<a href=/talks/><span>Speak</span></a>
<a href=/projects/><span>Build</span></a>
<a href=/about-me/><span>About</span></a>
| <span class=dark-mode-toggle id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://www.marcogomiero.com/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>A journey from Async Task to Kotlin Coroutines</h1><div class=post-meta><span title='2019-01-14 00:00:00 +0000 UTC'>14 January 2019</span></div></div><section class=body><figure><img src=/img/path.jpeg alt=image><figcaption><p><em>Photo by <a href=https://unsplash.com/@flopez_nice>felipe lopez</a> on <a href=https://unsplash.com>Unsplash</a></em></p></figcaption></figure><p>Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.</p><blockquote><p><a href=https://marco.gomiero.com/posts/bye-async-task>RSS Parser 2.0: bye bye Async Task, welcome Coroutines</a>
This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version. In this way, I hope to inspire you to leave the Async Task and get into the coroutines world.</p></blockquote><p>But, before starting with the technical details, I want to share you some resources to get into the coroutine world. If you already know the coroutines you can skip to the second part of the article.</p><h2 id=get-into-the-coroutine-world-its-funny-i-promise>Get into the coroutine world, it’s funny. I promise:</h2><p>The first thing that you can do to get into the coroutine world is doing the codelab provided by Google.</p><blockquote><p><a href=https://codelabs.developers.google.com/codelabs/kotlin-coroutines/>Using Kotlin Coroutines in your Android App</a></p></blockquote><p>Don’t worry if you don’t understand all the concepts, the codelab is useful to make the first exploration and to receive the inputs and the tools to study a particular argument.</p><p>After the codelab, I suggest you give a look to the official documentation that is well written and full of examples.</p><blockquote><p><a href=https://github.com/Kotlin/kotlinx.coroutines>Kotlin/kotlinx.coroutines</a></p></blockquote><p>Then you could read some articles Android specific and not. Here are some articles that I’ve read:</p><blockquote><p><a href=https://antonis.me/2018/12/12/an-introduction-to-kotlin-coroutines/>An introduction to Kotlin Coroutines*</a></p></blockquote><blockquote><p><a href=https://proandroiddev.com/how-to-make-sense-of-kotlin-coroutines-b666c7151b93>How to make sense of Kotlin coroutines</a></p></blockquote><blockquote><p><a href=https://proandroiddev.com/kotlin-coroutines-patterns-anti-patterns-f9d12984c68e>Kotlin Coroutines patterns & anti-patterns</a></p></blockquote><blockquote><p><a href=https://medium.com/@andrea.bresolin/playing-with-kotlin-in-android-coroutines-and-how-to-get-rid-of-the-callback-hell-a96e817c108b>Playing with Kotlin in Android: coroutines and how to get rid of the callback hell</a></p></blockquote><blockquote><p><a href=https://medium.com/exploring-android/android-networking-with-coroutines-and-retrofit-a2f20dd40a83>Android Networking with Coroutines and Retrofit</a></p></blockquote><blockquote><p><a href=https://blog.oozou.com/handle-complex-network-call-with-kotlin-coroutine-retrofit-2-30a6cd1e0189>Handle Complex Network Call with Kotlin Coroutine + Retrofit 2</a></p></blockquote><blockquote><p><a href=https://proandroiddev.com/async-code-using-kotlin-coroutines-233d201099ff>Async code using Kotlin Coroutines</a></p></blockquote><p>I suggest also the talks of Chris Banes and Christina Lee:</p><blockquote><p><a href=https://chris.banes.me/talks/2018/android-suspenders/>So you’ve read the Coroutines guide and you’re ready to start using them in your Android app to coroutines? Great!</a></p></blockquote><blockquote><p><a href=https://skillsmatter.com/skillscasts/12727-coroutines-by-example>Coroutines By Example</a></p></blockquote><p>Of course, there are lots of resources available and lots of ways to learn the coroutines. These are some advice based on my experience and learning path.</p><h2 id=the-path-from-async-task-to-coroutines>The Path From Async Task to Coroutines</h2><p>The first release of the library is dated 18 June 2016, a period when there wasn’t all the beautiful stuff that there is today (for instance, Kotlin) and moreover I did not know all the stuff that I know today. The code was so simple (and now I can also say that was ugly) but it was working.</p><h3 id=old-school-java-code>Old School Java Code</h3><p>I used an Async Task to handle the network request; the result of the request is sent to an XML Parser that notifies its result when the parsing was done. Here’s the code of the Parser:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>Parser</span> <span style=color:#ff5c57>extends</span> AsyncTask<span style=color:#ff6ac1>&lt;</span>String<span style=color:#ff6ac1>,</span> Void<span style=color:#ff6ac1>,</span> String<span style=color:#ff6ac1>&gt;</span> <span style=color:#ff5c57>implements</span> Observer <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> XMLParser xmlParser<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>static</span> ArrayList<span style=color:#ff6ac1>&lt;</span>Article<span style=color:#ff6ac1>&gt;</span> articles <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> ArrayList<span style=color:#ff6ac1>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> OnTaskCompleted onComplete<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#57c7ff>Parser</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        xmlParser <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> XMLParser<span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        xmlParser<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>addObserver</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>this</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>interface</span> <span style=color:#f3f99d>OnTaskCompleted</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>onTaskCompleted</span><span style=color:#ff6ac1>(</span>ArrayList<span style=color:#ff6ac1>&lt;</span>Article<span style=color:#ff6ac1>&gt;</span> list<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>onError</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>onFinish</span><span style=color:#ff6ac1>(</span>OnTaskCompleted onComplete<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>this</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>onComplete</span> <span style=color:#ff6ac1>=</span> onComplete<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>protected</span> String <span style=color:#57c7ff>doInBackground</span><span style=color:#ff6ac1>(</span>String<span style=color:#ff6ac1>...</span> ulr<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Response response <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>null</span><span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>        OkHttpClient client <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> OkHttpClient<span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        Request request <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> Request<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>Builder</span><span style=color:#ff6ac1>()</span>
</span></span><span style=display:flex><span>                <span style=color:#ff6ac1>.</span><span style=color:#57c7ff>url</span><span style=color:#ff6ac1>(</span>ulr<span style=color:#ff6ac1>[</span>0<span style=color:#ff6ac1>])</span>
</span></span><span style=display:flex><span>                <span style=color:#ff6ac1>.</span><span style=color:#57c7ff>build</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>try</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>            response <span style=color:#ff6ac1>=</span> client<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>newCall</span><span style=color:#ff6ac1>(</span>request<span style=color:#ff6ac1>).</span><span style=color:#57c7ff>execute</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>if</span> <span style=color:#ff6ac1>(</span>response<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>isSuccessful</span><span style=color:#ff6ac1>())</span>
</span></span><span style=display:flex><span>                <span style=color:#ff6ac1>return</span> response<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>body</span><span style=color:#ff6ac1>().</span><span style=color:#57c7ff>string</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>}</span> <span style=color:#ff6ac1>catch</span> <span style=color:#ff6ac1>(</span>IOException e<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>printStackTrace</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>            onComplete<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>onError</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>null</span><span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>protected</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>onPostExecute</span><span style=color:#ff6ac1>(</span>String result<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>if</span> <span style=color:#ff6ac1>(</span>result <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>null</span><span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>try</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>                xmlParser<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>parseXML</span><span style=color:#ff6ac1>(</span>result<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>                Log<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>i</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;RSS Parser &#34;</span><span style=color:#ff6ac1>,</span> <span style=color:#5af78e>&#34;RSS parsed correctly!&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>}</span> <span style=color:#ff6ac1>catch</span> <span style=color:#ff6ac1>(</span>Exception e<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>                e<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>printStackTrace</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>                onComplete<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>onError</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>}</span> <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span>            onComplete<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>onError</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@SuppressWarnings</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;unchecked&#34;</span><span style=color:#ff6ac1>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>update</span><span style=color:#ff6ac1>(</span>Observable observable<span style=color:#ff6ac1>,</span> Object data<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        articles <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>(</span>ArrayList<span style=color:#ff6ac1>&lt;</span>Article<span style=color:#ff6ac1>&gt;)</span> data<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>        onComplete<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>onTaskCompleted</span><span style=color:#ff6ac1>(</span>articles<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>Then, the result of the parsing (or an error of parsing) is notified to the “main executor” (the application that uses the library) with two simple callbacks.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Parser parser <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> Parser<span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>parser<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>execute</span><span style=color:#ff6ac1>(</span>urlString<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>parser<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>onFinish</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>new</span> Parser<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>OnTaskCompleted</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>//what to do when the parsing is done
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>onTaskCompleted</span><span style=color:#ff6ac1>(</span>ArrayList<span style=color:#ff6ac1>&lt;</span>Article<span style=color:#ff6ac1>&gt;</span> list<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>//list is an Array List with all article&#39;s information
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        <span style=color:#78787e>//set the adapter to recycler view
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        mAdapter <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> ArticleAdapter<span style=color:#ff6ac1>(</span>list<span style=color:#ff6ac1>,</span> R<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>layout</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>row</span><span style=color:#ff6ac1>,</span> MainActivity<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>this</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        mRecyclerView<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>setAdapter</span><span style=color:#ff6ac1>(</span>mAdapter<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        progressBar<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>setVisibility</span><span style=color:#ff6ac1>(</span>View<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>GONE</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        mSwipeRefreshLayout<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>setRefreshing</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>false</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>//what to do in case of error
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>onError</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        runOnUiThread<span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>new</span> Runnable<span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>run</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>                progressBar<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>setVisibility</span><span style=color:#ff6ac1>(</span>View<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>GONE</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>                mSwipeRefreshLayout<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>setRefreshing</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>false</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>                Toast<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>makeText</span><span style=color:#ff6ac1>(</span>MainActivity<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>this</span><span style=color:#ff6ac1>,</span> <span style=color:#5af78e>&#34;Unable to load data.&#34;</span><span style=color:#ff6ac1>,</span>
</span></span><span style=display:flex><span>                        Toast<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>LENGTH_LONG</span><span style=color:#ff6ac1>).</span><span style=color:#57c7ff>show</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>                Log<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>i</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;Unable to load &#34;</span><span style=color:#ff6ac1>,</span> <span style=color:#5af78e>&#34;articles&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>});</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>});</span>
</span></span></code></pre></div><h3 id=kotlin-and-coroutines-a-love-story>Kotlin and Coroutines, a love story</h3><p>After 2 years, I wanted to get rid of Async Task, Java and all the ugly stuff. The perfect candidates for taking the place are Kotlin and the coroutines. However, my biggest concern was maintaining the compatibility with all the devs that still use Java (seriously guys? Love yourself, move to Kotlin). In fact, the Kotlin coroutines cannot be invoked from Java code.</p><p>At first, I tried to figure out if there was a method to call the coroutines from Java but finally I came up with a brilliant idea: provide the support for both the ways.</p><p>For the Java support, I decided to use <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html>Future</a> and <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Callable.html>Callable</a> to handle the asynchronous operations. In particular, I implemented two classes that perform respectively the fetching and the parsing task.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>XMLFetcher</span>(<span style=color:#ff6ac1>private</span> <span style=color:#ff6ac1>val</span> url: String) : Callable&lt;String&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff9f43>@Throws</span>(Exception<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>override</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>call</span>(): String {
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>return</span> CoreXMLFetcher.fetchXML(url)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>XMLParser</span>(<span style=color:#ff6ac1>var</span> xml: String) : Callable&lt;MutableList&lt;Article&gt;&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff9f43>@Throws</span>(Exception<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>override</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>call</span>(): MutableList&lt;Article&gt; {
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>return</span> CoreXMLParser.parseXML(xml)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The result of the parsing is then notified to the “main executor” using the same callbacks reported above.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>execute</span>(url: String) {
</span></span><span style=display:flex><span>  Executors.newSingleThreadExecutor().submit{
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>val</span> service = Executors.newFixedThreadPool(<span style=color:#ff9f43>2</span>)
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>val</span> f1 = service.submit&lt;String&gt;(XMLFetcher(url))
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#ff6ac1>val</span> rssFeed = f1.<span style=color:#ff6ac1>get</span>()
</span></span><span style=display:flex><span>          <span style=color:#ff6ac1>val</span> f2 = service.submit(XMLParser(rssFeed))
</span></span><span style=display:flex><span>          onComplete.onTaskCompleted(f2.<span style=color:#ff6ac1>get</span>())
</span></span><span style=display:flex><span>      } <span style=color:#ff6ac1>catch</span> (e: Exception) {
</span></span><span style=display:flex><span>          onComplete.onError(e)
</span></span><span style=display:flex><span>      } <span style=color:#ff6ac1>finally</span> {
</span></span><span style=display:flex><span>          service.shutdown()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In this way, the old users of the library can still call the same code without noticing any kind of difference but the new ones (and of course also the old) can learn and use the new way.</p><p>As you can image, the new part is written using the Kotlin coroutines. As above, I separated the fetching and the parsing task. The fetching task is performed by the <em>fetchXML</em> suspending function, that takes the URL of the RSS feed as input and returns a <a href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/>Deferred</a> object that will be the input of the <em>parseXML</em> suspend function. This function will then parse the RSS Feed and returns a list of parsed data.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff6ac1>object</span> <span style=color:#f3f99d>CoroutineEngine</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff9f43>@Throws</span>(Exception<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>suspend</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>fetchXML</span>(url: String) =
</span></span><span style=display:flex><span>          withContext(Dispatchers.IO) {
</span></span><span style=display:flex><span>              <span style=color:#ff6ac1>return</span><span style=color:#ff9f43>@withContext</span> CoreXMLFetcher.fetchXML(url)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff9f43>@Throws</span>(Exception<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>suspend</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>parseXML</span>(xml: Deferred&lt;String&gt;) =
</span></span><span style=display:flex><span>          withContext(Dispatchers.IO) {
</span></span><span style=display:flex><span>              <span style=color:#ff6ac1>return</span><span style=color:#ff9f43>@withContext</span> CoreXMLParser.parseXML(xml.await())
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>These functions are exposed to the “main executor” by using another suspend function, that it will get and parse asynchronously the RSS feed.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#ff9f43>@Throws</span>(Exception<span style=color:#ff6ac1>::</span><span style=color:#ff6ac1>class</span>)
</span></span><span style=display:flex><span><span style=color:#ff6ac1>suspend</span> <span style=color:#ff6ac1>fun</span> <span style=color:#57c7ff>getArticles</span>(url: String) =
</span></span><span style=display:flex><span>      withContext(Dispatchers.IO) {
</span></span><span style=display:flex><span>          <span style=color:#ff6ac1>val</span> xml = async { CoroutineEngine.fetchXML(url) }
</span></span><span style=display:flex><span>          <span style=color:#ff6ac1>return</span><span style=color:#ff9f43>@withContext</span> CoroutineEngine.parseXML(xml)
</span></span><span style=display:flex><span>      }
</span></span></code></pre></div><p>All the suspend functions reported above are called with the IO Dispatcher that uses a shared pool of on-demand created threads. There are also other dispatchers, give a look to the <a href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/>documentation</a> to find the one that better suits your needs.</p><p>And finally, from the ViewModel (or in whatever place depending on the architecture of your app) you can launch the coroutine with a <a href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/>Scope</a>, so, for example, you can stop it if the activity is destroyed, and then “transform” an URL to a List of Articles.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>coroutineScope.launch(Dispatchers.Main) {
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>val</span> parser = Parser()
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>val</span> articleList = parser.getArticles(url)
</span></span><span style=display:flex><span>      setArticleList(articleList)
</span></span><span style=display:flex><span>  } <span style=color:#ff6ac1>catch</span> (e: Exception) {
</span></span><span style=display:flex><span>      e.printStackTrace()
</span></span><span style=display:flex><span>      _snackbar.<span style=color:#ff6ac1>value</span> = <span style=color:#5af78e>&#34;An error has occurred. Please retry&#34;</span>
</span></span><span style=display:flex><span>      setArticleList(mutableListOf())
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And finally, we have reached the end of my journey from Async Task to Coroutines. Of course, you can use this example as an idea to leave forever the (ugly) Async Tasks.</p><p>If you want to contribute to the development of the library or simply report a bug, visit the repo on Github: <a href=https://github.com/prof18/RSS-Parser>https://github.com/prof18/RSS-Parser</a></p><p>A special thanks to the (awesome) devs of the Android Developers Italia Community that gave to me some advice. If you are Italian, join us on <a href=https://androiddevs.it/>Slack</a>!</p></section><div class=article-footer><div class=body>To stay up to date with my writing and my projects, follow me on <a href=https://androiddev.social/@marcogom target=_blank>Mastodon</a> or <a href=https://twitter.com/marcoGomier target=_blank>Twitter</a>. If you have any questions, feel free to reach me out!</div></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.marcogomiero.com>Marco Gomiero</a></span></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-69FZ1TLE7E","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>