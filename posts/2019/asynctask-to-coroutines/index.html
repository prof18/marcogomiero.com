<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>A journey from Async Task to Kotlin Coroutines | Marco Gomiero</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="Computer Engineer · Android Developer · Community Manager"><meta name=google-site-verification content="7rDTNqn214SsZ9mmV8Ps5v2vqy8aXFWyoq08udChYCs"><link rel=prev href=https://www.marcogomiero.com/posts/2018/bye-async-task/><link rel=next href=https://www.marcogomiero.com/posts/2019/bottom-bar-swipe-flutter/><link rel=canonical href=https://www.marcogomiero.com/posts/2019/asynctask-to-coroutines/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://miro.medium.com/max/1400/0*BnjRJYi8CNeaKOq1"><meta name=twitter:title content="A journey from Async Task to Kotlin Coroutines"><meta name=twitter:description content="Photo by felipe lopez on Unsplash
  Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
 RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version."><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"A journey from Async Task to Kotlin Coroutines","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.marcogomiero.com\/posts\/2019\/asynctask-to-coroutines\/"},"genre":"posts","keywords":"Android","wordcount":1474,"url":"https:\/\/www.marcogomiero.com\/posts\/2019\/asynctask-to-coroutines\/","datePublished":"2019-01-14T00:00:00\u002b00:00","dateModified":"2019-01-14T00:00:00\u002b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css integrity="sha256-fdcFNFiBMrNfWL6OcAGQz6jDgNTRxnrLEd4vJYFWScE=" crossorigin=anonymous><link rel=stylesheet href=/css/lib/animate/animate.min.min.css><script async defer src=https://buttons.github.io/buttons.js></script></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class=navbar-header><a href=https://www.marcogomiero.com>Marco Gomiero</a></div><div class=navbar-menu><a class=menu-item href=https://www.marcogomiero.com/posts>Posts</a>
<a class=menu-item href=https://www.marcogomiero.com/talks>Talks</a>
<a class=menu-item href=https://www.marcogomiero.com/projects/>Projects</a>
<a class=menu-item href=https://www.marcogomiero.com/about-me/>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class=navbar-header-title><a href=https://www.marcogomiero.com>Marco Gomiero</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://www.marcogomiero.com/posts>Posts</a>
<a class=menu-item href=https://www.marcogomiero.com/talks>Talks</a>
<a class=menu-item href=https://www.marcogomiero.com/projects/>Projects</a>
<a class=menu-item href=https://www.marcogomiero.com/about-me/>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel=stylesheet><main class=main><div class=container><article class=post-warp><h1 class=post-title>A journey from Async Task to Kotlin Coroutines</h1><div class=post-meta><div class=post-meta-main><br></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime="14 Jan 2019">14 Jan 2019</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 1474 words&nbsp;
<i class="far fa-clock fa-fw"></i>7 min&nbsp;</div></div><br><div class=post-content><figure><img src=/img/path.jpeg alt=image><figcaption><p><em>Photo by <a href=https://unsplash.com/@flopez_nice>felipe lopez</a> on <a href=https://unsplash.com>Unsplash</a></em></p></figcaption></figure><p>Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.</p><blockquote><p><a href=https://marco.gomiero.com/posts/bye-async-task>RSS Parser 2.0: bye bye Async Task, welcome Coroutines</a>
This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version. In this way, I hope to inspire you to leave the Async Task and get into the coroutines world.</p></blockquote><p>But, before starting with the technical details, I want to share you some resources to get into the coroutine world. If you already know the coroutines you can skip to the second part of the article.</p><a class=post-dummy-target id=get-into-the-coroutine-world-its-funny-i-promise></a><h2>Get into the coroutine world, it’s funny. I promise:</h2><p>The first thing that you can do to get into the coroutine world is doing the codelab provided by Google.</p><blockquote><p><a href=https://codelabs.developers.google.com/codelabs/kotlin-coroutines/>Using Kotlin Coroutines in your Android App</a></p></blockquote><p>Don’t worry if you don’t understand all the concepts, the codelab is useful to make the first exploration and to receive the inputs and the tools to study a particular argument.</p><p>After the codelab, I suggest you give a look to the official documentation that is well written and full of examples.</p><blockquote><p><a href=https://github.com/Kotlin/kotlinx.coroutines>Kotlin/kotlinx.coroutines</a></p></blockquote><p>Then you could read some articles Android specific and not. Here are some articles that I’ve read:</p><blockquote><p><a href=https://antonis.me/2018/12/12/an-introduction-to-kotlin-coroutines/>An introduction to Kotlin Coroutines*</a></p></blockquote><blockquote><p><a href=https://proandroiddev.com/how-to-make-sense-of-kotlin-coroutines-b666c7151b93>How to make sense of Kotlin coroutines</a></p></blockquote><blockquote><p><a href=https://proandroiddev.com/kotlin-coroutines-patterns-anti-patterns-f9d12984c68e>Kotlin Coroutines patterns & anti-patterns</a></p></blockquote><blockquote><p><a href=https://medium.com/@andrea.bresolin/playing-with-kotlin-in-android-coroutines-and-how-to-get-rid-of-the-callback-hell-a96e817c108b>Playing with Kotlin in Android: coroutines and how to get rid of the callback hell</a></p></blockquote><blockquote><p><a href=https://medium.com/exploring-android/android-networking-with-coroutines-and-retrofit-a2f20dd40a83>Android Networking with Coroutines and Retrofit</a></p></blockquote><blockquote><p><a href=https://blog.oozou.com/handle-complex-network-call-with-kotlin-coroutine-retrofit-2-30a6cd1e0189>Handle Complex Network Call with Kotlin Coroutine + Retrofit 2</a></p></blockquote><blockquote><p><a href=https://proandroiddev.com/async-code-using-kotlin-coroutines-233d201099ff>Async code using Kotlin Coroutines</a></p></blockquote><p>I suggest also the talks of Chris Banes and Christina Lee:</p><blockquote><p><a href=https://chris.banes.me/talks/2018/android-suspenders/>So you’ve read the Coroutines guide and you’re ready to start using them in your Android app to coroutines? Great!</a></p></blockquote><blockquote><p><a href=https://skillsmatter.com/skillscasts/12727-coroutines-by-example>Coroutines By Example</a></p></blockquote><p>Of course, there are lots of resources available and lots of ways to learn the coroutines. These are some advice based on my experience and learning path.</p><a class=post-dummy-target id=the-path-from-async-task-to-coroutines></a><h2>The Path From Async Task to Coroutines</h2><p>The first release of the library is dated 18 June 2016, a period when there wasn’t all the beautiful stuff that there is today (for instance, Kotlin) and moreover I did not know all the stuff that I know today. The code was so simple (and now I can also say that was ugly) but it was working.</p><a class=post-dummy-target id=old-school-java-code></a><h3>Old School Java Code</h3><p>I used an Async Task to handle the network request; the result of the request is sent to an XML Parser that notifies its result when the parsing was done. Here’s the code of the Parser:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Parser</span> <span class=kd>extends</span> <span class=n>AsyncTask</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Void</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Observer</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=n>XMLParser</span> <span class=n>xmlParser</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Article</span><span class=o>&gt;</span> <span class=n>articles</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
    <span class=kd>private</span> <span class=n>OnTaskCompleted</span> <span class=n>onComplete</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>Parser</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>xmlParser</span> <span class=o>=</span> <span class=k>new</span> <span class=n>XMLParser</span><span class=o>();</span>
        <span class=n>xmlParser</span><span class=o>.</span><span class=na>addObserver</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>OnTaskCompleted</span> <span class=o>{</span>
        <span class=kt>void</span> <span class=nf>onTaskCompleted</span><span class=o>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Article</span><span class=o>&gt;</span> <span class=n>list</span><span class=o>);</span>
        <span class=kt>void</span> <span class=nf>onError</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onFinish</span><span class=o>(</span><span class=n>OnTaskCompleted</span> <span class=n>onComplete</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>onComplete</span> <span class=o>=</span> <span class=n>onComplete</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>String</span> <span class=nf>doInBackground</span><span class=o>(</span><span class=n>String</span><span class=o>...</span> <span class=n>ulr</span><span class=o>)</span> <span class=o>{</span>

        <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
        <span class=n>OkHttpClient</span> <span class=n>client</span> <span class=o>=</span> <span class=k>new</span> <span class=n>OkHttpClient</span><span class=o>();</span>
        <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Request</span><span class=o>.</span><span class=na>Builder</span><span class=o>()</span>
                <span class=o>.</span><span class=na>url</span><span class=o>(</span><span class=n>ulr</span><span class=o>[</span><span class=n>0</span><span class=o>])</span>
                <span class=o>.</span><span class=na>build</span><span class=o>();</span>

        <span class=k>try</span> <span class=o>{</span>
            <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>newCall</span><span class=o>(</span><span class=n>request</span><span class=o>).</span><span class=na>execute</span><span class=o>();</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>response</span><span class=o>.</span><span class=na>isSuccessful</span><span class=o>())</span>
                <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=na>body</span><span class=o>().</span><span class=na>string</span><span class=o>();</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
            <span class=n>onComplete</span><span class=o>.</span><span class=na>onError</span><span class=o>();</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>onPostExecute</span><span class=o>(</span><span class=n>String</span> <span class=n>result</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>xmlParser</span><span class=o>.</span><span class=na>parseXML</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
                <span class=n>Log</span><span class=o>.</span><span class=na>i</span><span class=o>(</span><span class=s>&#34;RSS Parser &#34;</span><span class=o>,</span> <span class=s>&#34;RSS parsed correctly!&#34;</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
                <span class=n>onComplete</span><span class=o>.</span><span class=na>onError</span><span class=o>();</span>
            <span class=o>}</span>
        <span class=o>}</span> <span class=k>else</span>
            <span class=n>onComplete</span><span class=o>.</span><span class=na>onError</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>update</span><span class=o>(</span><span class=n>Observable</span> <span class=n>observable</span><span class=o>,</span> <span class=n>Object</span> <span class=n>data</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>articles</span> <span class=o>=</span> <span class=o>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Article</span><span class=o>&gt;)</span> <span class=n>data</span><span class=o>;</span>
        <span class=n>onComplete</span><span class=o>.</span><span class=na>onTaskCompleted</span><span class=o>(</span><span class=n>articles</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>Then, the result of the parsing (or an error of parsing) is notified to the “main executor” (the application that uses the library) with two simple callbacks.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=n>Parser</span> <span class=n>parser</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Parser</span><span class=o>();</span>
<span class=n>parser</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>urlString</span><span class=o>);</span>
<span class=n>parser</span><span class=o>.</span><span class=na>onFinish</span><span class=o>(</span><span class=k>new</span> <span class=n>Parser</span><span class=o>.</span><span class=na>OnTaskCompleted</span><span class=o>()</span> <span class=o>{</span>
    <span class=c1>//what to do when the parsing is done
</span><span class=c1></span>    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onTaskCompleted</span><span class=o>(</span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Article</span><span class=o>&gt;</span> <span class=n>list</span><span class=o>)</span> <span class=o>{</span>
        <span class=c1>//list is an Array List with all article&#39;s information
</span><span class=c1></span>        <span class=c1>//set the adapter to recycler view
</span><span class=c1></span>        <span class=n>mAdapter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArticleAdapter</span><span class=o>(</span><span class=n>list</span><span class=o>,</span> <span class=n>R</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>row</span><span class=o>,</span> <span class=n>MainActivity</span><span class=o>.</span><span class=na>this</span><span class=o>);</span>
        <span class=n>mRecyclerView</span><span class=o>.</span><span class=na>setAdapter</span><span class=o>(</span><span class=n>mAdapter</span><span class=o>);</span>
        <span class=n>progressBar</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>GONE</span><span class=o>);</span>
        <span class=n>mSwipeRefreshLayout</span><span class=o>.</span><span class=na>setRefreshing</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=c1>//what to do in case of error
</span><span class=c1></span>    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onError</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>runOnUiThread</span><span class=o>(</span><span class=k>new</span> <span class=n>Runnable</span><span class=o>()</span> <span class=o>{</span>
            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
                <span class=n>progressBar</span><span class=o>.</span><span class=na>setVisibility</span><span class=o>(</span><span class=n>View</span><span class=o>.</span><span class=na>GONE</span><span class=o>);</span>
                <span class=n>mSwipeRefreshLayout</span><span class=o>.</span><span class=na>setRefreshing</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
                <span class=n>Toast</span><span class=o>.</span><span class=na>makeText</span><span class=o>(</span><span class=n>MainActivity</span><span class=o>.</span><span class=na>this</span><span class=o>,</span> <span class=s>&#34;Unable to load data.&#34;</span><span class=o>,</span>
                        <span class=n>Toast</span><span class=o>.</span><span class=na>LENGTH_LONG</span><span class=o>).</span><span class=na>show</span><span class=o>();</span>
                <span class=n>Log</span><span class=o>.</span><span class=na>i</span><span class=o>(</span><span class=s>&#34;Unable to load &#34;</span><span class=o>,</span> <span class=s>&#34;articles&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>});</span>
    <span class=o>}</span>
<span class=o>});</span>
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=kotlin-and-coroutines-a-love-story></a><h3>Kotlin and Coroutines, a love story</h3><p>After 2 years, I wanted to get rid of Async Task, Java and all the ugly stuff. The perfect candidates for taking the place are Kotlin and the coroutines. However, my biggest concern was maintaining the compatibility with all the devs that still use Java (seriously guys? Love yourself, move to Kotlin). In fact, the Kotlin coroutines cannot be invoked from Java code.</p><p>At first, I tried to figure out if there was a method to call the coroutines from Java but finally I came up with a brilliant idea: provide the support for both the ways.</p><p>For the Java support, I decided to use <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html>Future</a> and <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Callable.html>Callable</a> to handle the asynchronous operations. In particular, I implemented two classes that perform respectively the fetching and the parsing task.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>XMLFetcher</span><span class=p>(</span><span class=k>private</span> <span class=k>val</span> <span class=py>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>:</span> <span class=n>Callable</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;</span> <span class=p>{</span>
  <span class=n>@Throws</span><span class=p>(</span><span class=n>Exception</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
  <span class=k>override</span> <span class=k>fun</span> <span class=nf>call</span><span class=p>():</span> <span class=n>String</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>CoreXMLFetcher</span><span class=p>.</span><span class=n>fetchXML</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>class</span> <span class=nc>XMLParser</span><span class=p>(</span><span class=k>var</span> <span class=py>xml</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>:</span> <span class=n>Callable</span><span class=p>&lt;</span><span class=n>MutableList</span><span class=p>&lt;</span><span class=n>Article</span><span class=p>&gt;&gt;</span> <span class=p>{</span>
  <span class=n>@Throws</span><span class=p>(</span><span class=n>Exception</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
  <span class=k>override</span> <span class=k>fun</span> <span class=nf>call</span><span class=p>():</span> <span class=n>MutableList</span><span class=p>&lt;</span><span class=n>Article</span><span class=p>&gt;</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>CoreXMLParser</span><span class=p>.</span><span class=n>parseXML</span><span class=p>(</span><span class=n>xml</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>The result of the parsing is then notified to the “main executor” using the same callbacks reported above.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>fun</span> <span class=nf>execute</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Executors</span><span class=p>.</span><span class=n>newSingleThreadExecutor</span><span class=p>().</span><span class=n>submit</span><span class=p>{</span>
      <span class=k>val</span> <span class=py>service</span> <span class=p>=</span> <span class=n>Executors</span><span class=p>.</span><span class=n>newFixedThreadPool</span><span class=p>(</span><span class=m>2</span><span class=p>)</span>
      <span class=k>val</span> <span class=py>f1</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>submit</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;(</span><span class=n>XMLFetcher</span><span class=p>(</span><span class=n>url</span><span class=p>))</span>
      <span class=k>try</span> <span class=p>{</span>
          <span class=k>val</span> <span class=py>rssFeed</span> <span class=p>=</span> <span class=n>f1</span><span class=p>.</span><span class=k>get</span><span class=p>()</span>
          <span class=k>val</span> <span class=py>f2</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>submit</span><span class=p>(</span><span class=n>XMLParser</span><span class=p>(</span><span class=n>rssFeed</span><span class=p>))</span>
          <span class=n>onComplete</span><span class=p>.</span><span class=n>onTaskCompleted</span><span class=p>(</span><span class=n>f2</span><span class=p>.</span><span class=k>get</span><span class=p>())</span>
      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>onComplete</span><span class=p>.</span><span class=n>onError</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
      <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
          <span class=n>service</span><span class=p>.</span><span class=n>shutdown</span><span class=p>()</span>
      <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>In this way, the old users of the library can still call the same code without noticing any kind of difference but the new ones (and of course also the old) can learn and use the new way.</p><p>As you can image, the new part is written using the Kotlin coroutines. As above, I separated the fetching and the parsing task. The fetching task is performed by the <em>fetchXML</em> suspending function, that takes the URL of the RSS feed as input and returns a <a href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/>Deferred</a> object that will be the input of the <em>parseXML</em> suspend function. This function will then parse the RSS Feed and returns a list of parsed data.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>object</span> <span class=nc>CoroutineEngine</span> <span class=p>{</span>
  <span class=n>@Throws</span><span class=p>(</span><span class=n>Exception</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
  <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>fetchXML</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>=</span>
          <span class=n>withContext</span><span class=p>(</span><span class=n>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
              <span class=k>return</span><span class=n>@withContext</span> <span class=n>CoreXMLFetcher</span><span class=p>.</span><span class=n>fetchXML</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
          <span class=p>}</span>

  <span class=n>@Throws</span><span class=p>(</span><span class=n>Exception</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
  <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>parseXML</span><span class=p>(</span><span class=n>xml</span><span class=p>:</span> <span class=n>Deferred</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;)</span> <span class=p>=</span>
          <span class=n>withContext</span><span class=p>(</span><span class=n>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
              <span class=k>return</span><span class=n>@withContext</span> <span class=n>CoreXMLParser</span><span class=p>.</span><span class=n>parseXML</span><span class=p>(</span><span class=n>xml</span><span class=p>.</span><span class=n>await</span><span class=p>())</span>
          <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>These functions are exposed to the “main executor” by using another suspend function, that it will get and parse asynchronously the RSS feed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>@Throws</span><span class=p>(</span><span class=n>Exception</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
<span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getArticles</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>=</span>
      <span class=n>withContext</span><span class=p>(</span><span class=n>Dispatchers</span><span class=p>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>val</span> <span class=py>xml</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>CoroutineEngine</span><span class=p>.</span><span class=n>fetchXML</span><span class=p>(</span><span class=n>url</span><span class=p>)</span> <span class=p>}</span>
          <span class=k>return</span><span class=n>@withContext</span> <span class=n>CoroutineEngine</span><span class=p>.</span><span class=n>parseXML</span><span class=p>(</span><span class=n>xml</span><span class=p>)</span>
      <span class=p>}</span>
</code></pre></td></tr></table></div></div><p>All the suspend functions reported above are called with the IO Dispatcher that uses a shared pool of on-demand created threads. There are also other dispatchers, give a look to the <a href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/>documentation</a> to find the one that better suits your needs.</p><p>And finally, from the ViewModel (or in whatever place depending on the architecture of your app) you can launch the coroutine with a <a href=https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/>Scope</a>, so, for example, you can stop it if the activity is destroyed, and then “transform” an URL to a List of Articles.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=n>coroutineScope</span><span class=p>.</span><span class=n>launch</span><span class=p>(</span><span class=n>Dispatchers</span><span class=p>.</span><span class=n>Main</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
      <span class=k>val</span> <span class=py>parser</span> <span class=p>=</span> <span class=n>Parser</span><span class=p>()</span>
      <span class=k>val</span> <span class=py>articleList</span> <span class=p>=</span> <span class=n>parser</span><span class=p>.</span><span class=n>getArticles</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
      <span class=n>setArticleList</span><span class=p>(</span><span class=n>articleList</span><span class=p>)</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>e</span><span class=p>.</span><span class=n>printStackTrace</span><span class=p>()</span>
      <span class=n>_snackbar</span><span class=p>.</span><span class=n>value</span> <span class=p>=</span> <span class=s>&#34;An error has occurred. Please retry&#34;</span>
      <span class=n>setArticleList</span><span class=p>(</span><span class=n>mutableListOf</span><span class=p>())</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>And finally, we have reached the end of my journey from Async Task to Coroutines. If you have some advice, doubt or any kind of feedback, please leave a comment! Of course, you can use this example as an idea to leave forever the (ugly) Async Tasks.</p><p>If you want to contribute to the development of the library or simply report a bug, visit the repo on Github: <a href=https://github.com/prof18/RSS-Parser>https://github.com/prof18/RSS-Parser</a></p><p>A special thanks to the (awesome) devs of the Android Developers Italia Community that gave to me some advice. If you are Italian, join us on <a href=https://androiddevs.it/>Slack</a>!</p></div><section style=width:90%;margin-left:auto;margin-right:auto;margin-top:30px;margin-bottom:30px><hr><div style=padding:25px><div>Keep up to date with my writings and my projects by subscribing to my newsletter. I mostly write about mobile development, with a focus on Kotlin Multiplatform and declarative patterns. And don't worry, I will not DDoS your inbox. I'll only write when something new & interesting comes up:</div><form style=padding-bottom:20px action=https://tinyletter.com/marcogomiero method=post target=popupwindow onsubmit="window.open('https://tinyletter.com/marcogomiero','popupwindow','scrollbars=yes,width=800,height=600');return true;"><p><input type=email style="width:80%;border:1px solid #e0e0e0;border-radius:2px;color:#5c5e60;background-color:#fff;height:57px;padding-left:15px" name=email id=tlemail placeholder="Your email address"></p><input type=hidden value=1 name=embed>
<input type=submit value=Subscribe class=button></form></div><hr></section><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fwww.marcogomiero.com%2fposts%2f2019%2fasynctask-to-coroutines%2f&text=A%20journey%20from%20Async%20Task%20to%20Kotlin%20Coroutines&via=marcoGomier" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fwww.marcogomiero.com%2fposts%2f2019%2fasynctask-to-coroutines%2f&title=A%20journey%20from%20Async%20Task%20to%20Kotlin%20Coroutines" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fwww.marcogomiero.com%2fposts%2f2019%2fasynctask-to-coroutines%2f&title=A%20journey%20from%20Async%20Task%20to%20Kotlin%20Coroutines" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://www.marcogomiero.com/tags/android/><i class="fas fa-tag fa-fw"></i>Android</a></span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://www.marcogomiero.com>Home</a></span></section></div><div class=post-nav><a href=https://www.marcogomiero.com/posts/2018/bye-async-task/ class=prev rel=prev title="RSS Parser 2.0: bye bye Async Task, welcome Coroutines"><i class="fas fa-angle-left fa-fw"></i>RSS Parser 2.0: bye bye Async Task, welcome Coroutines</a>
<a href=https://www.marcogomiero.com/posts/2019/bottom-bar-swipe-flutter/ class=next rel=next title="Bottom App Bar with Menu and Swipeable Tabs in Flutter">Bottom App Bar with Menu and Swipeable Tabs in Flutter<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="marcogomiero";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://www.marcogomiero.com>Marco Gomiero</a></span></div><br></div></footer><script src=/js/lib/jquery/jquery.slim.min.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-90975904-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a></body></html>